openapi: 3.0.3
info:
  title: GEO Hub API
  version: 0.1
  description: |
    OpenAPI spec for GEO Hub (MVP v0.1). Derived from docs/ru/04-api-reference.md.
servers:
  - url: /api/v1
tags:
  - name: Auth
  - name: Participants
  - name: TrustLines
  - name: Payments
  - name: Balance
  - name: Clearing
  - name: Equivalents
  - name: Health
  - name: Admin
  - name: Simulator
security:
  - BearerAuth: []

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ok]

  /healthz:
    get:
      tags: [Health]
      summary: Health check (alias)
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ok]

  /health/db:
    get:
      tags: [Health]
      summary: Database health check
      security: []
      responses:
        '200':
          description: DB OK
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ok]
        '503':
          description: DB unavailable
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [error]
                  details:
                    type: string

  /admin/config:
    get:
      tags: [Admin]
      summary: Get runtime config (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Config items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminConfigResponse'
        '403':
          $ref: '#/components/responses/Unauthorized'
    patch:
      tags: [Admin]
      summary: Patch runtime config subset (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminConfigPatchRequest'
      responses:
        '200':
          description: Updated keys
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminConfigPatchResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /admin/whoami:
    get:
      tags: [Admin]
      summary: Who am I (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Current admin role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminWhoAmIResponse'
        '403':
          $ref: '#/components/responses/Unauthorized'

  /admin/feature-flags:
    get:
      tags: [Admin]
      summary: Get feature flags (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Flags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminFeatureFlags'
    patch:
      tags: [Admin]
      summary: Patch feature flags (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminFeatureFlagsPatchRequest'
      responses:
        '200':
          description: Flags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminFeatureFlags'

  /admin/participants:
    get:
      tags: [Admin]
      summary: List participants (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Participants list
          content:
            application/json:
              schema:
                type: object
                required: [items]
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      additionalProperties: true

  /admin/participants/stats:
    get:
      tags: [Admin]
      summary: Participants stats (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Participants stats
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /admin/participants/{pid}/freeze:
    post:
      tags: [Admin]
      summary: Freeze participant (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/PidPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminParticipantActionRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/participants/{pid}/unfreeze:
    post:
      tags: [Admin]
      summary: Unfreeze participant (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/PidPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminParticipantActionRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/participants/{pid}/ban:
    post:
      tags: [Admin]
      summary: Ban participant (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/PidPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminParticipantActionRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/participants/{pid}/unban:
    post:
      tags: [Admin]
      summary: Unban participant (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/PidPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminParticipantActionRequest'
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/audit-log:
    get:
      tags: [Admin]
      summary: List audit log (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: action
          schema:
            type: string
        - in: query
          name: object_type
          schema:
            type: string
        - in: query
          name: object_id
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
      responses:
        '200':
          description: Audit log items
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /admin/equivalents:
    get:
      tags: [Admin]
      summary: List equivalents (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: include_inactive
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Equivalents list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EquivalentsList'
    post:
      tags: [Admin]
      summary: Create equivalent (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminEquivalentCreateRequest'
      responses:
        '200':
          description: Equivalent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Equivalent'

  /admin/equivalents/{code}:
    patch:
      tags: [Admin]
      summary: Patch equivalent (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: path
          name: code
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminEquivalentUpdateRequest'
      responses:
        '200':
          description: Equivalent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Equivalent'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [Admin]
      summary: Delete equivalent (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: path
          name: code
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      responses:
        '200':
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/equivalents/{code}/usage:
    get:
      tags: [Admin]
      summary: Equivalent usage (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: path
          name: code
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      responses:
        '200':
          description: Usage summary
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/migrations:
    get:
      tags: [Admin]
      summary: Migrations status (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Migration status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminMigrationsStatus'

  /admin/trustlines:
    get:
      tags: [Admin]
      summary: List trustlines (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: equivalent
          required: false
          schema:
            type: string
          description: Equivalent code filter
        - in: query
          name: creditor
          required: false
          schema:
            type: string
          description: Creditor PID (trustline 'from')
        - in: query
          name: debtor
          required: false
          schema:
            type: string
          description: Debtor PID (trustline 'to')
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [active, frozen, closed]
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Trustlines list
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '403':
          $ref: '#/components/responses/Unauthorized'

  /admin/trustlines/bottlenecks:
    get:
      tags: [Admin]
      summary: Trustlines bottlenecks (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: threshold
          required: false
          schema:
            type: number
            minimum: 0
            maximum: 1
            default: 0.10
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
        - in: query
          name: equivalent
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Bottlenecks list
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /admin/liquidity/summary:
    get:
      tags: [Admin]
      summary: Liquidity summary (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: equivalent
          required: false
          schema:
            type: string
        - in: query
          name: threshold
          required: false
          schema:
            type: number
            minimum: 0
            maximum: 1
            default: 0.10
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: Liquidity summary
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /admin/incidents:
    get:
      tags: [Admin]
      summary: List incidents (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Incidents list
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '403':
          $ref: '#/components/responses/Unauthorized'

  /admin/transactions/{tx_id}/abort:
    post:
      tags: [Admin]
      summary: Abort transaction (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: path
          name: tx_id
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
      responses:
        '200':
          description: Aborted
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/graph/snapshot:
    get:
      tags: [Admin]
      summary: Graph snapshot (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: include
          required: false
          schema:
            type: string
          description: Comma-separated extras to include (incidents,audit_log,transactions)
      responses:
        '200':
          description: Graph snapshot
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /admin/graph/ego:
    get:
      tags: [Admin]
      summary: Ego graph snapshot (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: pid
          required: true
          schema:
            type: string
        - in: query
          name: depth
          required: false
          schema:
            type: integer
            enum: [1, 2]
            default: 1
        - in: query
          name: equivalent
          required: false
          schema:
            type: string
        - in: query
          name: status
          required: false
          schema:
            type: array
            items:
              type: string
          style: form
          explode: true
        - in: query
          name: include
          required: false
          schema:
            type: string
          description: Comma-separated extras to include (incidents,audit_log,transactions)
      responses:
        '200':
          description: Ego snapshot
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /simulator/graph/snapshot:
    get:
      tags: [Simulator]
      summary: Graph snapshot (simulator)
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      responses:
        '200':
          description: Graph snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulatorGraphSnapshot'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /simulator/graph/ego:
    get:
      tags: [Simulator]
      summary: Ego graph snapshot (simulator)
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
        - in: query
          name: pid
          required: true
          schema:
            type: string
        - in: query
          name: depth
          required: false
          schema:
            type: integer
            enum: [1, 2]
            default: 1
      responses:
        '200':
          description: Ego snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulatorGraphSnapshot'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /simulator/events:
    get:
      tags: [Simulator]
      summary: Events stream (SSE)
      description: |
        Server-Sent Events stream. Each message contains one JSON event.

        This endpoint is modeled as `text/event-stream` in OpenAPI.
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorized'

  /simulator/events/poll:
    get:
      tags: [Simulator]
      summary: Events poll (fallback)
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
        - in: query
          name: after
          required: false
          schema:
            type: string
          description: Return events strictly after this event_id
      responses:
        '200':
          description: Array of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SimulatorEvent'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /simulator/scenarios:
    get:
      tags: [Simulator]
      summary: List simulator scenarios (Real Mode control plane)
      responses:
        '200':
          description: Scenarios list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenariosListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [Simulator]
      summary: Upload a simulator scenario (Real Mode control plane)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenarioUploadRequest'
      responses:
        '200':
          description: Scenario summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /simulator/scenarios/{scenario_id}:
    get:
      tags: [Simulator]
      summary: Get simulator scenario summary (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/ScenarioIdPath'
      responses:
        '200':
          description: Scenario summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScenarioSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs:
    post:
      tags: [Simulator]
      summary: Start a simulator run (Real Mode control plane)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunCreateRequest'
      responses:
        '200':
          description: Run created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /simulator/runs/{run_id}:
    get:
      tags: [Simulator]
      summary: Get simulator run status (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/pause:
    post:
      tags: [Simulator]
      summary: Pause simulator run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/resume:
    post:
      tags: [Simulator]
      summary: Resume simulator run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/stop:
    post:
      tags: [Simulator]
      summary: Stop simulator run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/restart:
    post:
      tags: [Simulator]
      summary: Restart simulator run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/intensity:
    post:
      tags: [Simulator]
      summary: Set simulator run intensity (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetIntensityRequest'
      responses:
        '200':
          description: Run status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/events:
    get:
      tags: [Simulator]
      summary: Run events stream (SSE) (Real Mode control plane)
      description: |
        Server-Sent Events stream. Each message contains one JSON event.

        This endpoint is modeled as `text/event-stream` in OpenAPI.
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
        - $ref: '#/components/parameters/EquivalentQuery'
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/graph/snapshot:
    get:
      tags: [Simulator]
      summary: Graph snapshot for a run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
        - $ref: '#/components/parameters/EquivalentQuery'
      responses:
        '200':
          description: Graph snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulatorGraphSnapshot'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/metrics:
    get:
      tags: [Simulator]
      summary: Metrics time-series for a run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
        - $ref: '#/components/parameters/EquivalentQuery'
        - in: query
          name: from_ms
          required: true
          schema:
            type: integer
            minimum: 0
        - in: query
          name: to_ms
          required: true
          schema:
            type: integer
            minimum: 0
        - in: query
          name: step_ms
          required: true
          schema:
            type: integer
            minimum: 1
      responses:
        '200':
          description: Metrics time-series
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/bottlenecks:
    get:
      tags: [Simulator]
      summary: Bottlenecks for a run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
        - $ref: '#/components/parameters/EquivalentQuery'
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
        - in: query
          name: min_score
          required: false
          schema:
            type: number
            minimum: 0
            maximum: 1
      responses:
        '200':
          description: Bottlenecks list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BottlenecksResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/artifacts:
    get:
      tags: [Simulator]
      summary: Artifacts index for a run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: Artifacts index
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArtifactIndex'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /simulator/runs/{run_id}/artifacts/{name}:
    get:
      tags: [Simulator]
      summary: Download a specific artifact for a run (Real Mode control plane)
      parameters:
        - $ref: '#/components/parameters/RunIdPath'
        - $ref: '#/components/parameters/ArtifactNamePath'
      responses:
        '200':
          description: Artifact content
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/clearing/cycles:
    get:
      tags: [Admin]
      summary: Find clearing cycles (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - in: query
          name: participant_pid
          required: false
          schema:
            type: string
        - in: query
          name: equivalent
          required: false
          schema:
            type: string
        - in: query
          name: max_depth
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 10
            default: 6
      responses:
        '200':
          description: Clearing cycles
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /admin/participants/{pid}/metrics:
    get:
      tags: [Admin]
      summary: Participant analytics/metrics (admin)
      security: []
      parameters:
        - in: header
          name: X-Admin-Token
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/PidPath'
        - in: query
          name: equivalent
          required: false
          schema:
            type: string
        - in: query
          name: threshold
          required: false
          schema:
            type: number
            minimum: 0
            maximum: 1
      responses:
        '200':
          description: Metrics
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /equivalents:
    get:
      tags: [Equivalents]
      summary: List active equivalents
      responses:
        '200':
          description: Equivalents list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EquivalentsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/challenge:
    post:
      tags: [Auth]
      summary: Start challenge-response auth flow
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChallengeRequest'
      responses:
        '200':
          description: Challenge created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChallengeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/login:
    post:
      tags: [Auth]
      summary: Complete challenge-response and issue JWT tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Exchange refresh token for a new token pair
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /participants:
    get:
      tags: [Participants]
      summary: Search participants
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Search query
        - in: query
          name: type
          schema:
            type: string
            enum: [person, business, hub]
          description: Type filter
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
          description: Max results
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
          description: Page number (optional; used with per_page)
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
          description: Items per page (optional; used with page)
      responses:
        '200':
          description: Participants list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParticipantsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Participants]
      summary: Register participant
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParticipantCreateRequest'
      responses:
        '201':
          description: Participant created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '400':
          $ref: '#/components/responses/BadRequest'

  /participants/search:
    get:
      tags: [Participants]
      summary: Search participants (alias)
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Search query
        - in: query
          name: type
          schema:
            type: string
            enum: [person, business, hub]
          description: Type filter
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
          description: Max results
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
          description: Page number (optional; used with per_page)
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
          description: Items per page (optional; used with page)
      responses:
        '200':
          description: Participants list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParticipantsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /participants/me:
    get:
      tags: [Participants]
      summary: Get current participant profile with stats
      responses:
        '200':
          description: Current participant with stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParticipantWithStats'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      tags: [Participants]
      summary: Update current participant profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParticipantUpdateRequest'
      responses:
        '200':
          description: Updated participant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /participants/{pid}:
    get:
      tags: [Participants]
      summary: Get participant
      parameters:
        - $ref: '#/components/parameters/PidPath'
      responses:
        '200':
          description: Participant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /trustlines:
    get:
      tags: [TrustLines]
      summary: List trustlines
      parameters:
        - in: query
          name: direction
          schema:
            type: string
            enum: [outgoing, incoming, all]
            default: all
        - in: query
          name: equivalent
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [active, frozen, closed]
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Trustlines list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLinesList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [TrustLines]
      summary: Create trustline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrustLineCreateRequest'
      responses:
        '201':
          description: Trustline created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLine'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /trustlines/{id}:
    get:
      tags: [TrustLines]
      summary: Get trustline
      parameters:
        - $ref: '#/components/parameters/TrustLineIdPath'
      responses:
        '200':
          description: Trustline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLine'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [TrustLines]
      summary: Update trustline
      parameters:
        - $ref: '#/components/parameters/TrustLineIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrustLineUpdateRequest'
      responses:
        '200':
          description: Trustline updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLine'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [TrustLines]
      summary: Close trustline
      parameters:
        - $ref: '#/components/parameters/TrustLineIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrustLineCloseRequest'
      responses:
        '200':
          description: Closed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /clearing/cycles:
    get:
      tags: [Clearing]
      summary: List debt cycles for an equivalent
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: max_depth
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 10
            default: 6
      responses:
        '200':
          description: Cycles
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearingCyclesResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /clearing/auto:
    post:
      tags: [Clearing]
      summary: Auto-clear cycles for an equivalent
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Clearing result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearingAutoResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /payments/capacity:
    get:
      tags: [Payments]
      summary: Check capacity for a concrete payment amount
      parameters:
        - in: query
          name: to
          required: true
          schema:
            type: string
          description: Recipient PID
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: amount
          required: true
          schema:
            type: string
            pattern: '^[0-9]+(\.[0-9]+)?$'
          description: Amount as decimal string
      responses:
        '200':
          description: Capacity result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapacityResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /payments/max-flow:
    get:
      tags: [Payments]
      summary: Estimate maximum transferable amount and diagnostics
      parameters:
        - in: query
          name: to
          required: true
          schema:
            type: string
          description: Recipient PID
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Max-flow result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaxFlowResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /payments:
    post:
      tags: [Payments]
      summary: Create payment
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
            maxLength: 128
          description: Optional idempotency key. Re-using the same key returns the same result; re-using with a different request returns 409.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCreateRequest'
      responses:
        '200':
          description: Payment created (committed or aborted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResult'
        '409':
          $ref: '#/components/responses/Conflict'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

    get:
      tags: [Payments]
      summary: List payments
      parameters:
        - in: query
          name: direction
          schema:
            type: string
            enum: [sent, received, all]
            default: all
        - in: query
          name: equivalent
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [COMMITTED, ABORTED, all]
            default: all
          description: Final payment outcome filter. This API exposes only final statuses (`COMMITTED` or `ABORTED`).
        - in: query
          name: from_date
          schema:
            type: string
            format: date-time
        - in: query
          name: to_date
          schema:
            type: string
            format: date-time
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Payments list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /payments/{tx_id}:
    get:
      tags: [Payments]
      summary: Get payment by tx_id
      parameters:
        - in: path
          name: tx_id
          required: true
          schema:
            type: string
          description: Transaction id
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /balance:
    get:
      tags: [Balance]
      summary: Get aggregated balance by equivalents
      responses:
        '200':
          description: Balance summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /balance/debts:
    get:
      tags: [Balance]
      summary: Get debts details
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: direction
          schema:
            type: string
            enum: [outgoing, incoming, all]
            default: all
      responses:
        '200':
          description: Debts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebtsDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrity/status:
    get:
      tags: [Integrity]
      summary: Get integrity status
      responses:
        '200':
          description: Current integrity status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityStatusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrity/checksum/{equivalent}:
    get:
      tags: [Integrity]
      summary: Get latest integrity checksum for equivalent
      parameters:
        - in: path
          name: equivalent
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      responses:
        '200':
          description: Latest integrity checkpoint checksum
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityChecksumResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /integrity/verify:
    post:
      tags: [Integrity]
      summary: Run invariant verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntegrityVerifyRequest'
      responses:
        '200':
          description: Verification results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityVerifyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /integrity/repair/net-mutual-debts:
    post:
      tags: [Integrity]
      summary: Repair net mutual debts
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Repair result
          content:
            application/json:
              schema:
                type: object
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrity/repair/cap-debts-to-trust-limits:
    post:
      tags: [Integrity]
      summary: Repair cap debts to trust limits
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Repair result
          content:
            application/json:
              schema:
                type: object
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrity/audit-log:
    get:
      tags: [Integrity]
      summary: List integrity verification audit log entries
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Audit log items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityAuditLogResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    PidPath:
      in: path
      name: pid
      required: true
      schema:
        type: string
    TrustLineIdPath:
      in: path
      name: id
      required: true
      schema:
        type: string
        format: uuid
        description: TrustLine UUID

    ScenarioIdPath:
      in: path
      name: scenario_id
      required: true
      schema:
        type: string

    RunIdPath:
      in: path
      name: run_id
      required: true
      schema:
        type: string

    ArtifactNamePath:
      in: path
      name: name
      required: true
      schema:
        type: string

    EquivalentQuery:
      in: query
      name: equivalent
      required: true
      schema:
        $ref: '#/components/schemas/EquivalentCode'

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'

  schemas:
    Equivalent:
      type: object
      required: [code, precision, is_active, created_at, updated_at]
      properties:
        code:
          $ref: '#/components/schemas/EquivalentCode'
        symbol:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        precision:
          type: integer
          minimum: 0
          maximum: 18
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    EquivalentsList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Equivalent'

    EquivalentCode:
      type: string
      pattern: '^[A-Z0-9_]{1,16}$'
      description: Equivalent code (1-16 chars; A-Z, 0-9, underscore)
    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true

    AdminConfigItem:
      type: object
      required: [key, value, mutable]
      properties:
        key:
          type: string
        value:
          description: Any JSON value
        mutable:
          type: boolean

    AdminConfigResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminConfigItem'

    AdminConfigPatchRequest:
      type: object
      required: [updates]
      properties:
        updates:
          type: object
          additionalProperties: true
        reason:
          type: string
          nullable: true

    AdminConfigPatchResponse:
      type: object
      required: [updated]
      properties:
        updated:
          type: array
          items:
            type: string

    AdminFeatureFlags:
      type: object
      required: [multipath_enabled, full_multipath_enabled, clearing_enabled]
      properties:
        multipath_enabled:
          type: boolean
        full_multipath_enabled:
          type: boolean
        clearing_enabled:
          type: boolean

    AdminFeatureFlagsPatchRequest:
      type: object
      description: Partial patch; only provided fields are updated.
      properties:
        multipath_enabled:
          type: boolean
          nullable: true
        full_multipath_enabled:
          type: boolean
          nullable: true
        clearing_enabled:
          type: boolean
          nullable: true
        reason:
          type: string
          nullable: true

    AdminWhoAmIResponse:
      type: object
      required: [role]
      properties:
        role:
          type: string
          enum: [admin]

    AdminParticipantActionRequest:
      type: object
      required: [reason]
      properties:
        reason:
          type: string

    AdminAuditLogItem:
      type: object
      required: [id, timestamp, action]
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        actor_id:
          type: string
          nullable: true
        actor_role:
          type: string
          nullable: true
        action:
          type: string
        object_type:
          type: string
          nullable: true
        object_id:
          type: string
          nullable: true
        reason:
          type: string
          nullable: true
        before_state:
          type: object
          nullable: true
          additionalProperties: true
        after_state:
          type: object
          nullable: true
          additionalProperties: true
        request_id:
          type: string
          nullable: true
        ip_address:
          type: string
          nullable: true
        user_agent:
          type: string
          nullable: true

    AdminAuditLogResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdminAuditLogItem'

    AdminMigrationsStatus:
      type: object
      required: [is_up_to_date]
      properties:
        current_revision:
          type: string
          nullable: true
        head_revision:
          type: string
          nullable: true
        is_up_to_date:
          type: boolean

    AdminEquivalentCreateRequest:
      type: object
      required: [code]
      properties:
        code:
          $ref: '#/components/schemas/EquivalentCode'
        symbol:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        precision:
          type: integer
          default: 2
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        is_active:
          type: boolean
          default: true
        reason:
          type: string
          nullable: true

    AdminEquivalentUpdateRequest:
      type: object
      properties:
        symbol:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        precision:
          type: integer
          nullable: true
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        is_active:
          type: boolean
          nullable: true
        reason:
          type: string
          nullable: true

    SignedRequest:
      type: object
      properties:
        signature:
          type: string
          description: base64 signature

    ChallengeRequest:
      type: object
      required: [pid]
      properties:
        pid:
          type: string

    ChallengeResponse:
      type: object
      required: [challenge, expires_at]
      properties:
        challenge:
          type: string
        expires_at:
          type: string
          format: date-time

    LoginRequest:
      type: object
      required: [pid, challenge, signature]
      properties:
        pid:
          type: string
        challenge:
          type: string
        signature:
          type: string
        device_info:
          $ref: '#/components/schemas/DeviceInfo'

    DeviceInfo:
      type: object
      properties:
        platform:
          type: string
          nullable: true
        app_version:
          type: string
          nullable: true

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    TokenPair:
      type: object
      required: [access_token, refresh_token, expires_in, participant]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          description: Access token TTL in seconds
          example: 3600
        participant:
          $ref: '#/components/schemas/ParticipantPublic'
        token_type:
          type: string
          example: Bearer

    ParticipantPublic:
      type: object
      required: [pid, display_name, status]
      properties:
        pid:
          type: string
        display_name:
          type: string
        status:
          type: string
          enum: [active, suspended, left, deleted]

    Participant:
      type: object
      required: [pid, status]
      properties:
        pid:
          type: string
          description: Participant identifier (derived from public_key)
        display_name:
          type: string
        type:
          type: string
          enum: [person, business, hub]
        status:
          type: string
          enum: [active, suspended, left, deleted]
          description: |
            Participant status:
            - active: normal operation
            - suspended: temporarily frozen by admin (can be unfrozen)
            - left: participant voluntarily left the community
            - deleted: participant removed from system
        verification_level:
          type: integer
          minimum: 0
          maximum: 3
          description: Verification level (0=unverified, 3=fully verified)
        public_key:
          type: string
          description: Ed25519 public key (base64)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        profile:
          $ref: '#/components/schemas/ParticipantProfile'
        public_stats:
          $ref: '#/components/schemas/ParticipantPublicStats'

    ParticipantProfile:
      type: object
      additionalProperties: true
      properties:
        type:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        contacts:
          type: object
          nullable: true
          additionalProperties: true

    ParticipantPublicStats:
      type: object
      required: [total_incoming_trust, member_since]
      properties:
        total_incoming_trust:
          type: string
        member_since:
          type: string
          format: date-time

    ParticipantCreateRequest:
      type: object
      required: [display_name, public_key, signature]
      properties:
        display_name:
          type: string
        type:
          type: string
          enum: [person, business, hub]
          default: person
        public_key:
          type: string
        profile:
          $ref: '#/components/schemas/ParticipantProfile'
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `display_name`, `type`, `public_key`, and optional `profile` if provided.

    ParticipantsList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Participant'

    ParticipantStats:
      type: object
      required: [total_incoming_trust, total_outgoing_trust, total_debt, total_credit, net_balance]
      properties:
        total_incoming_trust:
          type: string
        total_outgoing_trust:
          type: string
        total_debt:
          type: string
        total_credit:
          type: string
        net_balance:
          type: string

    ParticipantWithStats:
      allOf:
        - $ref: '#/components/schemas/Participant'
        - type: object
          required: [stats]
          properties:
            stats:
              $ref: '#/components/schemas/ParticipantStats'

    ParticipantUpdateRequest:
      type: object
      required: [signature]
      properties:
        display_name:
          type: string
          nullable: true
        profile:
          $ref: '#/components/schemas/ParticipantProfile'
        signature:
          type: string

    TrustLine:
      type: object
      required: [id, from, to, equivalent, limit, used]
      properties:
        id:
          type: string
          format: uuid
          description: TrustLine UUID
        from:
          type: string
          description: PID of trustline creator (creditor)
        to:
          type: string
          description: PID of trustee (potential debtor)
        from_display_name:
          type: string
          nullable: true
        to_display_name:
          type: string
          nullable: true
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        limit:
          type: string
          description: Maximum debt allowed (decimal string)
        used:
          type: string
          description: Current debt against this line (decimal string)
        available:
          type: string
          description: Available credit (limit - used)
        policy:
          type: object
          additionalProperties: true
          description: |
            TrustLine policy settings.

            Allowed keys (MVP): `auto_clearing`, `can_be_intermediate`, `max_hop_usage`, `daily_limit`, `blocked_participants`.

            Note: `daily_limit` is **informational only** and is **not enforced in MVP**.
        status:
          type: string
          enum: [active, frozen, closed]
          description: TrustLine status
        created_at:
          type: string
          format: date-time

    TrustLinesList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TrustLine'

    TrustLineCreateRequest:
      type: object
      required: [to, equivalent, limit, signature]
      properties:
        to:
          type: string
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        limit:
          type: string
        policy:
          type: object
          additionalProperties: true
          description: |
            Optional TrustLine policy.

            Allowed keys (MVP): `auto_clearing`, `can_be_intermediate`, `max_hop_usage`, `daily_limit`, `blocked_participants`.

            Note: `daily_limit` is **informational only** and is **not enforced in MVP**.
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `to`, `equivalent`, `limit`, and optional `policy` if provided.

    TrustLineUpdateRequest:
      type: object
      required: [signature]
      properties:
        limit:
          type: string
        policy:
          type: object
          additionalProperties: true
          description: |
            Optional TrustLine policy update.

            Allowed keys (MVP): `auto_clearing`, `can_be_intermediate`, `max_hop_usage`, `daily_limit`, `blocked_participants`.

            Note: `daily_limit` is **informational only** and is **not enforced in MVP**.
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `id` (path param), optional `limit` if provided, optional `policy` if provided.

    TrustLineCloseRequest:
      type: object
      required: [signature]
      properties:
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON payload **excluding** `signature`.
            Signed payload keys: `id` (path param).

    ClearingCycleEdge:
      type: object
      required: [debt_id, debtor, creditor, amount]
      properties:
        debt_id:
          type: string
        debtor:
          type: string
        creditor:
          type: string
        amount:
          type: string

    ClearingCyclesResponse:
      type: object
      required: [cycles]
      properties:
        cycles:
          type: array
          items:
            type: array
            items:
              $ref: '#/components/schemas/ClearingCycleEdge'

    ClearingAutoResponse:
      type: object
      required: [equivalent, cleared_cycles]
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        cleared_cycles:
          type: integer

    CapacityResponse:
      type: object
      required: [can_pay, max_amount, routes_count, estimated_hops]
      properties:
        can_pay:
          type: boolean
        max_amount:
          type: string
        routes_count:
          type: integer
        estimated_hops:
          type: integer

    MaxFlowPath:
      type: object
      required: [path, capacity]
      properties:
        path:
          type: array
          items:
            type: string
        capacity:
          type: string

    Bottleneck:
      type: object
      required: [from, to, limit, used, available]
      properties:
        from:
          type: string
        to:
          type: string
        limit:
          type: string
        used:
          type: string
        available:
          type: string

    MaxFlowResponse:
      type: object
      required: [max_amount, paths, bottlenecks, algorithm, computed_at]
      properties:
        max_amount:
          type: string
        paths:
          type: array
          items:
            $ref: '#/components/schemas/MaxFlowPath'
        bottlenecks:
          type: array
          items:
            $ref: '#/components/schemas/Bottleneck'
        algorithm:
          type: string
        computed_at:
          type: string
          format: date-time

    PaymentCreateRequest:
      type: object
      required: [to, equivalent, amount, signature]
      properties:
        to:
          type: string
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        amount:
          type: string
        description:
          type: string
        constraints:
          $ref: '#/components/schemas/PaymentConstraints'
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `to`, `equivalent`, `amount`, optional `description`, optional `constraints`.

    PaymentConstraints:
      type: object
      additionalProperties: false
      properties:
        max_hops:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
        max_paths:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
        timeout_ms:
          type: integer
          minimum: 1
          maximum: 120000
          nullable: true
        avoid:
          type: array
          items:
            type: string
          nullable: true

    PaymentRoute:
      type: object
      required: [path, amount]
      properties:
        path:
          type: array
          items:
            type: string
        amount:
          type: string

    PaymentError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    PaymentResult:
      type: object
      required: [tx_id, status, from, to, equivalent, amount, created_at]
      properties:
        tx_id:
          type: string
        status:
          type: string
          enum: [COMMITTED, ABORTED]
          description: Final payment outcome. Internal transaction states are not exposed via the Payments API.
        from:
          type: string
        to:
          type: string
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        amount:
          type: string
        routes:
          type: array
          items:
            $ref: '#/components/schemas/PaymentRoute'
        error:
          $ref: '#/components/schemas/PaymentError'
        created_at:
          type: string
          format: date-time
        committed_at:
          type: string
          format: date-time

    PaymentsList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PaymentResult'

    BalanceEquivalent:
      type: object
      required: [code, total_debt, total_credit, net_balance, available_to_spend, available_to_receive]
      properties:
        code:
          $ref: '#/components/schemas/EquivalentCode'
        total_debt:
          type: string
        total_credit:
          type: string
        net_balance:
          type: string
        available_to_spend:
          type: string
        available_to_receive:
          type: string

    BalanceSummary:
      type: object
      required: [equivalents]
      properties:
        equivalents:
          type: array
          items:
            $ref: '#/components/schemas/BalanceEquivalent'

    DebtsDetails:
      type: object
      required: [outgoing, incoming]
      properties:
        outgoing:
          type: array
          items:
            type: object
            required: [creditor, equivalent, amount]
            properties:
              creditor:
                type: string
              creditor_name:
                type: string
              equivalent:
                $ref: '#/components/schemas/EquivalentCode'
              amount:
                type: string
        incoming:
          type: array
          items:
            type: object
            required: [debtor, equivalent, amount]
            properties:
              debtor:
                type: string
              debtor_name:
                type: string
              equivalent:
                $ref: '#/components/schemas/EquivalentCode'
              amount:
                type: string

    InvariantResult:
      type: object
      required: [passed]
      properties:
        passed:
          type: boolean
        value:
          type: string
          nullable: true
        violations:
          type: integer
          nullable: true
        details:
          type: object
          nullable: true
          additionalProperties: true

    EquivalentIntegrityStatus:
      type: object
      required: [status, checksum, invariants]
      properties:
        status:
          type: string
          enum: [healthy, warning, critical]
        checksum:
          type: string
        last_verified:
          type: string
          format: date-time
          nullable: true
        invariants:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/InvariantResult'

    IntegrityStatusResponse:
      type: object
      required: [status, last_check, equivalents, alerts]
      properties:
        status:
          type: string
          enum: [healthy, warning, critical]
        last_check:
          type: string
          format: date-time
        equivalents:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/EquivalentIntegrityStatus'
        alerts:
          type: array
          items:
            type: string

    IntegrityChecksumResponse:
      type: object
      required: [equivalent, checksum, created_at, invariants_status]
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        checksum:
          type: string
        created_at:
          type: string
          format: date-time
        invariants_status:
          type: object
          additionalProperties: true

    IntegrityVerifyRequest:
      type: object
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
      additionalProperties: false

    IntegrityVerifyResponse:
      type: object
      required: [status, checked_at, equivalents, alerts]
      properties:
        status:
          type: string
          enum: [healthy, warning, critical]
        checked_at:
          type: string
          format: date-time
        equivalents:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/EquivalentIntegrityStatus'
        alerts:
          type: array
          items:
            type: string

    IntegrityAuditLogItem:
      type: object
      required: [timestamp, action]
      properties:
        timestamp:
          type: string
          format: date-time
        actor_id:
          type: string
          nullable: true
        action:
          type: string
        object_type:
          type: string
          nullable: true
        object_id:
          type: string
          nullable: true
        after_state:
          type: object
          nullable: true
          additionalProperties: true

    IntegrityAuditLogResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/IntegrityAuditLogItem'

    SimulatorVizSize:
      type: object
      required: [w, h]
      properties:
        w:
          type: number
        h:
          type: number
      additionalProperties: false

    SimulatorGraphNode:
      type: object
      required: [id]
      properties:
        id:
          type: string
        name:
          type: string
          nullable: true
        type:
          type: string
          nullable: true
        status:
          type: string
          nullable: true
        links_count:
          type: integer
          nullable: true
        net_balance:
          type: string
          nullable: true
        net_balance_atoms:
          type: string
          nullable: true
        net_sign:
          type: integer
          nullable: true
          enum: [-1, 0, 1]
        viz_color_key:
          type: string
          nullable: true
        viz_size:
          $ref: '#/components/schemas/SimulatorVizSize'
        viz_badge_key:
          type: string
          nullable: true
      additionalProperties: true

    SimulatorGraphLink:
      type: object
      required: [source, target]
      properties:
        id:
          type: string
          nullable: true
        source:
          type: string
        target:
          type: string
        trust_limit:
          oneOf:
            - type: string
            - type: number
          nullable: true
        used:
          oneOf:
            - type: string
            - type: number
          nullable: true
        available:
          oneOf:
            - type: string
            - type: number
          nullable: true
        status:
          type: string
          nullable: true
        viz_color_key:
          type: string
          nullable: true
        viz_width_key:
          type: string
          nullable: true
        viz_alpha_key:
          type: string
          nullable: true
      additionalProperties: true

    SimulatorPaletteEntry:
      type: object
      required: [color]
      properties:
        color:
          type: string
        label:
          type: string
          nullable: true
      additionalProperties: false

    SimulatorGraphLimits:
      type: object
      properties:
        max_nodes:
          type: integer
          nullable: true
        max_links:
          type: integer
          nullable: true
        max_particles:
          type: integer
          nullable: true
      additionalProperties: false

    SimulatorGraphSnapshot:
      type: object
      required: [equivalent, generated_at, nodes, links]
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        generated_at:
          type: string
          format: date-time
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/SimulatorGraphNode'
        links:
          type: array
          items:
            $ref: '#/components/schemas/SimulatorGraphLink'
        palette:
          type: object
          nullable: true
          additionalProperties:
            $ref: '#/components/schemas/SimulatorPaletteEntry'
        limits:
          $ref: '#/components/schemas/SimulatorGraphLimits'
      additionalProperties: true

    SimulatorGraphNodePatch:
      type: object
      required: [id]
      properties:
        id:
          type: string
        net_balance:
          type: string
          nullable: true
        net_balance_atoms:
          type: string
          nullable: true
        net_sign:
          type: integer
          nullable: true
          enum: [-1, 0, 1]
        viz_color_key:
          type: string
          nullable: true
        viz_size:
          $ref: '#/components/schemas/SimulatorVizSize'
        viz_badge_key:
          type: string
          nullable: true
      additionalProperties: true

    SimulatorGraphLinkPatch:
      type: object
      required: [source, target]
      properties:
        source:
          type: string
        target:
          type: string
        trust_limit:
          oneOf:
            - type: string
            - type: number
          nullable: true
        used:
          oneOf:
            - type: string
            - type: number
          nullable: true
        available:
          oneOf:
            - type: string
            - type: number
          nullable: true
        status:
          type: string
          nullable: true
        viz_color_key:
          type: string
          nullable: true
        viz_width_key:
          type: string
          nullable: true
        viz_alpha_key:
          type: string
          nullable: true
      additionalProperties: true

    SimulatorEventEdgeRef:
      type: object
      required: [from, to]
      properties:
        from:
          type: string
        to:
          type: string
      additionalProperties: false

    SimulatorEventEdgeStyle:
      type: object
      properties:
        viz_width_key:
          type: string
          nullable: true
        viz_alpha_key:
          type: string
          nullable: true
      additionalProperties: true

    SimulatorTxUpdatedEvent:
      type: object
      required: [event_id, ts, type, equivalent]
      properties:
        event_id:
          type: string
        ts:
          type: string
          format: date-time
        type:
          type: string
          enum: [tx.updated]
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        from:
          type: string
          nullable: true
        to:
          type: string
          nullable: true
        amount:
          type: string
          nullable: true
        ttl_ms:
          type: integer
          nullable: true
        intensity_key:
          type: string
          nullable: true
        edges:
          type: array
          nullable: true
          items:
            type: object
            required: [from, to]
            properties:
              from:
                type: string
              to:
                type: string
              style:
                $ref: '#/components/schemas/SimulatorEventEdgeStyle'
            additionalProperties: true
        node_badges:
          type: array
          nullable: true
          items:
            type: object
            required: [id]
            properties:
              id:
                type: string
              viz_badge_key:
                type: string
                nullable: true
            additionalProperties: true
        node_patch:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SimulatorGraphNodePatch'
        edge_patch:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SimulatorGraphLinkPatch'
      additionalProperties: true

    SimulatorTxFailedEvent:
      type: object
      required: [event_id, ts, type, equivalent, error]
      properties:
        event_id:
          type: string
        ts:
          type: string
          format: date-time
        type:
          type: string
          enum: [tx.failed]
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        from:
          type: string
          nullable: true
        to:
          type: string
          nullable: true
        error:
          type: object
          required: [code, message, at]
          properties:
            code:
              type: string
            message:
              type: string
            at:
              type: string
              format: date-time
          additionalProperties: true
      additionalProperties: true

    SimulatorClearingPlanStep:
      type: object
      required: [at_ms]
      properties:
        at_ms:
          type: integer
        intensity_key:
          type: string
          nullable: true
        highlight_edges:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SimulatorEventEdgeRef'
        particles_edges:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SimulatorEventEdgeRef'
        flash:
          type: object
          nullable: true
          additionalProperties: true
      additionalProperties: true

    SimulatorClearingPlanEvent:
      type: object
      required: [event_id, ts, type, equivalent, plan_id, steps]
      properties:
        event_id:
          type: string
        ts:
          type: string
          format: date-time
        type:
          type: string
          enum: [clearing.plan]
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        plan_id:
          type: string
        steps:
          type: array
          items:
            $ref: '#/components/schemas/SimulatorClearingPlanStep'
      additionalProperties: true

    SimulatorClearingDoneEvent:
      type: object
      required: [event_id, ts, type, equivalent]
      properties:
        event_id:
          type: string
        ts:
          type: string
          format: date-time
        type:
          type: string
          enum: [clearing.done]
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        plan_id:
          type: string
          nullable: true
        cleared_cycles:
          type: integer
          nullable: true
        cleared_amount:
          type: string
          nullable: true
        node_patch:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SimulatorGraphNodePatch'
        edge_patch:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/SimulatorGraphLinkPatch'
      additionalProperties: true

    SimulatorEvent:
      oneOf:
        - $ref: '#/components/schemas/SimulatorTxUpdatedEvent'
        - $ref: '#/components/schemas/SimulatorTxFailedEvent'
        - $ref: '#/components/schemas/SimulatorClearingPlanEvent'
        - $ref: '#/components/schemas/SimulatorClearingDoneEvent'
        - $ref: '#/components/schemas/SimulatorRunStatusEvent'

    SimulatorRunStatusEvent:
      type: object
      required: [event_id, ts, type, run_id, scenario_id, state]
      properties:
        event_id:
          type: string
        ts:
          type: string
          format: date-time
        type:
          type: string
          enum: [run_status]
        run_id:
          type: string
        scenario_id:
          type: string
        state:
          $ref: '#/components/schemas/RunState'
        sim_time_ms:
          type: integer
          nullable: true
          minimum: 0
        intensity_percent:
          type: integer
          nullable: true
          minimum: 0
          maximum: 100
        ops_sec:
          type: number
          nullable: true
          minimum: 0
        queue_depth:
          type: integer
          nullable: true
          minimum: 0
        last_event_type:
          type: string
          nullable: true
        current_phase:
          type: string
          nullable: true
        last_error:
          type: object
          nullable: true
          required: [code, message, at]
          properties:
            code:
              type: string
            message:
              type: string
            at:
              type: string
              format: date-time
          additionalProperties: false
      additionalProperties: true

    ScenarioUploadRequest:
      type: object
      required: [scenario]
      properties:
        scenario:
          type: object
          description: Scenario JSON payload (validated separately via scenario schema)
          additionalProperties: true
      additionalProperties: false

    ScenarioSummary:
      type: object
      required: [api_version, scenario_id, participants_count, trustlines_count, equivalents]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        scenario_id:
          type: string
        name:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true
        participants_count:
          type: integer
          minimum: 0
        trustlines_count:
          type: integer
          minimum: 0
        equivalents:
          type: array
          items:
            type: string
        clusters_count:
          type: integer
          nullable: true
        hubs_count:
          type: integer
          nullable: true
        tags:
          type: array
          nullable: true
          items:
            type: string
      additionalProperties: false

    ScenariosListResponse:
      type: object
      required: [api_version, items]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        items:
          type: array
          items:
            $ref: '#/components/schemas/ScenarioSummary'
      additionalProperties: false

    RunCreateRequest:
      type: object
      required: [scenario_id, mode, intensity_percent]
      properties:
        scenario_id:
          type: string
        mode:
          type: string
          enum: [fixtures, real]
        intensity_percent:
          type: integer
          minimum: 0
          maximum: 100
      additionalProperties: false

    RunCreateResponse:
      type: object
      required: [api_version, run_id]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        run_id:
          type: string
      additionalProperties: false

    RunState:
      type: string
      enum: [idle, running, paused, stopping, stopped, error]

    RunStatus:
      type: object
      required: [api_version, run_id, scenario_id, mode, state]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        run_id:
          type: string
        scenario_id:
          type: string
        mode:
          type: string
          enum: [fixtures, real]
        state:
          $ref: '#/components/schemas/RunState'
        started_at:
          type: string
          format: date-time
          nullable: true
        stopped_at:
          type: string
          format: date-time
          nullable: true
        sim_time_ms:
          type: integer
          nullable: true
          minimum: 0
        intensity_percent:
          type: integer
          nullable: true
          minimum: 0
          maximum: 100
        ops_sec:
          type: number
          nullable: true
          minimum: 0
        queue_depth:
          type: integer
          nullable: true
          minimum: 0
        errors_total:
          type: integer
          nullable: true
          minimum: 0
        errors_last_1m:
          type: integer
          nullable: true
          minimum: 0
        last_error:
          type: object
          nullable: true
          required: [code, message, at]
          properties:
            code:
              type: string
            message:
              type: string
            at:
              type: string
              format: date-time
          additionalProperties: false
        last_event_type:
          type: string
          nullable: true
        current_phase:
          type: string
          nullable: true
      additionalProperties: false

    SetIntensityRequest:
      type: object
      required: [intensity_percent]
      properties:
        intensity_percent:
          type: integer
          minimum: 0
          maximum: 100
      additionalProperties: false

    MetricPoint:
      type: object
      required: [t_ms, v]
      properties:
        t_ms:
          type: integer
          minimum: 0
        v:
          type: number
      additionalProperties: false

    MetricSeriesKey:
      type: string
      enum:
        - success_rate
        - avg_route_length
        - total_debt
        - clearing_volume
        - bottlenecks_score

    MetricSeries:
      type: object
      required: [key, points]
      properties:
        key:
          $ref: '#/components/schemas/MetricSeriesKey'
        unit:
          type: string
          nullable: true
          enum: ['%', count, amount]
        points:
          type: array
          items:
            $ref: '#/components/schemas/MetricPoint'
      additionalProperties: false

    MetricsResponse:
      type: object
      required: [api_version, run_id, equivalent, from_ms, to_ms, step_ms, series]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        run_id:
          type: string
        equivalent:
          type: string
        from_ms:
          type: integer
          minimum: 0
        to_ms:
          type: integer
          minimum: 0
        step_ms:
          type: integer
          minimum: 1
        series:
          type: array
          items:
            $ref: '#/components/schemas/MetricSeries'
      additionalProperties: false

    BottleneckTarget:
      oneOf:
        - type: object
          required: [kind, from, to]
          properties:
            kind:
              type: string
              enum: [edge]
            from:
              type: string
            to:
              type: string
          additionalProperties: false
        - type: object
          required: [kind, id]
          properties:
            kind:
              type: string
              enum: [node]
            id:
              type: string
          additionalProperties: false

    BottleneckReasonCode:
      type: string
      enum:
        - LOW_AVAILABLE
        - HIGH_USED
        - FREQUENT_ABORTS
        - TOO_MANY_TIMEOUTS
        - ROUTING_TOO_DEEP
        - CLEARING_PRESSURE

    BottleneckItem:
      type: object
      required: [target, score, reason_code]
      properties:
        target:
          $ref: '#/components/schemas/BottleneckTarget'
        score:
          type: number
        reason_code:
          $ref: '#/components/schemas/BottleneckReasonCode'
        label:
          type: string
          nullable: true
        suggested_action:
          type: string
          nullable: true
      additionalProperties: false

    BottlenecksResponse:
      type: object
      required: [api_version, run_id, equivalent, items]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        run_id:
          type: string
        equivalent:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/BottleneckItem'
      additionalProperties: false

    ArtifactItem:
      type: object
      required: [name, url]
      properties:
        name:
          type: string
        content_type:
          type: string
          nullable: true
        size_bytes:
          type: integer
          nullable: true
          minimum: 0
        sha256:
          type: string
          nullable: true
        url:
          type: string
      additionalProperties: false

    ArtifactIndex:
      type: object
      required: [api_version, run_id, items]
      properties:
        api_version:
          type: string
          example: simulator-api/1
        run_id:
          type: string
        artifact_path:
          type: string
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/ArtifactItem'
        bundle_url:
          type: string
          nullable: true
      additionalProperties: false
