openapi: 3.0.3

info:
  title: GEO Hub API
  version: "0.1"
  description: |
    OpenAPI spec for GEO Hub (MVP v0.1).

    Canonical contract source: docs/ru/04-api-reference.md.
    Base URL: /api/v1

    Response envelope (normative):
    - Success:
        { "success": true, "data": ... }
      For paginated endpoints:
        { "success": true, "data": [...], "pagination": {...} }
    - Error:
        { "success": false, "error": { "code": "...", "message": "...", "details": {...} } }

servers:
  - url: /api/v1

tags:
  - name: Auth
  - name: Participants
  - name: TrustLines
  - name: Payments
  - name: Balance
  - name: Admin
  - name: WebSocket
  - name: TestOnly

security:
  - BearerAuth: []

paths:
  /auth/challenge:
    post:
      tags: [Auth]
      summary: Start challenge-response auth flow
      description: |
        Starts challenge-response authentication flow.
        Public endpoint (no Bearer token required).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChallengeRequest"
      responses:
        "200":
          description: Challenge created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/ChallengeResponse"
        "400":
          $ref: "#/components/responses/BadRequest"

  /auth/login:
    post:
      tags: [Auth]
      summary: Complete challenge-response and issue JWT tokens
      description: |
        Completes challenge-response auth and issues access/refresh tokens.
        Public endpoint (no Bearer token required).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Tokens issued
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/LoginResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/register:
    post:
      tags: [Auth]
      summary: Register participant
      description: |
        Registers a new participant in the hub.
        Public endpoint (no Bearer token required).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: Participant registered
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/Participant"
        "400":
          $ref: "#/components/responses/BadRequest"

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh access token
      description: |
        Exchanges refresh token for a new access token.
        Public endpoint (no Bearer token required).
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Tokens refreshed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/RefreshResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /participants/me:
    get:
      tags: [Participants]
      summary: Get current participant
      responses:
        "200":
          description: Current participant
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/ParticipantMe"
        "401":
          $ref: "#/components/responses/Unauthorized"
    patch:
      tags: [Participants]
      summary: Update current participant profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ParticipantUpdateRequest"
      responses:
        "200":
          description: Participant updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/ParticipantMe"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /participants/{pid}:
    get:
      tags: [Participants]
      summary: Get participant by PID
      parameters:
        - $ref: "#/components/parameters/PidPath"
      responses:
        "200":
          description: Participant
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/ParticipantPublic"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /participants/search:
    get:
      tags: [Participants]
      summary: Search participants
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Search query (by name)
        - in: query
          name: type
          schema:
            type: string
            enum: [person, organization, hub]
          description: Type filter
        - $ref: "#/components/parameters/PageQuery"
        - $ref: "#/components/parameters/PerPageQuery"
      responses:
        "200":
          description: Participants list (paginated)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - $ref: "#/components/schemas/PaginationEnvelope"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/ParticipantPublic"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /trustlines:
    get:
      tags: [TrustLines]
      summary: List trustlines
      parameters:
        - in: query
          name: direction
          schema:
            type: string
            enum: [outgoing, incoming, all]
            default: all
        - in: query
          name: equivalent
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [active, frozen, closed]
        - $ref: "#/components/parameters/PageQuery"
        - $ref: "#/components/parameters/PerPageQuery"
      responses:
        "200":
          description: Trustlines list (paginated)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - $ref: "#/components/schemas/PaginationEnvelope"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/TrustLine"
        "401":
          $ref: "#/components/responses/Unauthorized"

    post:
      tags: [TrustLines]
      summary: Create trustline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TrustLineCreateRequest"
      responses:
        "201":
          description: Trustline created
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/TrustLine"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /trustlines/{id}:
    get:
      tags: [TrustLines]
      summary: Get trustline by id
      parameters:
        - $ref: "#/components/parameters/TrustLineIdPath"
      responses:
        "200":
          description: Trustline
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/TrustLine"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    patch:
      tags: [TrustLines]
      summary: Update trustline
      parameters:
        - $ref: "#/components/parameters/TrustLineIdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TrustLineUpdateRequest"
      responses:
        "200":
          description: Trustline updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/TrustLine"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      tags: [TrustLines]
      summary: Close trustline
      parameters:
        - $ref: "#/components/parameters/TrustLineIdPath"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SignedRequest"
      responses:
        "200":
          description: Trustline closed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        additionalProperties: true
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /payments/capacity:
    get:
      tags: [Payments]
      summary: Check capacity for a concrete payment amount
      parameters:
        - in: query
          name: to
          required: true
          schema:
            type: string
          description: Recipient PID
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: amount
          required: true
          schema:
            type: string
            pattern: "^[0-9]+(\\.[0-9]+)?$"
          description: Amount as decimal string
      responses:
        "200":
          description: Capacity result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/CapacityResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /payments/max-flow:
    get:
      tags: [Payments]
      summary: Estimate maximum transferable amount and diagnostics
      parameters:
        - in: query
          name: to
          required: true
          schema:
            type: string
          description: Recipient PID
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Max-flow result
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/MaxFlowResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /payments:
    post:
      tags: [Payments]
      summary: Create payment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PaymentCreateRequest"
      responses:
        "200":
          description: Payment created (committed or aborted)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/PaymentResult"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

    get:
      tags: [Payments]
      summary: List payments
      parameters:
        - in: query
          name: direction
          schema:
            type: string
            enum: [sent, received, all]
            default: all
        - in: query
          name: equivalent
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [COMMITTED, ABORTED, all]
            default: all
        - in: query
          name: from_date
          schema:
            type: string
            format: date-time
        - in: query
          name: to_date
          schema:
            type: string
            format: date-time
        - $ref: "#/components/parameters/PageQuery"
        - $ref: "#/components/parameters/PerPageQuery"
      responses:
        "200":
          description: Payments list (paginated)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - $ref: "#/components/schemas/PaginationEnvelope"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/PaymentResult"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /payments/{tx_id}:
    get:
      tags: [Payments]
      summary: Get payment by tx_id
      parameters:
        - in: path
          name: tx_id
          required: true
          schema:
            type: string
          description: Transaction id (UUID)
      responses:
        "200":
          description: Payment details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/PaymentResult"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /balance:
    get:
      tags: [Balance]
      summary: Get aggregated balance by equivalents
      responses:
        "200":
          description: Balance summary
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/BalanceSummary"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /balance/debts:
    get:
      tags: [Balance]
      summary: Get debts details
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: direction
          schema:
            type: string
            enum: [outgoing, incoming, all]
            default: all
      responses:
        "200":
          description: Debts details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/DebtsDetails"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /balance/history:
    get:
      tags: [Balance]
      summary: Balance history (by equivalent)
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: from_date
          schema:
            type: string
            format: date
        - in: query
          name: to_date
          schema:
            type: string
            format: date
        - $ref: "#/components/parameters/PageQuery"
        - $ref: "#/components/parameters/PerPageQuery"
      responses:
        "200":
          description: Balance history entries (paginated)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - $ref: "#/components/schemas/PaginationEnvelope"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/BalanceHistoryEntry"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /ws:
    get:
      tags: [WebSocket]
      summary: WebSocket endpoint (conceptual)
      description: |
        WebSocket endpoint:
        wss://hub.example.com/api/v1/ws?token={access_token}

        Note: OpenAPI does not fully model WebSocket interaction.
      responses:
        "101":
          description: Switching Protocols (WebSocket upgrade)

  # ===========================================================================
  # Admin endpoints (require admin/operator role)
  # ===========================================================================
  /admin/config:
    get:
      tags: [Admin]
      summary: Get current configuration
      description: Returns current runtime configuration (read-only view).
      responses:
        "200":
          description: Configuration
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        additionalProperties: true
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    patch:
      tags: [Admin]
      summary: Update runtime configuration
      description: |
        Update runtime-mutable configuration parameters.
        Only parameters marked as "runtime" in config-reference.md can be changed.
        All changes are logged to audit_log.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        "200":
          description: Configuration updated
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          updated:
                            type: array
                            items:
                              type: string
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /admin/feature-flags:
    get:
      tags: [Admin]
      summary: Get feature flags
      responses:
        "200":
          description: Feature flags
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          multipath_enabled:
                            type: boolean
                          full_multipath_enabled:
                            type: boolean
                          clearing_enabled:
                            type: boolean
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
    patch:
      tags: [Admin]
      summary: Update feature flags
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                multipath_enabled:
                  type: boolean
                full_multipath_enabled:
                  type: boolean
                clearing_enabled:
                  type: boolean
      responses:
        "200":
          description: Feature flags updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessEnvelope"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /admin/participants/{pid}/freeze:
    post:
      tags: [Admin]
      summary: Freeze participant
      description: |
        Temporarily freeze a participant (status -> suspended).
        Frozen participants cannot perform operations.
        Logged to audit_log with reason.
      parameters:
        - $ref: "#/components/parameters/PidPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [reason]
              properties:
                reason:
                  type: string
                  description: Reason for freezing (required for audit)
      responses:
        "200":
          description: Participant frozen
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessEnvelope"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /admin/participants/{pid}/unfreeze:
    post:
      tags: [Admin]
      summary: Unfreeze participant
      description: Restore participant to active status.
      parameters:
        - $ref: "#/components/parameters/PidPath"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
      responses:
        "200":
          description: Participant unfrozen
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SuccessEnvelope"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  /admin/audit-log:
    get:
      tags: [Admin]
      summary: Get audit log entries
      parameters:
        - in: query
          name: action
          schema:
            type: string
          description: Filter by action type
        - in: query
          name: actor_id
          schema:
            type: string
          description: Filter by actor
        - in: query
          name: from_date
          schema:
            type: string
            format: date-time
        - in: query
          name: to_date
          schema:
            type: string
            format: date-time
        - $ref: "#/components/parameters/PageQuery"
        - $ref: "#/components/parameters/PerPageQuery"
      responses:
        "200":
          description: Audit log entries
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - $ref: "#/components/schemas/PaginationEnvelope"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/AuditLogEntry"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /admin/events:
    get:
      tags: [Admin]
      summary: Get domain events (timeline)
      description: |
        Query domain events for investigation and debugging.
        Supports filtering by correlation IDs (run_id, scenario_id, tx_id).
      parameters:
        - in: query
          name: event_type
          schema:
            type: string
          description: Filter by event type (e.g. payment.committed)
        - in: query
          name: actor_pid
          schema:
            type: string
        - in: query
          name: tx_id
          schema:
            type: string
            format: uuid
        - in: query
          name: run_id
          schema:
            type: string
            format: uuid
          description: Filter by test run (for debugging)
        - in: query
          name: scenario_id
          schema:
            type: string
          description: Filter by test scenario (for debugging)
        - in: query
          name: from_date
          schema:
            type: string
            format: date-time
        - in: query
          name: to_date
          schema:
            type: string
            format: date-time
        - $ref: "#/components/parameters/PageQuery"
        - $ref: "#/components/parameters/PerPageQuery"
      responses:
        "200":
          description: Domain events
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - $ref: "#/components/schemas/PaginationEnvelope"
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: "#/components/schemas/DomainEvent"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # ===========================================================================
  # Test-only endpoints (dev/test environment only)
  # ===========================================================================
  /_test/reset:
    post:
      tags: [TestOnly]
      summary: Reset state (dev/test only)
      description: |
        DEV/TEST ONLY.

        Resets storage state (DB + Redis) to an empty baseline.
        Must be disabled in production (routes not registered or guarded by config).
      security: []
      responses:
        "200":
          description: State reset completed
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        type: object
                        required: [reset]
                        properties:
                          reset:
                            type: boolean
                            example: true
        "403":
          $ref: "#/components/responses/Forbidden"

  /_test/seed:
    post:
      tags: [TestOnly]
      summary: Seed a test scenario/topology (dev/test only)
      description: |
        DEV/TEST ONLY.

        Seeds typical topologies required by e2e scenarios (TS-xx) for fast setup:
        - cycles for clearing
        - multiple independent routes for multipath
        - narrow bottlenecks for concurrency tests
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TestSeedRequest"
      responses:
        "200":
          description: Seeded
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/TestSeedResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "403":
          $ref: "#/components/responses/Forbidden"

  /_test/snapshot:
    get:
      tags: [TestOnly]
      summary: Snapshot current state (dev/test only)
      description: |
        DEV/TEST ONLY.

        Returns a snapshot of relevant state for assertions and artifact export.
        If include_events=true, includes domain events for provided run_id/scenario_id
        (or for the current request context).
      security: []
      parameters:
        - in: query
          name: include_events
          schema:
            type: boolean
            default: false
        - in: query
          name: run_id
          schema:
            type: string
            format: uuid
          description: Run identifier (pytest session)
        - in: query
          name: scenario_id
          schema:
            type: string
          description: Scenario identifier (e.g., TS-12)
      responses:
        "200":
          description: Snapshot returned
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/SuccessEnvelope"
                  - type: object
                    properties:
                      data:
                        $ref: "#/components/schemas/TestSnapshot"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    PidPath:
      in: path
      name: pid
      required: true
      schema:
        type: string
      description: Participant identifier (PID)
    TrustLineIdPath:
      in: path
      name: id
      required: true
      schema:
        type: string
        format: uuid
      description: TrustLine UUID

    PageQuery:
      in: query
      name: page
      schema:
        type: integer
        minimum: 1
        default: 1
    PerPageQuery:
      in: query
      name: per_page
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"

  schemas:
    # === Envelope ===
    SuccessEnvelope:
      type: object
      required: [success, data]
      properties:
        success:
          type: boolean
          example: true
        data: {}

    PaginationEnvelope:
      type: object
      required: [pagination]
      properties:
        pagination:
          $ref: "#/components/schemas/Pagination"

    ErrorEnvelope:
      type: object
      required: [success, error]
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              example: E002
            message:
              type: string
              example: Insufficient capacity
            details:
              type: object
              additionalProperties: true

    Pagination:
      type: object
      required: [total, page, per_page, pages]
      properties:
        total:
          type: integer
          example: 150
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        pages:
          type: integer
          example: 8

    # === Common ===
    SignedRequest:
      type: object
      required: [signature]
      properties:
        signature:
          type: string
          description: base64 signature

    # === Auth ===
    ChallengeRequest:
      type: object
      required: [pid]
      properties:
        pid:
          type: string

    ChallengeResponse:
      type: object
      required: [challenge, expires_at]
      properties:
        challenge:
          type: string
        expires_at:
          type: string
          format: date-time

    LoginRequest:
      type: object
      required: [pid, challenge, signature]
      properties:
        pid:
          type: string
        challenge:
          type: string
        signature:
          type: string
        device_info:
          type: object
          additionalProperties: true

    LoginResponse:
      type: object
      required: [access_token, refresh_token, expires_in, participant]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          example: 3600
        participant:
          $ref: "#/components/schemas/ParticipantPublic"

    RegisterRequest:
      type: object
      required: [public_key, display_name, signature]
      properties:
        public_key:
          type: string
          description: base64 encoded Ed25519 public key (32 bytes)
        display_name:
          type: string
        profile:
          type: object
          additionalProperties: true
        signature:
          type: string
          description: base64 signature of registration proof

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    RefreshResponse:
      type: object
      required: [access_token, refresh_token, expires_in]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          example: 3600

    # === Participants ===
    ParticipantBase:
      type: object
      required: [pid, display_name, status]
      properties:
        pid:
          type: string
        display_name:
          type: string
        status:
          type: string
          enum: [active, suspended, left, deleted]
        verification_level:
          type: integer
          minimum: 0
          maximum: 3
        profile:
          type: object
          additionalProperties: true

    Participant:
      allOf:
        - $ref: "#/components/schemas/ParticipantBase"
        - type: object
          properties:
            public_key:
              type: string
              description: base64 encoded Ed25519 public key (32 bytes)
            created_at:
              type: string
              format: date-time

    ParticipantPublic:
      allOf:
        - $ref: "#/components/schemas/ParticipantBase"
        - type: object
          properties:
            public_stats:
              type: object
              additionalProperties: true

    ParticipantMe:
      allOf:
        - $ref: "#/components/schemas/ParticipantBase"
        - type: object
          properties:
            created_at:
              type: string
              format: date-time
            stats:
              type: object
              additionalProperties: true

    ParticipantUpdateRequest:
      type: object
      properties:
        display_name:
          type: string
        profile:
          type: object
          additionalProperties: true
        signature:
          type: string

    # === TrustLines ===
    TrustLinePolicy:
      type: object
      additionalProperties: true

    TrustLine:
      type: object
      required: [id, from, to, equivalent, limit, used]
      properties:
        id:
          type: string
          format: uuid
        from:
          type: string
          description: PID of trustline creator (creditor)
        to:
          type: string
          description: PID of trustee (potential debtor)
        to_display_name:
          type: string
        equivalent:
          type: string
          description: Equivalent code (e.g. UAH, HOUR)
        limit:
          type: string
          description: Maximum debt allowed (decimal string)
        used:
          type: string
          description: Current debt against this line (decimal string)
        available:
          type: string
          description: Available credit (limit - used)
        policy:
          $ref: "#/components/schemas/TrustLinePolicy"
        status:
          type: string
          enum: [active, frozen, closed]
        created_at:
          type: string
          format: date-time

    TrustLineCreateRequest:
      type: object
      required: [to, equivalent, limit, signature]
      properties:
        to:
          type: string
        equivalent:
          type: string
        limit:
          type: string
        policy:
          $ref: "#/components/schemas/TrustLinePolicy"
        signature:
          type: string

    TrustLineUpdateRequest:
      type: object
      properties:
        limit:
          type: string
        policy:
          $ref: "#/components/schemas/TrustLinePolicy"
        signature:
          type: string

    # === Payments ===
    CapacityResponse:
      type: object
      required: [can_pay, max_amount, routes_count, estimated_hops]
      properties:
        can_pay:
          type: boolean
        max_amount:
          type: string
        routes_count:
          type: integer
        estimated_hops:
          type: integer

    MaxFlowPath:
      type: object
      required: [path, capacity]
      properties:
        path:
          type: array
          items:
            type: string
        capacity:
          type: string

    Bottleneck:
      type: object
      required: [from, to, limit, used, available]
      properties:
        from:
          type: string
        to:
          type: string
        limit:
          type: string
        used:
          type: string
        available:
          type: string

    MaxFlowResponse:
      type: object
      required: [max_amount, paths, bottlenecks, algorithm, computed_at]
      properties:
        max_amount:
          type: string
        paths:
          type: array
          items:
            $ref: "#/components/schemas/MaxFlowPath"
        bottlenecks:
          type: array
          items:
            $ref: "#/components/schemas/Bottleneck"
        algorithm:
          type: string
        computed_at:
          type: string
          format: date-time

    PaymentCreateRequest:
      type: object
      required: [to, equivalent, amount, signature]
      properties:
        to:
          type: string
        equivalent:
          type: string
        amount:
          type: string
        description:
          type: string
        constraints:
          type: object
          additionalProperties: true
        signature:
          type: string

    PaymentRoute:
      type: object
      required: [path, amount]
      properties:
        path:
          type: array
          items:
            type: string
        amount:
          type: string

    PaymentError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    PaymentResult:
      type: object
      required: [tx_id, status, from, to, equivalent, amount, created_at]
      properties:
        tx_id:
          type: string
          description: UUID
        status:
          type: string
          enum: [COMMITTED, ABORTED]
        from:
          type: string
        to:
          type: string
        equivalent:
          type: string
        amount:
          type: string
        routes:
          type: array
          items:
            $ref: "#/components/schemas/PaymentRoute"
        error:
          $ref: "#/components/schemas/PaymentError"
        created_at:
          type: string
          format: date-time
        committed_at:
          type: string
          format: date-time

    # === Balance ===
    BalanceEquivalent:
      type: object
      required: [code, total_debt, total_credit, net_balance, available_to_spend, available_to_receive]
      properties:
        code:
          type: string
        total_debt:
          type: string
        total_credit:
          type: string
        net_balance:
          type: string
        available_to_spend:
          type: string
        available_to_receive:
          type: string

    BalanceSummary:
      type: object
      required: [equivalents]
      properties:
        equivalents:
          type: array
          items:
            $ref: "#/components/schemas/BalanceEquivalent"

    DebtsDetails:
      type: object
      required: [outgoing, incoming]
      properties:
        outgoing:
          type: array
          items:
            type: object
            required: [creditor, equivalent, amount]
            properties:
              creditor:
                type: string
              creditor_name:
                type: string
              equivalent:
                type: string
              amount:
                type: string
        incoming:
          type: array
          items:
            type: object
            required: [debtor, equivalent, amount]
            properties:
              debtor:
                type: string
              debtor_name:
                type: string
              equivalent:
                type: string
              amount:
                type: string

    BalanceHistoryEntry:
      type: object
      required: [timestamp, equivalent, delta, reason]
      properties:
        timestamp:
          type: string
          format: date-time
        equivalent:
          type: string
        delta:
          type: string
          description: Signed decimal string (e.g. "-10.00", "5.00")
        reason:
          type: string
        details:
          type: object
          additionalProperties: true

    # === Test-only (dev/test) ===
    TestSeedRequest:
      type: object
      required: [scenario]
      properties:
        scenario:
          type: string
          description: Scenario/topology id (e.g. "triangle", "multipath_2_routes")
        params:
          type: object
          additionalProperties: true
        seed:
          type: string
          description: Optional seed to make generated data deterministic

    TestSeedResponse:
      type: object
      required: [summary]
      properties:
        summary:
          type: object
          additionalProperties: true

    TestSnapshot:
      type: object
      description: Snapshot of current state for assertions and artifacts.
      additionalProperties: true
    # === Admin ===
    AuditLogEntry:
      type: object
      required: [id, timestamp, action]
      properties:
        id:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        actor_id:
          type: string
        actor_role:
          type: string
        action:
          type: string
          description: Action type (e.g. participant.freeze, config.update)
        object_type:
          type: string
        object_id:
          type: string
        reason:
          type: string
        before_state:
          type: object
          additionalProperties: true
        after_state:
          type: object
          additionalProperties: true
        request_id:
          type: string
        ip_address:
          type: string

    DomainEvent:
      type: object
      required: [event_id, event_type, timestamp]
      properties:
        event_id:
          type: string
          format: uuid
        event_type:
          type: string
          description: Event type (e.g. payment.committed, trustline.created)
        timestamp:
          type: string
          format: date-time
        run_id:
          type: string
          format: uuid
          description: Test run correlation ID
        scenario_id:
          type: string
          description: Test scenario correlation ID
        request_id:
          type: string
          format: uuid
        tx_id:
          type: string
          format: uuid
        actor_pid:
          type: string
        payload:
          type: object
          additionalProperties: true