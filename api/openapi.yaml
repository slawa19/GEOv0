openapi: 3.0.3
info:
  title: GEO Hub API
  version: 0.1
  description: |
    OpenAPI spec for GEO Hub (MVP v0.1). Derived from docs/ru/04-api-reference.md.
servers:
  - url: /api/v1
tags:
  - name: Auth
  - name: Participants
  - name: TrustLines
  - name: Payments
  - name: Balance
  - name: Clearing
  - name: Equivalents
security:
  - BearerAuth: []

paths:
  /equivalents:
    get:
      tags: [Equivalents]
      summary: List active equivalents
      responses:
        '200':
          description: Equivalents list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EquivalentsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/challenge:
    post:
      tags: [Auth]
      summary: Start challenge-response auth flow
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChallengeRequest'
      responses:
        '200':
          description: Challenge created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChallengeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/login:
    post:
      tags: [Auth]
      summary: Complete challenge-response and issue JWT tokens
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Exchange refresh token for a new token pair
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshRequest'
      responses:
        '200':
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /participants:
    get:
      tags: [Participants]
      summary: Search participants
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Search query
        - in: query
          name: type
          schema:
            type: string
            enum: [person, organization, hub]
          description: Type filter
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
          description: Max results
      responses:
        '200':
          description: Participants list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParticipantsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [Participants]
      summary: Register participant
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParticipantCreateRequest'
      responses:
        '201':
          description: Participant created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '400':
          $ref: '#/components/responses/BadRequest'

  /participants/search:
    get:
      tags: [Participants]
      summary: Search participants (alias)
      parameters:
        - in: query
          name: q
          schema:
            type: string
          description: Search query
        - in: query
          name: type
          schema:
            type: string
            enum: [person, organization, hub]
          description: Type filter
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
          description: Max results
      responses:
        '200':
          description: Participants list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParticipantsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /participants/me:
    get:
      tags: [Participants]
      summary: Get current participant profile with stats
      responses:
        '200':
          description: Current participant with stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ParticipantWithStats'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      tags: [Participants]
      summary: Update current participant profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParticipantUpdateRequest'
      responses:
        '200':
          description: Updated participant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /participants/{pid}:
    get:
      tags: [Participants]
      summary: Get participant
      parameters:
        - $ref: '#/components/parameters/PidPath'
      responses:
        '200':
          description: Participant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /trustlines:
    get:
      tags: [TrustLines]
      summary: List trustlines
      parameters:
        - in: query
          name: direction
          schema:
            type: string
            enum: [outgoing, incoming, all]
            default: all
        - in: query
          name: equivalent
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [active, frozen, closed]
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Trustlines list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLinesList'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [TrustLines]
      summary: Create trustline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrustLineCreateRequest'
      responses:
        '201':
          description: Trustline created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLine'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /trustlines/{id}:
    get:
      tags: [TrustLines]
      summary: Get trustline
      parameters:
        - $ref: '#/components/parameters/TrustLineIdPath'
      responses:
        '200':
          description: Trustline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLine'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      tags: [TrustLines]
      summary: Update trustline
      parameters:
        - $ref: '#/components/parameters/TrustLineIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrustLineUpdateRequest'
      responses:
        '200':
          description: Trustline updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrustLine'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags: [TrustLines]
      summary: Close trustline
      parameters:
        - $ref: '#/components/parameters/TrustLineIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrustLineCloseRequest'
      responses:
        '200':
          description: Closed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /clearing/cycles:
    get:
      tags: [Clearing]
      summary: List debt cycles for an equivalent
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: max_depth
          required: false
          schema:
            type: integer
            minimum: 3
            maximum: 10
            default: 6
      responses:
        '200':
          description: Cycles
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearingCyclesResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /clearing/auto:
    post:
      tags: [Clearing]
      summary: Auto-clear cycles for an equivalent
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Clearing result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClearingAutoResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /payments/capacity:
    get:
      tags: [Payments]
      summary: Check capacity for a concrete payment amount
      parameters:
        - in: query
          name: to
          required: true
          schema:
            type: string
          description: Recipient PID
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: amount
          required: true
          schema:
            type: string
            pattern: '^[0-9]+(\.[0-9]+)?$'
          description: Amount as decimal string
      responses:
        '200':
          description: Capacity result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapacityResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /payments/max-flow:
    get:
      tags: [Payments]
      summary: Estimate maximum transferable amount and diagnostics
      parameters:
        - in: query
          name: to
          required: true
          schema:
            type: string
          description: Recipient PID
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Max-flow result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MaxFlowResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /payments:
    post:
      tags: [Payments]
      summary: Create payment
      parameters:
        - in: header
          name: Idempotency-Key
          required: false
          schema:
            type: string
            maxLength: 128
          description: Optional idempotency key. Re-using the same key returns the same result; re-using with a different request returns 409.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentCreateRequest'
      responses:
        '200':
          description: Payment created (committed or aborted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResult'
        '409':
          $ref: '#/components/responses/Conflict'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

    get:
      tags: [Payments]
      summary: List payments
      parameters:
        - in: query
          name: direction
          schema:
            type: string
            enum: [sent, received, all]
            default: all
        - in: query
          name: equivalent
          schema:
            type: string
        - in: query
          name: status
          schema:
            type: string
            enum: [COMMITTED, ABORTED, all]
            default: all
          description: Final payment outcome filter. This API exposes only final statuses (`COMMITTED` or `ABORTED`).
        - in: query
          name: from_date
          schema:
            type: string
            format: date-time
        - in: query
          name: to_date
          schema:
            type: string
            format: date-time
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Payments list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentsList'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /payments/{tx_id}:
    get:
      tags: [Payments]
      summary: Get payment by tx_id
      parameters:
        - in: path
          name: tx_id
          required: true
          schema:
            type: string
          description: Transaction id
      responses:
        '200':
          description: Payment details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /balance:
    get:
      tags: [Balance]
      summary: Get aggregated balance by equivalents
      responses:
        '200':
          description: Balance summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /balance/debts:
    get:
      tags: [Balance]
      summary: Get debts details
      parameters:
        - in: query
          name: equivalent
          required: true
          schema:
            type: string
        - in: query
          name: direction
          schema:
            type: string
            enum: [outgoing, incoming, all]
            default: all
      responses:
        '200':
          description: Debts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebtsDetails'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrity/status:
    get:
      tags: [Integrity]
      summary: Get integrity status
      responses:
        '200':
          description: Current integrity status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityStatusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /integrity/checksum/{equivalent}:
    get:
      tags: [Integrity]
      summary: Get latest integrity checksum for equivalent
      parameters:
        - in: path
          name: equivalent
          required: true
          schema:
            $ref: '#/components/schemas/EquivalentCode'
      responses:
        '200':
          description: Latest integrity checkpoint checksum
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityChecksumResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /integrity/verify:
    post:
      tags: [Integrity]
      summary: Run invariant verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntegrityVerifyRequest'
      responses:
        '200':
          description: Verification results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityVerifyResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /integrity/audit-log:
    get:
      tags: [Integrity]
      summary: List integrity verification audit log entries
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
        - in: query
          name: per_page
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 20
      responses:
        '200':
          description: Audit log items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityAuditLogResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    PidPath:
      in: path
      name: pid
      required: true
      schema:
        type: string
    TrustLineIdPath:
      in: path
      name: id
      required: true
      schema:
        type: string
        format: uuid
        description: TrustLine UUID

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'

  schemas:
    Equivalent:
      type: object
      required: [code, precision, is_active, created_at, updated_at]
      properties:
        code:
          $ref: '#/components/schemas/EquivalentCode'
        symbol:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        precision:
          type: integer
          minimum: 0
          maximum: 18
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    EquivalentsList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Equivalent'

    EquivalentCode:
      type: string
      pattern: '^[A-Z0-9_]{1,16}$'
      description: Equivalent code (1-16 chars; A-Z, 0-9, underscore)
    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true

    SignedRequest:
      type: object
      properties:
        signature:
          type: string
          description: base64 signature

    ChallengeRequest:
      type: object
      required: [pid]
      properties:
        pid:
          type: string

    ChallengeResponse:
      type: object
      required: [challenge, expires_at]
      properties:
        challenge:
          type: string
        expires_at:
          type: string
          format: date-time

    LoginRequest:
      type: object
      required: [pid, challenge, signature]
      properties:
        pid:
          type: string
        challenge:
          type: string
        signature:
          type: string
        device_info:
          $ref: '#/components/schemas/DeviceInfo'

    DeviceInfo:
      type: object
      properties:
        platform:
          type: string
          nullable: true
        app_version:
          type: string
          nullable: true

    RefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token:
          type: string

    TokenPair:
      type: object
      required: [access_token, refresh_token, expires_in, participant]
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
          description: Access token TTL in seconds
          example: 3600
        participant:
          $ref: '#/components/schemas/ParticipantPublic'
        token_type:
          type: string
          example: Bearer

    ParticipantPublic:
      type: object
      required: [pid, display_name, status]
      properties:
        pid:
          type: string
        display_name:
          type: string
        status:
          type: string
          enum: [active, suspended, left, deleted]

    Participant:
      type: object
      required: [pid, status]
      properties:
        pid:
          type: string
          description: Participant identifier (derived from public_key)
        display_name:
          type: string
        type:
          type: string
          enum: [person, organization, hub]
        status:
          type: string
          enum: [active, suspended, left, deleted]
          description: |
            Participant status:
            - active: normal operation
            - suspended: temporarily frozen by admin (can be unfrozen)
            - left: participant voluntarily left the community
            - deleted: participant removed from system
        verification_level:
          type: integer
          minimum: 0
          maximum: 3
          description: Verification level (0=unverified, 3=fully verified)
        public_key:
          type: string
          description: Ed25519 public key (base64)
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        profile:
          $ref: '#/components/schemas/ParticipantProfile'
        public_stats:
          $ref: '#/components/schemas/ParticipantPublicStats'

    ParticipantProfile:
      type: object
      additionalProperties: true
      properties:
        type:
          type: string
          nullable: true
        description:
          type: string
          nullable: true
        contacts:
          type: object
          nullable: true
          additionalProperties: true

    ParticipantPublicStats:
      type: object
      required: [total_incoming_trust, member_since]
      properties:
        total_incoming_trust:
          type: string
        member_since:
          type: string
          format: date-time

    ParticipantCreateRequest:
      type: object
      required: [display_name, public_key, signature]
      properties:
        display_name:
          type: string
        type:
          type: string
          enum: [person, organization, hub]
          default: person
        public_key:
          type: string
        profile:
          $ref: '#/components/schemas/ParticipantProfile'
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `display_name`, `type`, `public_key`, and optional `profile` if provided.

    ParticipantsList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Participant'

    ParticipantStats:
      type: object
      required: [total_incoming_trust, total_outgoing_trust, total_debt, total_credit, net_balance]
      properties:
        total_incoming_trust:
          type: string
        total_outgoing_trust:
          type: string
        total_debt:
          type: string
        total_credit:
          type: string
        net_balance:
          type: string

    ParticipantWithStats:
      allOf:
        - $ref: '#/components/schemas/Participant'
        - type: object
          required: [stats]
          properties:
            stats:
              $ref: '#/components/schemas/ParticipantStats'

    ParticipantUpdateRequest:
      type: object
      required: [signature]
      properties:
        display_name:
          type: string
          nullable: true
        profile:
          $ref: '#/components/schemas/ParticipantProfile'
        signature:
          type: string

    TrustLine:
      type: object
      required: [id, from, to, equivalent, limit, used]
      properties:
        id:
          type: string
          format: uuid
          description: TrustLine UUID
        from:
          type: string
          description: PID of trustline creator (creditor)
        to:
          type: string
          description: PID of trustee (potential debtor)
        from_display_name:
          type: string
          nullable: true
        to_display_name:
          type: string
          nullable: true
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        limit:
          type: string
          description: Maximum debt allowed (decimal string)
        used:
          type: string
          description: Current debt against this line (decimal string)
        available:
          type: string
          description: Available credit (limit - used)
        policy:
          type: object
          additionalProperties: true
          description: |
            TrustLine policy settings.

            Allowed keys (MVP): `auto_clearing`, `can_be_intermediate`, `max_hop_usage`, `daily_limit`, `blocked_participants`.

            Note: `daily_limit` is **informational only** and is **not enforced in MVP**.
        status:
          type: string
          enum: [active, frozen, closed]
          description: TrustLine status
        created_at:
          type: string
          format: date-time

    TrustLinesList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/TrustLine'

    TrustLineCreateRequest:
      type: object
      required: [to, equivalent, limit, signature]
      properties:
        to:
          type: string
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        limit:
          type: string
        policy:
          type: object
          additionalProperties: true
          description: |
            Optional TrustLine policy.

            Allowed keys (MVP): `auto_clearing`, `can_be_intermediate`, `max_hop_usage`, `daily_limit`, `blocked_participants`.

            Note: `daily_limit` is **informational only** and is **not enforced in MVP**.
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `to`, `equivalent`, `limit`, and optional `policy` if provided.

    TrustLineUpdateRequest:
      type: object
      required: [signature]
      properties:
        limit:
          type: string
        policy:
          type: object
          additionalProperties: true
          description: |
            Optional TrustLine policy update.

            Allowed keys (MVP): `auto_clearing`, `can_be_intermediate`, `max_hop_usage`, `daily_limit`, `blocked_participants`.

            Note: `daily_limit` is **informational only** and is **not enforced in MVP**.
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `id` (path param), optional `limit` if provided, optional `policy` if provided.

    TrustLineCloseRequest:
      type: object
      required: [signature]
      properties:
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON payload **excluding** `signature`.
            Signed payload keys: `id` (path param).

    ClearingCycleEdge:
      type: object
      required: [debt_id, debtor, creditor, amount]
      properties:
        debt_id:
          type: string
        debtor:
          type: string
        creditor:
          type: string
        amount:
          type: string

    ClearingCyclesResponse:
      type: object
      required: [cycles]
      properties:
        cycles:
          type: array
          items:
            type: array
            items:
              $ref: '#/components/schemas/ClearingCycleEdge'

    ClearingAutoResponse:
      type: object
      required: [equivalent, cleared_cycles]
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        cleared_cycles:
          type: integer

    CapacityResponse:
      type: object
      required: [can_pay, max_amount, routes_count, estimated_hops]
      properties:
        can_pay:
          type: boolean
        max_amount:
          type: string
        routes_count:
          type: integer
        estimated_hops:
          type: integer

    MaxFlowPath:
      type: object
      required: [path, capacity]
      properties:
        path:
          type: array
          items:
            type: string
        capacity:
          type: string

    Bottleneck:
      type: object
      required: [from, to, limit, used, available]
      properties:
        from:
          type: string
        to:
          type: string
        limit:
          type: string
        used:
          type: string
        available:
          type: string

    MaxFlowResponse:
      type: object
      required: [max_amount, paths, bottlenecks, algorithm, computed_at]
      properties:
        max_amount:
          type: string
        paths:
          type: array
          items:
            $ref: '#/components/schemas/MaxFlowPath'
        bottlenecks:
          type: array
          items:
            $ref: '#/components/schemas/Bottleneck'
        algorithm:
          type: string
        computed_at:
          type: string
          format: date-time

    PaymentCreateRequest:
      type: object
      required: [to, equivalent, amount, signature]
      properties:
        to:
          type: string
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        amount:
          type: string
        description:
          type: string
        constraints:
          $ref: '#/components/schemas/PaymentConstraints'
        signature:
          type: string
          description: |
            base64 Ed25519 signature of canonical JSON of this request body **excluding** `signature`.
            Signed payload keys: `to`, `equivalent`, `amount`, optional `description`, optional `constraints`.

    PaymentConstraints:
      type: object
      additionalProperties: false
      properties:
        max_hops:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
        max_paths:
          type: integer
          minimum: 1
          maximum: 10
          nullable: true
        timeout_ms:
          type: integer
          minimum: 1
          maximum: 120000
          nullable: true
        avoid:
          type: array
          items:
            type: string
          nullable: true

    PaymentRoute:
      type: object
      required: [path, amount]
      properties:
        path:
          type: array
          items:
            type: string
        amount:
          type: string

    PaymentError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
          additionalProperties: true

    PaymentResult:
      type: object
      required: [tx_id, status, from, to, equivalent, amount, created_at]
      properties:
        tx_id:
          type: string
        status:
          type: string
          enum: [COMMITTED, ABORTED]
          description: Final payment outcome. Internal transaction states are not exposed via the Payments API.
        from:
          type: string
        to:
          type: string
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        amount:
          type: string
        routes:
          type: array
          items:
            $ref: '#/components/schemas/PaymentRoute'
        error:
          $ref: '#/components/schemas/PaymentError'
        created_at:
          type: string
          format: date-time
        committed_at:
          type: string
          format: date-time

    PaymentsList:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PaymentResult'

    BalanceEquivalent:
      type: object
      required: [code, total_debt, total_credit, net_balance, available_to_spend, available_to_receive]
      properties:
        code:
          $ref: '#/components/schemas/EquivalentCode'
        total_debt:
          type: string
        total_credit:
          type: string
        net_balance:
          type: string
        available_to_spend:
          type: string
        available_to_receive:
          type: string

    BalanceSummary:
      type: object
      required: [equivalents]
      properties:
        equivalents:
          type: array
          items:
            $ref: '#/components/schemas/BalanceEquivalent'

    DebtsDetails:
      type: object
      required: [outgoing, incoming]
      properties:
        outgoing:
          type: array
          items:
            type: object
            required: [creditor, equivalent, amount]
            properties:
              creditor:
                type: string
              creditor_name:
                type: string
              equivalent:
                $ref: '#/components/schemas/EquivalentCode'
              amount:
                type: string
        incoming:
          type: array
          items:
            type: object
            required: [debtor, equivalent, amount]
            properties:
              debtor:
                type: string
              debtor_name:
                type: string
              equivalent:
                $ref: '#/components/schemas/EquivalentCode'
              amount:
                type: string

    InvariantResult:
      type: object
      required: [passed]
      properties:
        passed:
          type: boolean
        value:
          type: string
          nullable: true
        violations:
          type: integer
          nullable: true
        details:
          type: object
          nullable: true
          additionalProperties: true

    EquivalentIntegrityStatus:
      type: object
      required: [status, checksum, invariants]
      properties:
        status:
          type: string
          enum: [healthy, warning, critical]
        checksum:
          type: string
        last_verified:
          type: string
          format: date-time
          nullable: true
        invariants:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/InvariantResult'

    IntegrityStatusResponse:
      type: object
      required: [status, last_check, equivalents, alerts]
      properties:
        status:
          type: string
          enum: [healthy, warning, critical]
        last_check:
          type: string
          format: date-time
        equivalents:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/EquivalentIntegrityStatus'
        alerts:
          type: array
          items:
            type: string

    IntegrityChecksumResponse:
      type: object
      required: [equivalent, checksum, created_at, invariants_status]
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
        checksum:
          type: string
        created_at:
          type: string
          format: date-time
        invariants_status:
          type: object
          additionalProperties: true

    IntegrityVerifyRequest:
      type: object
      properties:
        equivalent:
          $ref: '#/components/schemas/EquivalentCode'
      additionalProperties: false

    IntegrityVerifyResponse:
      type: object
      required: [status, checked_at, equivalents, alerts]
      properties:
        status:
          type: string
          enum: [healthy, warning, critical]
        checked_at:
          type: string
          format: date-time
        equivalents:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/EquivalentIntegrityStatus'
        alerts:
          type: array
          items:
            type: string

    IntegrityAuditLogItem:
      type: object
      required: [timestamp, action]
      properties:
        timestamp:
          type: string
          format: date-time
        actor_id:
          type: string
          nullable: true
        action:
          type: string
        object_type:
          type: string
          nullable: true
        object_id:
          type: string
          nullable: true
        after_state:
          type: object
          nullable: true
          additionalProperties: true

    IntegrityAuditLogResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/IntegrityAuditLogItem'
