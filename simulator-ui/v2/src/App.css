.root {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  /* Base app surface is driven by design-system tokens (themes via data-theme). */
  background: var(--ds-page-bg);
  color: var(--ds-text-1);
  /* IMPORTANT: keep typography token-driven so themes (e.g. HUD) apply everywhere. */
  font-size: var(--ds-root-font-size);
  font-family: var(--ds-typo-body-font-family);
  line-height: var(--ds-typo-body-line-height);
  letter-spacing: var(--ds-typo-body-letter-spacing);
  font-weight: var(--ds-typo-body-font-weight);

  /* Interact overlays z-index scale (single source of truth for app-level layers). */
  --ds-z-canvas: 1;
  --ds-z-canvas-fx: 3;
  --ds-z-drag-preview: 6;

  /* World-space labels and transient floating labels must be BELOW UI windows/panels. */
  --ds-z-world-labels: 20;

  /* HUD + overlays (design-system defaults use the same numbers). */
  --ds-z-bottom: 30;
  --ds-z-top: 40;
  --ds-z-panel: 42;
  --ds-z-dev: 50;
  --ds-z-tooltip: 55;
  --ds-z-inset: 60;
  --ds-z-alert: 200;
}

/* Interact HUD: SystemBalanceBar + ActionBar — stacks inside TopBar's ds-ov-top-stack */
/* justify-content: space-between — SystemBalanceBar left, ActionBar right.
   ActionBar right-aligns with .ds-ov-panel { right: 12px } so buttons and
   opening panels appear on the same side of the screen. */
.interact-hud-bar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  pointer-events: auto;
}

.canvas {
  position: absolute;
  inset: 0;
  z-index: var(--ds-z-canvas);
}

.canvas-fx {
  pointer-events: none;
  z-index: var(--ds-z-canvas-fx);
}

.root[data-webdriver='1'] .canvas-fx {
  /* Keep Playwright screenshots stable (no animated FX layer in captures). */
  z-index: 0;
}

/* Low/Med quality OR no-GPU: disable expensive backdrop blurs (big perf win in Chrome). */
.root[data-quality='low'] .drag-preview,
.root[data-quality='low'] .ds-panel,
.root[data-quality='low'] .ds-ov-tooltip,
.root[data-quality='low'] .ds-ov-node-card,
.root[data-quality='low'] .ds-ov-message,
.root[data-quality='low'] .ds-ov-surface,
.root[data-quality='low'] .ds-ov-dev-perf,

.root[data-quality='med'] .drag-preview,
.root[data-quality='med'] .ds-panel,
.root[data-quality='med'] .ds-ov-tooltip,
.root[data-quality='med'] .ds-ov-node-card,
.root[data-quality='med'] .ds-ov-message,
.root[data-quality='med'] .ds-ov-surface,
.root[data-quality='med'] .ds-ov-dev-perf,

.root[data-gpu='0'] .drag-preview,
.root[data-gpu='0'] .ds-panel,
.root[data-gpu='0'] .ds-ov-tooltip,
.root[data-gpu='0'] .ds-ov-node-card,
.root[data-gpu='0'] .ds-ov-message,
.root[data-gpu='0'] .ds-ov-surface,
.root[data-gpu='0'] .ds-ov-dev-perf {
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
}

/* Low quality: pause HUD infinite CSS animations to reduce GPU compositor load. */
.root[data-quality='low'] .ds-panel--elevated,
.root[data-quality='low'] .ds-panel--elevated::before,
.root[data-quality='low'] .ds-panel__header::before {
  animation: none;
}

/* Med quality: pause the heaviest scanline animation (but keep borderGlow + pulseGlow). */
.root[data-quality='med'] .ds-panel--elevated::before {
  animation: none;
}

.drag-preview {
  position: absolute;
  left: 0;
  top: 0;
  z-index: var(--ds-z-drag-preview);
  display: none;
  pointer-events: none;
  will-change: transform;
  transform: translate3d(0, 0, 0);
  border: 1px solid rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(6px);
}

.mono {
  font-family: var(--ds-font-mono);
}
.floating-layer {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: var(--ds-z-world-labels);
  /* Isolate layout/paint of transient labels from the rest of the UI. */
  contain: layout paint;
}

.labels-layer {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: var(--ds-z-world-labels);
  contain: layout paint;
}

.node-label {
  position: absolute;
  left: 0;
  top: 0;
  will-change: transform;
}

.node-label-inner {
  /* Centered label, placed below the node via computed world offset (no frame). */
  transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1));
  font-size: 12px;
  font-weight: 650;
  padding: 1px 6px;
  border: none;
  background: transparent;
  text-align: center;
  text-shadow:
    0 0 14px rgba(0, 0, 0, 0.92),
    0 0 10px rgba(148, 163, 184, 0.42);
  filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.18));
  white-space: nowrap;
}

.floating-label {
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
}

.floating-label-inner {
  display: inline-block;
  font-size: 14px;
  font-weight: 700;
  text-shadow: 0 0 10px currentColor; /* Default glow */
  animation: floatUpFade 2.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  /* Keep centering constant; animate only a pixel offset for smooth motion. */
  transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1)) translate3d(0, 0, 0);
  will-change: transform, opacity;
  backface-visibility: hidden;
  white-space: pre-line;
  text-align: center;
  line-height: 1.05;
  font-variant-numeric: tabular-nums;
}

/* Improve contrast over nodes/background, but keep WebDriver screenshots stable. */
.root:not([data-webdriver='1']) .floating-label-inner {
  /* Airy by default: subtle dark halo + neon glow. */
  text-shadow:
    0 0 12px rgba(0, 0, 0, 0.85),
    0 0 12px currentColor;
  filter: drop-shadow(0 10px 22px rgba(0, 0, 0, 0.2));
  transition: filter 120ms linear;
}

/* Only boost readability when the label is likely to merge with a node behind it. */
.root:not([data-webdriver='1']) .floating-label-inner.is-glow {
  filter:
    drop-shadow(0 0 calc(6px + 14px * var(--glow)) rgba(255, 255, 255, 0.38))
    drop-shadow(0 0 calc(8px + 18px * var(--glow)) currentColor)
    drop-shadow(0 10px 22px rgba(0, 0, 0, 0.2));
  text-shadow:
    0 0 12px rgba(0, 0, 0, 0.92),
    0 0 12px currentColor,
    0 0 calc(4px + 12px * var(--glow)) rgba(255, 255, 255, 0.52);
}

@keyframes floatUpFade {
  0% {
    opacity: 0;
    transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1)) translate3d(0, 0, 0);
  }
  8% {
    opacity: 1;
    transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1)) translate3d(0, -2px, 0);
  }
  60% {
    opacity: 1;
    transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1)) translate3d(0, -14px, 0);
  }
  100% {
    opacity: 0;
    transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1)) translate3d(0, -34px, 0);
  }
}

/* ── Premium clearing amount label ── */

.floating-label-inner.clearing-premium {
  font-size: 32px;
  font-weight: 800;
  letter-spacing: 0.02em;
  color: var(--ds-warn) !important;
  animation: clearingPremiumPop 4.2s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
  text-shadow:
    0 0 20px color-mix(in srgb, var(--ds-warn) 90%, transparent),
    0 0 40px color-mix(in srgb, var(--ds-warn) 50%, transparent),
    0 0 6px rgba(0, 0, 0, 0.95),
    0 2px 4px rgba(0, 0, 0, 0.6);
  filter:
    drop-shadow(0 0 12px color-mix(in srgb, var(--ds-warn) 70%, transparent))
    drop-shadow(0 0 28px color-mix(in srgb, var(--ds-warn) 35%, transparent));
  white-space: nowrap;
  will-change: transform, opacity;
}

/*
 * Compositor-only animation: a single translate3d handles centering + vertical drift,
 * scale is a separate property — no nested calc() chains, no layout thrashing.
 * Trajectory: pop from slightly below, settle, then gently drift upward and dissolve.
 */
@keyframes clearingPremiumPop {
  0% {
    opacity: 0;
    transform: translate3d(-50%, -50%, 0) scale(calc(var(--overlay-scale, 1) * 0.5));
  }
  6% {
    opacity: 1;
    transform: translate3d(-50%, -50%, 0) scale(calc(var(--overlay-scale, 1) * 1.12));
  }
  14% {
    opacity: 1;
    transform: translate3d(-50%, -50%, 0) scale(var(--overlay-scale, 1));
  }
  50% {
    opacity: 1;
    transform: translate3d(-50%, calc(-50% - 6px), 0) scale(calc(var(--overlay-scale, 1) * 1.03));
  }
  75% {
    opacity: 0.8;
    transform: translate3d(-50%, calc(-50% - 16px), 0) scale(calc(var(--overlay-scale, 1) * 1.06));
  }
  100% {
    opacity: 0;
    transform: translate3d(-50%, calc(-50% - 30px), 0) scale(calc(var(--overlay-scale, 1) * 1.12));
  }
}

/* ── BUG-7: Interact Mode panel slide transitions ── */

.panel-slide-enter-active,
.panel-slide-leave-active {
  transition: opacity 0.2s ease, transform 0.22s cubic-bezier(0.4, 0, 0.2, 1);
}

.panel-slide-enter-from,
.panel-slide-leave-to {
  opacity: 0;
  transform: translateY(12px);
}

/* Low quality: disable panel slide animation */
.root[data-quality='low'] .panel-slide-enter-active,
.root[data-quality='low'] .panel-slide-leave-active {
  transition: none;
}
