# Seeds (RU): Проектирование сообщества и генерация фикстур

Эта папка содержит **seed-документы** — человекочитаемые спецификации того, *каким мы хотим видеть* демо‑сообщество: участники, экономические роли, набор `equivalents` и ожидаемые паттерны направленности `trustlines`. На основе seed‑документа создаются **детерминированные fixtures** для Admin UI.

## Содержание
1. [Что такое seed-документ](#что-такое-seed-документ)
2. [Доступные seeds](#доступные-seeds)
3. [TrustLine Direction Rule](#trustline-direction-rule)
4. [Role-Based TrustLine Patterns](#role-based-trustline-patterns)
5. [Clearing Cycles](#clearing-cycles)
6. [Создание нового seed](#создание-нового-seed)
7. [Разработка генератора](#разработка-генератора)
8. [Fixture Generation Workflow](#fixture-generation-workflow)
9. [Quality Checklist](#quality-checklist)
10. [Anti-Patterns](#anti-patterns)

## Что такое seed-документ

Seed‑документ — это:
- **Human-readable спецификация** модели сообщества (как «маркетинговая история» превращается в граф).
- «Контракт» между: полевой/маркетинговой интуицией ↔ семантикой протокола ↔ поведением демо UI.
- Источник истины про *почему* у графа именно такая форма (а не просто «вышел красивый граф»).

Seed‑документ — это НЕ:
- копия JSON‑fixtures;
- случайный список имён;
- «красивая диаграмма», которая игнорирует экономическую направленность `trustlines`.

Практическая цель seed‑документа: дать разработчику (и будущему генератору) ответы на вопросы:
- какие роли существуют и *какие отношения* между ними типичны;
- кто чаще является кредитором, а кто — должником;
- где должны появляться «мосты»/хабы;
- какие циклы клиринга должны быть возможны и экономически правдоподобны.

## Доступные seeds

| Seed | Участников | Основная тема | Equivalents | Что посмотреть в первую очередь | Генератор |
|------|-----------:|---------------|-------------|----------------------------------|----------|
| [seed-greenfield-village-100.md](seed-greenfield-village-100.md) | 100 | «Село/громада» (кооператив, склад, закупка, рынок, пекарня, сервисы) | `UAH`, `EUR`, `HOUR` | Разделы про экономическую логику и degree‑summary | `admin-fixtures/tools/generate_seed_greenfield_village_100.py` |
| [seed-riverside-town-50.md](seed-riverside-town-50.md) | 50 | «Приречный городок» (рыболовство, порт/кооп, рынок, сервисы в `HOUR`) | `UAH`, `EUR`, `HOUR` | Разделы `Economic Logic`, `Clearing Cycles Examples` | (пока нет, seed‑документ как спецификация) |

## TrustLine Direction Rule

### Ключевое правило направления

```
from → to = from (кредитор) разрешает to (должнику) быть должным (в рамках лимита)
```

`trustline` — это **directed risk limit**:
- `from → to` означает: **from — creditor**, **to может стать debtor**.
- Владелец/подписант `trustline` — это `from`, потому что именно он принимает риск.

Важно не путать `trustline` и `debt`:
- `trustline[from → to, E]` — лимит риска (политика), который позволяет `to` уйти «в минус» перед `from`.
- `debt[debtor → creditor, E]` — фактическая задолженность (может меняться платежами/клирингом).

В Admin UI на `/graph` сейчас визуализируются **`trustlines`** (лимиты/политики), а не «живые» `debts`.

Инвариант протокольной семантики:
- `debt[to → from, E] ≤ limit(from → to, E)`

### Мнемоника (как быстро проверять направление)

1) Сформулируй «кто кому должен» в реальном сценарии.
2) Стрелка `trustline` всегда идёт **от того, кому должны → к тому, кто будет должен**.

Пример: «домохозяйство купило в магазине в долг» → *домохозяйство должно магазину* → значит `shop → household`.

### Базовые примеры (экономические сценарии)

| Сценарий | Кто кредитор (берёт риск) | Кто должник | Правильное направление `trustline` | Typical `equivalent` |
|----------|----------------------------|-------------|-------------------------------------|----------------------|
| Розница продаёт в долг домохозяйству | retail/shop | household | `retail → household` | `UAH` |
| Производитель отгружает товар с отсрочкой | producer/supplier | buyer (retail/procurement/bakery) | `producer → buyer` | `UAH` |
| Закупщик/кооп даёт аванс производителю | buyer/procurement | producer | `procurement → producer` | `UAH` |
| Услуга «сейчас, оплата потом» | service | client | `service → client` | `HOUR` (или `UAH`) |
| Хабы дают взаимную ликвидность | hub | hub | `hub ↔ hub` (две `trustlines`) | `UAH` / `EUR` |

### Частая ошибка: путать направление платежа и направление `trustline`

Платёж обычно идёт **от должника к кредитору**. Поэтому направление платежа чаще всего *противоположно* направлению `trustline`.

```
Payment:  debtor  ─────► creditor
TL:       creditor ─────► debtor
```

### Что именно рискует кредитор

Кредитор (`from`) рискует тем, что должник (`to`):
- не погасит долг вовремя;
- уйдёт в отрицательный баланс (в рамках лимита);
- создаст необходимость клиринга/маршрутизации для взаимозачёта.

Отсюда правило дизайна: `trustlines` должны отражать *реальные коммерческие отношения*, а не «соединить всех со всеми ради связности графа».

## Role-Based TrustLine Patterns

Ниже — базовая матрица для проверки направления и «формы» графа. В терминах степени:
- **исходящие TL** — где роль чаще выступает кредитором (она «раздаёт лимиты»);
- **входящие TL** — где роль чаще выступает должником (ей «раздают лимиты»).

| Роль | Входящие TL | Исходящие TL | Основной эквивалент |
|------|-------------|--------------|---------------------|
| Производитель | Мало (от закупщика-аванс) | Много (к закупке/рознице) | UAH |
| Розница | Мало (от поставщиков) | Много (к домохозяйствам) | UAH |
| Услуги | Минимум | Много (к клиентам) | HOUR |
| Домохозяйство | Много (от магазинов/услуг) | Мало (обратные услуги) | UAH + HOUR |
| Якорь/Хаб | Много | Много | UAH |

Практическая интерпретация:
- «Много»/«мало» — это про *структуру*, а не про точные числа: важно, чтобы в визуализации на `/graph` роль выглядела ожидаемо.
- Для `Домохозяйств` нормален небольшой процент «обратных» `trustlines` в `HOUR` (взаимные услуги), но **не** массовые `household → retail`.

## Clearing Cycles

### Что такое клиринговый цикл

Клиринг (clearing) возможен, когда существует **цикл долгов**: каждый участник в цепочке кому‑то должен, и одновременно кому‑то должен другой участник.

Важно: seed‑документы в первую очередь описывают `trustlines` (лимиты), но при моделировании и объяснении клиринга мы мысленно переходим к `debts`.

**Идея клиринга**: если есть цикл долгов, то можно взаимно уменьшить долги вдоль цикла на одну и ту же величину `k`, где:

```
k = min(debt(edge_1), debt(edge_2), ... debt(edge_n))
```

Тогда каждое ребро долга в цикле уменьшается на `k`, и как минимум одно ребро становится нулевым.

### Пример 1: базовый цикл из 3 узлов

Сценарий (типичный для локальной экономики):
- домохозяйство покупает в рознице «в долг»;
- розница покупает у производителя «в долг»;
- производитель покупает услугу/товар у домохозяйства/агента (или тратит в рознице), формируя замыкание.

Пусть фактические долги таковы (в `UAH`):
- `debt[Retail → Producer] = 1500`
- `debt[Household → Retail] = 1800`
- `debt[Producer → Household] = 2000`

Тогда клиринг по циклу уменьшит каждый долг на `k = min(1500, 1800, 2000) = 1500`.

### Пример 2: почему циклы должны быть правдоподобны

Хороший цикл:
- отражает цепочку поставок/потребления;
- не требует «магических» отношений (например, чтобы все домохозяйства кредитовали завод).

Плохой цикл:
- существует только потому, что генератор добавил случайные `trustlines` для связности;
- доминирует один узел‑«пылесос», через который вынуждено проходит всё.

### Рекомендации по длине циклов

- Циклы длиной **3–6** обычно лучше всего объясняются и визуализируются.
- Слишком длинные циклы хуже воспринимаются и могут создавать неочевидные эффекты в маршрутизации.

## Создание нового seed

Ниже — практическая процедура, которая помогает сделать seed‑документ пригодным для генератора, тестов и демо.

### 1) Выбор тематики и размера

Определи:
- тему (экономику): «село», «рыболовство», «строительство», «образование», «туризм», и т.д.;
- размер: 30/50/100 участников;
- частоту типичных операций: ежедневная/еженедельная;
- какие `equivalents` реально нужны (по умолчанию — `UAH-first`, `EUR` минимально, `HOUR` там, где есть услуги/таймбанк).

### 2) Определение якорей (anchors/hubs)

Якоря — это узлы с высокой связностью, которые:
- связывают кластеры;
- помогают формировать циклы;
- иногда дают двустороннюю ликвидность между собой.

Практические ориентиры:
- 3–5 хабов на 50 участников;
- 5–10 хабов на 100 участников;
- обязательно хотя бы один «мост» между кластерами (иначе будут несвязные компоненты).

### 3) Распределение участников по ролям

Сначала опиши роли и ожидаемую «форму» (`few vs many`):
- **few suppliers / many buyers** (розница, пекарня);
- **many suppliers / few buyers** (закупка/агрегатор);
- **hub** (кооп/склад/порт).

Затем распредели участников по ролям так, чтобы:
- роли были представлены осмысленными долями;
- у каждой роли были «естественные» контрагенты;
- присутствовали мосты и хабы.

### 4) Задание направлений TL

Пройди по ключевым сценариям и проверь направление по правилу:

```
creditor → debtor
```

Практический лайфхак: для каждой пары ролей выпиши 1–2 «истории сделки» (кто кому должен после сделки), и только потом добавляй `trustlines`.

### 5) Проверка циклов

Сделай минимум 2–5 целевых клиринговых циклов:
- выпиши цикл словами (экономическая история);
- зафиксируй роли и `equivalent`;
- убедись, что цикл может возникнуть *из реальных сценариев*, а не из случайной связности.

## Разработка генератора

Генератор — это детерминированный скрипт, который по seed‑логике строит canonical fixtures (participants/equivalents/trustlines/…).

Рекомендованный путь:

1) Возьми за основу существующий генератор:
- `admin-fixtures/tools/generate_seed_greenfield_village_100.py`

2) Создай новый файл вида:
- `admin-fixtures/tools/generate_seed_<your_seed_name>.py`

3) Требования к генератору:
- **Детерминизм**: одинаковый вход → одинаковый JSON (включая порядок элементов).
- **Стабильные идентификаторы**: `pid`/`id` должны генерироваться повторяемо (без `random`/`uuid4` без фиксированного seed).
- **Стабильная сортировка**: не полагаться на порядок `dict` из неочевидных источников.
- **Контроль дублей**: запрет дубликатов `(equivalent, from, to)`.
- **Экономическая семантика**: направления `trustlines` должны соответствовать seed‑документу.

4) Что должен записывать генератор (минимум для Admin UI):
- `admin-fixtures/v1/datasets/participants.json`
- `admin-fixtures/v1/datasets/equivalents.json`
- `admin-fixtures/v1/datasets/trustlines.json`

Опционально (если UI/сценарии используют):
- `admin-fixtures/v1/datasets/incidents.json`

## Fixture Generation Workflow

### Canonical fixtures

Источник истины (JSON) живёт в:
- `admin-fixtures/v1/datasets/*.json`

### Public fixtures для Admin UI

Копия, используемая UI во время разработки/демо:
- `admin-ui/public/admin-fixtures/v1/datasets/*.json`

Она перезаписывается скриптом синхронизации:
- `admin-ui/scripts/sync-fixtures.mjs`

### Как регенерировать

1) Запусти детерминированный генератор (пример):

```bash
python admin-fixtures/tools/generate_seed_greenfield_village_100.py
```

2) Синхронизируй и провалидируй fixtures для UI:

```bash
cd admin-ui
npm run sync:fixtures
npm run validate:fixtures
```

Notes:
- `npm run dev` запускает `predev`, который автоматически делает sync+validate.

## Quality Checklist

Чеклист для ревью seed‑документа и результата генерации.

### Seed-документ (спецификация)

- Ясно описана экономическая «история» и зачем этот seed нужен (демо/тест).
- Роли определены, для каждой роли понятно `few vs many` и ключевые контрагенты.
- `equivalents` выбраны осмысленно (`UAH-first`, `EUR` минимально, `HOUR` там, где есть услуги).
- Зафиксировано правило направления `trustlines` и примеры по ролям.
- Есть минимум 2–5 правдоподобных циклов клиринга (3–6 узлов).

### Fixtures/Graph (результат генератора)

- Детерминированный output (одинаковый запуск → одинаковый JSON контент и порядок).
- Количества совпадают ожиданиям (например, 50/100 участников).
- Нет дубликатов `trustlines` для `(equivalent, from, to)`.
- Направления `trustlines` экономически согласованы с ролями (см. таблицу выше).
- В графе нет «изолированных» кластеров без мостов (если это не задумано специально).
- Хабы действительно имеют «много ↔ много» и связывают кластеры.
- Домохозяйства чаще должники, чем кредиторы (за исключением небольших `HOUR`‑обменов/взаимопомощи).
- `EUR` не доминирует (если нет отдельной цели тестировать multi‑equivalent routing).

## Anti-Patterns

Типичные ошибки при проектировании seeds и генераторов.

1) **Перепутанное направление `trustline`**
- Симптом: «должники кредитуют кредиторов» (например, `household → retail` в `UAH` массово).
- Как избежать: для каждого ребра проговорить «кто кому должен после сделки» и применить `creditor → debtor`.

2) **Случайный граф ради связности**
- Симптом: много ребёр без экономического смысла; циклы появляются «случайно».
- Как избежать: сначала описать 10–20 реальных отношений (ролями), потом масштабировать.

3) **Все `trustlines` взаимные по умолчанию**
- Симптом: граф выглядит «симметричным», но экономически нечитабельным.
- Как избежать: взаимность оставить в основном для `anchors/hubs` и редких случаев реципрокности.

4) **Нет циклов клиринга (или они слишком длинные)**
- Симптом: клиринг нечего объяснять; маршрутизация выглядит «плоской».
- Как избежать: целенаправленно заложить 2–5 циклов длиной 3–6.

5) **Слишком много `equivalents` / неправильные пропорции**
- Симптом: `EUR`/`HOUR` заполняют граф и мешают читать основную экономику.
- Как избежать: `UAH-first`, остальные эквиваленты — только там, где есть смысл и демонстрационная цель.

6) **Нестабильный генератор (diff-noise)**
- Симптом: каждый запуск меняет порядок/значения без изменений логики.
- Как избежать: фиксированные источники времени, стабильная сортировка, отсутствие недетерминированных идентификаторов.
