# GEOv0-PROJECT — тестовые сценарии MVP (v0.1)

**Цель:** дать воспроизводимый набор сценариев для проверки MVP «сквозняком» и для будущей автоматизации (e2e/интеграционные тесты).

Формат сценария:

- **ID**
- **Название**
- **Предусловия**
- **Шаги**
- **Ожидаемый результат**
- **Проверки инвариантов / примечания**

---

## 0. Общие обозначения

Участники:

- Alice = `PID_ALICE`
- Bob = `PID_BOB`
- Carol = `PID_CAROL`
- Dave = `PID_DAVE`

Эквивалент:

- `UAH` (precision 2)

Под «балансом» подразумеваются значения, доступные через API баланса и историю платежей/транзакций.

---

## 1. Онбординг и идентичность

### TS-01. Регистрация нового участника (с ключами Ed25519)

**Предусловия:** нет

**Шаги:**
1. Клиент генерирует keypair Ed25519.
2. Клиент отправляет регистрацию (с подписью согласно протоколу).
3. Получает `pid` и профиль.

**Ожидаемый результат:**
- Участник создан со статусом `active`.
- Публичный ключ сохранён.
- При повторной отправке того же запроса с тем же `tx_id` — идемпотентность (нет дубля).

**Проверки:** подписи, дрейф времени, idempotency.

### TS-02. Логин (получение JWT) и доступ к защищённым endpoint

**Предусловия:** `PID_ALICE` зарегистрирован

**Шаги:**
1. Alice проходит challenge-response.
2. Получает JWT.
3. Запрашивает `/balance`.

**Ожидаемый результат:**
- JWT действителен.
- `/balance` возвращает корректную структуру.

### TS-03. Истечение JWT и refresh

**Предусловия:** `PID_ALICE` авторизован

**Шаги:**
1. Дождаться истечения access token.
2. Повторить запрос.
3. Использовать refresh.

**Ожидаемый результат:**
- Сервис возвращает 401 для истёкшего access token.
- Refresh выдаёт новый access token.

---

## 2. Участники и профили

### TS-04. Поиск участника по части имени / фильтрам

**Предусловия:** создано ≥ 3 участников

**Шаги:**
1. Выполнить поиск по query.
2. Применить фильтр `type`.

**Ожидаемый результат:**
- Результаты ограничены `limit`.
- Фильтр корректен.

---

## 3. TrustLines

### TS-05. Создать trustline Alice → Bob

**Предусловия:** Alice и Bob зарегистрированы

**Шаги:**
1. Alice создаёт trustline к Bob с `limit=1000.00 UAH` и подписью.

**Ожидаемый результат:**
- Trustline создан.
- `used=0.00`.
- Повтор запроса с тем же `tx_id` не создаёт дубль.

### TS-06. Обновить trustline Alice → Bob (увеличить limit)

**Предусловия:** trustline Alice → Bob существует

**Шаги:**
1. Alice обновляет limit до 1500.00.

**Ожидаемый результат:**
- Новый limit применён.
- Инварианты сохранены.

### TS-07. Попытка уменьшить limit ниже текущего `used`

**Предусловия:** есть долг по линии Alice→Bob (used>0)

**Шаги:**
1. Alice пытается установить `limit < used`.

**Ожидаемый результат:**
- Операция отклонена (ошибка доменная/HTTP корректно).

### TS-08. Закрыть trustline при `used=0`

**Предусловия:** trustline Alice → Bob существует, `used=0`

**Шаги:**
1. Alice закрывает trustline.

**Ожидаемый результат:**
- Trustline закрыт/удалён согласно правилам.
- В истории отражено событие.

### TS-09. Закрыть trustline при `used>0`

**Предусловия:** trustline Alice → Bob существует, `used>0`

**Шаги:**
1. Alice закрывает trustline.

**Ожидаемый результат:**
- Операция отклонена.

---

## 4. Платежи: capacity, max-flow, single-path

### TS-10. Проверить ёмкость на конкретную сумму (capacity)

**Предусловия:** есть путь Alice → Bob с доступной ёмкостью ≥ 100.00

**Шаги:**
1. Alice вызывает `GET /payments/capacity?to=PID_BOB&equivalent=UAH&amount=100.00`.

**Ожидаемый результат:**
- `can_pay=true`.
- `max_amount` ≥ 100.00.
- `routes_count` и `estimated_hops` разумны.

### TS-11. Рассчитать максимальный платёж (max-flow)

**Предусловия:** граф trustlines создан

**Шаги:**
1. Alice вызывает `GET /payments/max-flow?to=PID_BOB&equivalent=UAH`.

**Ожидаемый результат:**
- `max_amount` соответствует оценке алгоритма.
- `paths` и `bottlenecks` присутствуют и непротиворечивы.

### TS-12. Создать платёж single-path (успех)

**Предусловия:** ёмкость маршрута ≥ сумма

**Шаги:**
1. Alice делает `POST /payments` на 100.00.

**Ожидаемый результат:**
- `status=COMMITTED`.
- В `routes` 1 путь с amount=100.00.
- Балансы/used пересчитаны корректно.

### TS-13. Создать платёж single-path (недостаточная ёмкость)

**Предусловия:** ёмкость < сумма

**Шаги:**
1. Alice делает `POST /payments` на 100.00 при доступных 50.00.

**Ожидаемый результат:**
- `status=ABORTED`.
- Ошибка `Insufficient capacity`, `requested` и `available` корректны.

---

## 5. Платежи: limited multipath (2–3 маршрута)

### TS-14. Платёж multipath: сумма делится на 2 маршрута

**Предусловия:** есть 2 независимых маршрута суммарной ёмкостью ≥ сумма

**Шаги:**
1. Alice делает `POST /payments` на 120.00.

**Ожидаемый результат:**
- `status=COMMITTED`.
- `routes` содержит 2 маршрута.
- Сумма маршрутов = 120.00.
- Инварианты соблюдены.

### TS-15. Платёж multipath: 3 маршрута (limit max_paths_per_payment)

**Предусловия:** включён limited multipath; доступно 3 маршрута

**Шаги:**
1. Alice делает платеж на сумму, требующую 3 маршрута.

**Ожидаемый результат:**
- `routes` ≤ `max_paths_per_payment`.
- Если требуется >3, платеж должен быть отклонён или частично невозможен согласно policy (в MVP — отклонение).

---

## 6. Эксперимент: full multipath (feature flag)

### TS-16. Включить full multipath и повторить max-flow

**Предусловия:** доступ к админке, включение `feature_flags.full_multipath_enabled`

**Шаги:**
1. В админке включить флаг.
2. Alice вызывает `GET /payments/max-flow`.

**Ожидаемый результат:**
- `algorithm` отражает включенный режим (например `full_multipath`).
- `max_amount` может увеличиться (не обязано), но контракт сохранён.

---

## 7. Клиринг

### TS-17. Автоматический клиринг цикла длины 3

**Предусловия:** сформирован цикл долгов длины 3

**Шаги:**
1. Создать долги, образующие цикл A→B→C→A.
2. Дождаться триггерного клиринга.

**Ожидаемый результат:**
- Долги уменьшены/обнулены согласно клирингу.
- Событие отражено в истории.

### TS-18. Влияние параметра trigger_cycles_max_length

**Предусловия:** есть цикл длины 5

**Шаги:**
1. Установить `clearing.trigger_cycles_max_length=4`.
2. Убедиться, что цикл 5 не клирится триггерно.
3. Включить периодический поиск 5.
4. Убедиться, что цикл 5 клирится периодически.

**Ожидаемый результат:**
- Поведение соответствует конфигу.

---

## 8. WebSocket

### TS-19. Подписка на события и получение уведомления о платеже

**Предусловия:** WS доступен, Alice подписана

**Шаги:**
1. Alice подписывается на `payment.received`.
2. Bob выполняет платеж в пользу Alice.

**Ожидаемый результат:**
- Alice получает WS событие.
- Событие соответствует схеме.

---

## 9. Оператор/админка (минимум)

### TS-20. Freeze участника и запрет операций

**Предусловия:** есть админ доступ, Bob активен

**Шаги:**
1. Админ делает freeze Bob.
2. Bob пытается создать платеж или trustline.

**Ожидаемый результат:**
- Операция отклонена.
- Audit log содержит запись о freeze и о попытке операции.

### TS-21. Изменение параметров в админке: max_paths_per_payment

**Предусловия:** доступ к админке

**Шаги:**
1. Изменить `routing.max_paths_per_payment` на 2.
2. Выполнить сценарий TS-15.

**Ожидаемый результат:**
- Теперь `routes` ≤ 2.
- Audit log фиксирует изменение.

---

## 10. Надёжность и идемпотентность

### TS-22. Повтор POST /payments с тем же tx_id (ретрай)

**Предусловия:** сеть/клиент имитируют повтор

**Шаги:**
1. Отправить платеж.
2. Повторить тот же запрос с тем же `tx_id`.

**Ожидаемый результат:**
- Нет дубликатов.
- Ответ консистентный.

### TS-23. Одновременные платежи на одном узком месте (конкурентность)

**Предусловия:** ограниченная ёмкость

**Шаги:**
1. Запустить 2 платежа параллельно, которые конкурируют за одну линию доверия.

**Ожидаемый результат:**
- Один может закоммититься, другой должен получить корректную ошибку/abort.
- Инварианты соблюдены.

---

## 11. Топ-5 сценариев для минимального e2e набора

- TS-01 Регистрация
- TS-05 Создание trustline
- TS-12 Платёж single-path success
- TS-14 Платёж multipath 2 пути
- TS-17 Автоматический клиринг цикла длины 3