# Незавершённые спеки (RU)

Этот список фиксирует **незавершённые** элементы из активных спецификаций в `docs/ru/admin/specs/`.

## Admin UI

Источник: [docs/ru/admin/specs/admin-ui-spec.md](admin-ui-spec.md)

Незавершённые элементы (Phase 2 / optional):
- `Events` (timeline)
- `Transactions / Clearing` (глобальные списки)
- `Liquidity analytics`

Ниже — пояснение: **что это**, **зачем**, **какие зависимости** (данные/API), и какой **минимальный срез** имеет смысл делать первым.

---

## 1) Events (timeline)

### Что это (функционал)
Единая «лента событий» для расследований и операционного контроля.

Типовые сценарии:
- Оператор открывает подозрительную ситуацию (инцидент, спор, ошибка клиринга) и хочет видеть **таймлайн**: что и когда происходило.
- По `tx_id` нужно увидеть последовательность шагов (routing → prepare → ack → commit/abort), включая причины abort и ретраи.
- По `participant_pid` нужно увидеть «след активности» участника: входящие/исходящие операции, изменения статуса, trustline-изменения.

Ожидаемый UI-срез:
- Экран/вкладка `Events`.
- Фильтры: `event_type`, `tx_id`, `participant_pid`, `run_id`, `scenario_id`, диапазон дат.
- Представления: таблица (как минимум) + (опционально) визуальный таймлайн.
- Drill-down: просмотр raw JSON payload события (чтобы не терять детали).

### Зачем это нужно
- **Расследования и дебаг**: audit-log фиксирует «мутации», но для 2PC/routing важно видеть «процесс» и промежуточные шаги.
- **Поддержка тестов**: для e2e удобно связывать артефакты прогонов с серверными событиями через `run_id/scenario_id`.
- **Операционная прозрачность**: быстро понять, что сломалось (timeout, conflict, insufficient capacity) без доступа к БД/логам.

### Зависимости (данные/API)
- Нужен устойчивый источник событий:
	- либо отдельная таблица/стрим `domain_events`,
	- либо расширенный audit-log, который включает не только «изменения сущностей», но и «шаги процесса».
- Нужны стабильные correlation-id: `tx_id`, `request_id`, `run_id`, `scenario_id`.
- Нужен endpoint уровня `GET /admin/events` (или аналог) с пагинацией и фильтрами.

### Минимальный срез (предложение)
- Начать с **read-only таблицы** событий, без красивого таймлайна.
- Источник на первом шаге: «события транзакции» для `PAYMENT/CLEARING` + «операторские события» (freeze/unfreeze, config changes).
- Acceptance criteria:
	- фильтр по `tx_id` даёт полный упорядоченный список шагов;
	- любое событие открывается в raw JSON;
	- события можно связать с тестовым прогоном (`run_id/scenario_id`).

---

## 2) Transactions / Clearing (глобальные списки)

### Что это (функционал)
Глобальный реестр транзакций с поиском и деталями:
- `Transactions`: список всех транзакций (минимум: `PAYMENT`, `CLEARING`; в будущем — прочие типы).
- `Clearing`: либо отдельный список, либо пред-фильтрованный вид `Transactions`.

Ожидаемый UI-срез:
- Таблица с фильтрами: `tx_id`, `type`, `state`, `equivalent`, `initiator_pid`, диапазон дат.
- Карточка транзакции: payload, текущий state, ошибки, (опционально) маршруты/подписи.
- Переходы из других экранов: из `Incidents` и `Events` — по `tx_id`.

### Зачем это нужно
- **Операционная поддержка**: “найти транзакцию по id и понять статус” — базовая потребность оператора.
- **Связка с инцидентами**: инцидентам нужна навигация к первоисточнику (tx details).
- **Аудит**: единый журнал транзакций полезен для «что произошло вчера/за период».

### Зависимости (данные/API)
- Нужен стабильный контракт для списка:
	- `GET /admin/transactions?page&per_page&filters...` (или эквивалент),
	- плюс `GET /admin/transactions/{tx_id}`.
- Важно заранее определить, что является «истиной» по состояниям:
	- что такое `PREPARED`, `PREPARE_IN_PROGRESS`, когда и кем они выставляются,
	- как показывать «частичные» состояния (например, есть ACK-и не от всех).

### Минимальный срез (предложение)
- Сначала сделать **единый экран `Transactions`**, а `Clearing` — как сохранённый фильтр `type=CLEARING`.
- Полевая модель на первом шаге: только то, что реально хранится в БД сейчас (не выдумывать). Если деталей нет — показывать «not available».
- Acceptance criteria:
	- поиск по `tx_id` работает мгновенно и даёт детальный просмотр;
	- фильтр по `state/type/equivalent/date`;
	- ссылки на транзакцию используются из `Incidents`.

---

## 3) Liquidity analytics

### Что это (функционал)
Набор агрегированных метрик и «срезов» по ликвидности сети доверия, чтобы понимать:
- где узкие места (bottlenecks) и кто создаёт/испытывает дефицит кредитного лимита;
- насколько эффективно работает клиринг;
- как меняется нагрузка/оборот по эквивалентам.

Примеры UI-виджетов/таблиц (ориентировочно):
- Top bottleneck edges (минимальный `available/limit`), топ участников по net position.
- Distribution/HHI концентрации по эквиваленту.
- Churn (изменчивость доверия/долгов) за 7/30/90 дней.
- Эффективность клиринга: найдено циклов vs применено, суммарно «снято» долга.

### Зачем это нужно
- **Управление сетью**: оператору важно видеть системные проблемы до инцидентов.
- **Пилот и экономика сообщества**: метрики помогают объяснять участникам, почему «не проходит платёж» (потому что ликвидность зажата в сегменте).
- **Оптимизация параметров**: помогает калибровать `routing.*`, `limits.*`, `clearing.*` по фактам.

### Почему это Phase 2
Аналитика обычно требует:
- агрегаций, денормализации или отдельного вычислительного пайплайна;
- временных окон и историчности (а не только «снимок сейчас»);
- аккуратной работы с decimal и большим объёмом данных.

### Зависимости (данные/API)
- Нужны источники данных:
	- либо materialized views/агрегаты в БД,
	- либо отдельный сервис/джоб, считающий метрики по расписанию.
- Нужны endpoints наподобие `GET /admin/analytics/liquidity?...` с чёткими схемами.
- Нужна договорённость по историчности: какие метрики «сейчас», какие «за период».

### Минимальный срез (предложение)

Важное уточнение позиционирования (чтобы не было дублирования):
- `Liquidity analytics` в **главном меню** = «ситуационный центр / триаж» (overview + watchlist + советы оператору).
- `Graph` и `Trustlines` = **drill-down** и расследование конкретных узлов/рёбер.

Минимальный срез (MVP) стоит начинать со **snapshot-аналитики без истории** и без новых API:
- источник данных: уже существующий snapshot графа (`/api/v1/admin/graph/snapshot`, в mock режиме — fixtures);
- расчёты: детерминированные, decimal-safe (без float), чтобы метрики воспроизводились.

Acceptance criteria (MVP):
- UI явно показывает, что это «Snapshot» (снимок), а не временной ряд;
- оператор получает **короткие релевантные советы** (Operator Advice) и быстрые переходы в первоисточники:
	- `Trustlines` (узкие рёбра),
	- `Incidents` (зависшие транзакции),
	- `Graph` (визуальная диагностика),
	- `Participants` (по PID);
- метрики воспроизводимы (детерминированы на одном и том же состоянии).

### Чеклист реализации (MVP)

- [x] Добавить пункт меню `Liquidity analytics` (sidebar) + роут `/liquidity`.
- [x] Экран A (Overview, Snapshot):
	- [x] Переключатель `Equivalent` (+ значение `ALL`).
	- [x] Порог bottleneck (`threshold`) как decimal string.
	- [x] KPI: `Active trustlines`, `Bottlenecks`, `Incidents over SLA`.
	- [x] KPI: `Total limit / used / available` (суммы по активным trustlines), decimal-safe.
- [x] Экран F (Watchlist, Snapshot):
	- [x] Таблица Top bottleneck edges (active, по `available/limit < threshold`).
	- [x] Таблица Top participants by net position (из `debts`, creditor - debtor), по выбранному equivalent.
	- [x] Каждая строка кликабельна и ведёт в релевантный экран (Trustlines/Participants).
- [x] Подключить Operator Advice на экране (правила на базе snapshot):
	- [x] «Много bottlenecks» → action: открыть `Trustlines` с `threshold` (и `equivalent`, если выбран).
	- [x] «Есть incidents over SLA» → action: открыть `Incidents`.
- [x] i18n (RU/EN) + tooltip для пункта меню.
- [x] Прогнать `Admin UI: build (gates)`.

---

### Предлагаемые экраны (Phase 2)

Ниже — «меню» аналитики ликвидности. Важно: если историчности ещё нет, все экраны должны явно маркироваться как **Snapshot** (снимок на момент времени).

#### Экран A. Liquidity — Overview (Snapshot)

**Что оператор видит:**
- Переключатель `Equivalent` (UAH/EUR/HOUR).
- KPI-блоки (1 экран, без глубоких фильтров):
	- `Active trustlines` (кол-во активных рёбер),
	- `Bottlenecks` (кол-во рёбер с `available/limit < threshold`),
	- `Total limit` / `Total used` / `Total available` (агрегаты по сети, как суммы decimal),
	- `Concentration (HHI)` (если считается),
	- `Clearing efficiency` (если есть данные: найдено/применено циклов).
- Быстрые ссылки на «Top Bottlenecks» и «Top Participants».

Примечание (MVP): на первом шаге допускается показать эти блоки прямо на одном экране `Liquidity analytics`, без разведения на отдельные страницы.

**Чем полезно:**
- Даёт оператору «пульс сети»: есть ли системная нехватка кредитного лимита и где она концентрируется.

**Какие решения поддерживает:**
- Нужно ли вмешательство оператора прямо сейчас (например, слишком много bottleneck-ребёр → вероятны массовые отказы платежей).
- Нужно ли менять runtime-параметры routing/clearing (например, если bottlenecks растут и клиринг не помогает).
- Приоритизация расследований: какой equivalent «горит».

---

#### Экран B. Bottlenecks — Edges list (Snapshot)

**Что оператор видит:**
- Таблица «узких мест» по рёбрам trustline (creditor→debtor):
	- `equivalent`, `creditor`, `debtor`, `limit`, `used`, `available`,
	- `available/limit` (как рациональное отношение из decimal string, без float),
	- `status`, `updated_at/created_at`.
- Фильтры: `equivalent`, `threshold`, `participant` (как creditor или debtor), `status`.
- Действия: перейти в карточку ребра / открыть drawer связи (как в графе), «показать соседние рёбра».

**Чем полезно:**
- Самый практичный экран для оператора: показывает, какие конкретно ограничения «душат» сеть.

**Какие решения поддерживает:**
- Кого нужно попросить повысить лимит/разблокировать доверие (если это социально/процессно возможно).
- Где ожидать отказы платежей и какие участники пострадают первыми.
- Нужна ли локальная «операторская кампания» по увеличению лимитов в сегменте сети.

---

#### Экран C. Participants — Net position & counterparties (Snapshot)

**Что оператор видит:**
- Таблица участников с финансовым «положением» по выбранному equivalent:
	- `net_position` (кредиторская позиция минус дебиторская),
	- `total_receivable` / `total_payable` (агрегаты по debts),
	- `degree`/`connections` (кол-во активных рёбер),
	- `bottleneck_edges_count` (сколько узких рёбер инцидентно связано с участником).
- Drill-down участника:
	- Top counterparties (кому должен / кто должен ему),
	- «узкие связи» участника (edges),
	- быстрые переходы в `Trustlines`, `Events`, `Transactions`.

**Чем полезно:**
- Помогает понимать, кто является «поставщиком ликвидности», а кто — «поглотителем»; где могут возникать каскадные отказы.

**Какие решения поддерживает:**
- С кем работать при «разморозке ликвидности»: участники с большой кредиторской позицией могут повысить лимиты/разрешить промежуточность.
- Кого мониторить как потенциальный источник стресса (большая дебиторская позиция + много bottlenecks).
- Нужно ли корректировать политики (например, `can_be_intermediate`, блок-листы) для ключевых узлов.

---

#### Экран D. Concentration & inequality (Equivalent lens)

**Что оператор видит:**
- Индексы концентрации по equivalent:
	- `HHI` по распределению net position,
	- топ-1/топ-5 доля, optionally Gini (если договоримся).
- Распределения (как минимум таблично):
	- топ участников по доле оборота/позиции,
	- «длинный хвост».

**Чем полезно:**
- Объясняет структурный риск: если ликвидность концентрируется у малого числа узлов, сеть хрупкая.

**Какие решения поддерживает:**
- Нужны ли меры по диверсификации (стимулировать больше взаимных trustlines, снижать зависимость от одного «центра»).
- Стоит ли ограничивать роль «хаба-участника» (политики/социальные правила сообщества), если концентрация слишком высока.

---

#### Экран E. Clearing impact (если clearing включён)

**Что оператор видит:**
- Сводка клиринга по equivalent:
	- `cycles_found`, `cycles_applied`,
	- `total_debt_reduced` (сколько долга снято),
	- распределение по длине цикла (3/4/5/6),
	- список последних клиринговых транзакций с результатом.
- Связь с bottlenecks:
	- «сколько bottleneck-рёбер стало нормальными после клиринга» (если считаем).

**Чем полезно:**
- Показывает, помогает ли клиринг «разжимать» сеть или он срабатывает редко/неэффективно.

**Какие решения поддерживает:**
- Нужно ли менять параметры клиринга (частоту, максимальную длину циклов, правила автосогласия).
- Нужно ли усиливать процесс согласия участников (если много reject/abort).
- Стоит ли временно выключить клиринг (если он создаёт нагрузку/конфликты без эффекта).

---

#### Экран F. Alerts / Watchlist (операторский список наблюдения)

**Что оператор видит:**
- Автоматически собранный список «красных флагов» (по правилам):
	- участники с резким ростом bottleneck-связей,
	- рёбра, которые долго держатся ниже threshold,
	- сегменты сети с плохой связностью (если считаем компоненты/изоляторы),
	- рост количества abort по недостатку доступного кредита (если есть Events/Transactions).
- Каждая строка — кликабельна и ведёт в соответствующий экран.

Примечание (MVP): если историчности ещё нет, «alerts» строятся только из snapshot (без «долго держится ниже threshold»).

**Чем полезно:**
- Делает аналитику рабочим инструментом: оператору не нужно «искать проблему глазами».

**Какие решения поддерживает:**
- Приоритизация задач оператора (кого/что смотреть первым).
- Раннее предотвращение инцидентов (вмешательство до массовых отказов платежей).

---

### Принципиальные требования к UI (важно для всех экранов)

- Все суммы/лимиты/доли считаются из **decimal string** и отображаются без float-ошибок.
- Для trustline всегда помнить направление: `from → to` = creditor → debtor; долги — в обратном направлении.
- Явно маркировать источник: **Snapshot** vs **Period** (если появится история).

Примечание: разделы со статусом «Phase 2» считаются требованиями к будущему и не обязаны быть реализованы в текущем MVP.
