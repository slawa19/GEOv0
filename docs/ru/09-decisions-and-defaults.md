# GEO v0.1 — ключевые решения и дефолты MVP

**Версия:** 0.1  
**Дата:** Декабрь 2025

Краткая сводка ключевых архитектурных решений и рекомендуемых дефолтов для MVP.

---

## 1. Ключевые решения MVP

### 1.1. Архитектура и узлы

| Решение | Выбор для MVP |
|---------|---------------|
| **Модель узлов** | Hub-центричная (участник = аккаунт в hub) |
| **Подпись операций** | Обязательная на стороне клиента (Ed25519) |
| **Координация 2PC** | Сервер hub (состояние + транзакционные блокировки в БД) |
| **Primary клиент** | PWA (Web Client) |
| **Мобильный/десктоп** | Flutter — отложено до v1.0+ |

### 1.2. Клиринг

| Решение | Выбор для MVP |
|---------|---------------|
| **Режим** | Автоматический (по расписанию + по триггерам) |
| **Согласие участников** | По умолчанию `auto_clearing: true` в TrustLine policy |
| **Длина циклов (триггерный)** | 3–4 узла |
| **Длина циклов (периодический)** | 5–6 узлов (опционально) |

Дополнение (MVP):
- **Нулевые долги не храним.** В таблице `Debt` допустимы только `amount > 0`; если в результате платежа или клиринга сумма долга становится равной 0, запись удаляется.
- **Трассируемость клиринга.** В `Transaction.payload` для `type=CLEARING` сохраняется `equivalent` и список рёбер цикла (`debtor`, `creditor`, `amount`), чтобы клиринг можно было воспроизвести и аудитировать.

### 1.3. Маршрутизация (Routing)

| Решение | Выбор для MVP |
|---------|---------------|
| **Базовый режим** | Limited multipath (k-shortest paths) |
| **Максимум путей** | 3 |
| **Максимум хопов** | 6 |
| **Full multipath** | Выключен по умолчанию (feature flag для бенчмарков) |

### 1.4. Эквиваленты

| Решение | Выбор для MVP |
|---------|---------------|
| **Кто создаёт** | Только админ/оператор сообщества |
| **Стартовый набор** | UAH, HOUR, kWh |

### 1.5. Верификация

| Решение | Выбор для MVP |
|---------|---------------|
| **KYC** | Не внедряем в MVP |
| **Verification levels** | 0–3 (лимиты и права по уровням) |
| **Модерация** | Ручная (админ/оператор) |

### 1.6. Операторские полномочия

| Решение | Выбор для MVP |
|---------|---------------|
| **Действия** | freeze/unfreeze, ban/unban, расследование, компенсирующие операции |
| **Аудит** | Обязательный audit-log для всех действий |
| **Роли** | admin, operator, auditor |

### 1.7. Машина состояний транзакций (internal)

В БД `Transaction.state` хранит внутренние состояния для операционной надёжности (recovery, идемпотентность, учёт 2PC/локов). Эти состояния **не равны** публичному статусу результата платежа.

**Допустимые internal-состояния (ограничение в БД):** `NEW`, `ROUTED`, `PREPARE_IN_PROGRESS`, `PREPARED`, `COMMITTED`, `ABORTED`, `PROPOSED`, `WAITING`, `REJECTED`.

**PAYMENT (2PC-подобный поток, реализация MVP):**

| Состояние | Смысл (MVP) |
|----------|-------------|
| `NEW` | Запись транзакции создана, маршрутизация рассчитана и сохранена в `payload` |
| `PREPARED` | Сегментные блокировки созданы успешно (фаза 1) |
| `COMMITTED` | Долги обновлены и блокировки удалены (фаза 2) |
| `ABORTED` | Терминальный сбой; блокировки удалены (best-effort) и сохранён `error` |

Примечания:
- `ROUTED` и `PREPARE_IN_PROGRESS` зарезервированы как internal-состояния, но в текущем MVP payment engine не выставляются.
- `REJECTED` зарезервирован как терминальное состояние для будущих «явных отказов»; в MVP считается терминальным.

**CLEARING (MVP):**

| Состояние | Смысл (MVP) |
|----------|-------------|
| `NEW` | Создана транзакция клиринга |
| `COMMITTED` | Клиринг успешно применён |
| `ABORTED` | Терминальный сбой |

**Recovery (MVP):** транзакции, застрявшие в «активных» internal-состояниях дольше заданного времени, переводятся в `ABORTED`, а связанные блокировки очищаются.

**Публичный статус платежа:** `PaymentResult.status` — это финальный результат и возвращает только `COMMITTED` или `ABORTED`.

---

## 2. Дефолты и лимиты

### 2.1. Таймауты 2PC

| Параметр | Дефолт | Диапазон |
|----------|--------|----------|
| `protocol.transaction_timeout_seconds` | 10 | 5–30 |
| `protocol.prepare_timeout_seconds` | 3 | 1–10 |
| `protocol.commit_timeout_seconds` | 5 | 2–15 |
| `protocol.lock_ttl_seconds` | 60 | 30–300 |

### 2.2. Маршрутизация

| Параметр | Дефолт | Диапазон |
|----------|--------|----------|
| `routing.max_path_length` | 6 | 3–10 |
| `routing.max_paths_per_payment` | 3 | 1–10 |
| `routing.path_finding_timeout_ms` | 500 | 100–2000 |
| `routing.multipath_mode` | `limited` | limited, full |

### 2.3. Клиринг

| Параметр | Дефолт | Диапазон |
|----------|--------|----------|
| `clearing.enabled` | true | true/false |
| `clearing.trigger_cycles_max_length` | 4 | 3–6 |
| `clearing.periodic_cycles_max_length` | 6 | 4–8 |
| `clearing.min_clearing_amount` | 1.00 | 0.01–100 |
| `clearing.max_cycles_per_run` | 100 | 10–1000 |
| `clearing.trigger_interval_seconds` | 0 (сразу) | 0–60 |
| `clearing.periodic_interval_minutes` | 60 | 5–1440 |

### 2.4. Лимиты

| Параметр | Дефолт | Диапазон |
|----------|--------|----------|
| `limits.default_trust_line_limit` | 1000.00 | 0–∞ |
| `limits.max_trust_line_limit` | 100000.00 | 1000–∞ |
| `limits.max_payment_amount` | 50000.00 | 100–∞ |
| `limits.daily_payment_limit` | 100000.00 | 1000–∞ |

### 2.5. Feature Flags

| Параметр | Дефолт | Описание |
|----------|--------|----------|
| `feature_flags.multipath_enabled` | true | Limited multipath включён |
| `feature_flags.full_multipath_enabled` | false | Full mode для бенчмарков |
| `feature_flags.inter_hub_enabled` | false | Межхабовое взаимодействие |

---

## 3. Пилотный размер (проектирование)

| Метрика | Целевое значение |
|---------|------------------|
| **Участники** | 50–200 |
| **Транзакции/день** | до 1000 |
| **Пиковая нагрузка** | 5–10 tx/sec |
| **Эквивалентов** | 1–3 |

---

## Связанные документы

- [config-reference.md](config-reference.md) — полный реестр параметров с описанием
- [02-protocol-spec.md](02-protocol-spec.md) — спецификация протокола
- [03-architecture.md](03-architecture.md) — архитектура системы
- [admin/specs/admin-console-minimal-spec.md](admin/specs/admin-console-minimal-spec.md) — спецификация админки
