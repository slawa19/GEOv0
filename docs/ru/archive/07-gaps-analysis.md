# Анализ пробелов: что не учтено в проекте GEO v0.1

**Версия:** 0.1  
**Дата:** Ноябрь 2025  
**На основе:** Сравнительный анализ документов из `sources/` и текущей документации `docs/ru/`

---

## Содержание

1. [Резюме](#1-резюме)
2. [Критические пробелы архитектуры](#2-критические-пробелы-архитектуры)
3. [Пробелы в протоколе](#3-пробелы-в-протоколе)
4. [Недостающие экономические механизмы](#4-недостающие-экономические-механизмы)
5. [Пробелы в функциональности](#5-пробелы-в-функциональности)
6. [Рекомендации по приоритизации](#6-рекомендации-по-приоритизации)

---

## 1. Резюме

Сравнительный анализ исходных документов GEO (whitepaper, FAQ, целевые параметры) с текущей документацией проекта выявил **существенные расхождения** между оригинальной концепцией и текущей архитектурой v0.1.

### Ключевые расхождения

| Аспект | Оригинальная концепция | Текущая реализация v0.1 |
|--------|------------------------|------------------------|
| **Топология** | P2P сеть без центра | Hub как центральный координатор |
| **Хранение данных** | Распределённая БД (trustNet) | PostgreSQL на Hub |
| **Приватность** | Высокая, нет общего реестра | Hub видит все транзакции |
| **Консенсус** | Локальный между участниками операции | 2PC с Hub как координатор |
| **Эмиссия** | Полностью децентрализованная | Через Hub |

**Важно:** Многие из этих расхождений — **осознанный компромисс** для MVP. Однако документация должна чётко описывать путь от текущего состояния к целевой архитектуре.

---

## 2. Критические пробелы архитектуры

### 2.1. Отсутствие описания целевой P2P архитектуры

**Проблема:**

В исходных документах GEO позиционируется как:

> "Одноранговая система без накопления данных от первой операции — trustNet. Это уникальный алгоритм действительно распределённой базы данных, где нет ни одного накопителя всей информации."

Текущая архитектура v0.1 — **централизованный Hub с PostgreSQL**. Это допустимо для MVP, но:
- Нет roadmap перехода к P2P
- Нет описания, как будет работать trustNet
- Непонятна судьба данных при миграции

**Предложение:**

Добавить раздел "Архитектурная эволюция" с описанием:
```
Этап 1 (текущий): Hub-центричная модель
Этап 2: Федерация Hub'ов  
Этап 3: Гибридная модель (Hub + P2P nodes)
Этап 4: Полностью P2P (trustNet)
```

### 2.2. Локальный консенсус vs централизованный 2PC

**В исходниках:**

> "Локальный 100% консенсус — подтверждение транзакции происходит всеми участниками операции (как правило, это достаточно малый сегмент участников общей сети)."

**В текущей документации:**

Hub выполняет роль координатора 2PC, что создаёт:
- Single point of failure
- Hub видит все транзакции
- Hub может манипулировать порядком операций

**Предложение:**

Описать протокол локального консенсуса между участниками пути без участия Hub, по крайней мере для Этапа 3+:

```
Участники пути A → B → C → D:
1. A инициирует, собирает подписи по цепочке
2. Криптографический пакет подписывается всеми
3. Коммит происходит атомарно когда все подписали
4. Hub только индексирует, не координирует
```

### 2.3. Приватность транзакций

**В исходниках:**

> "В GEO нет блокчейна с общей историей всех транзакций... Информация о транзакции между узлами А и В сберегается только на устройствах этих узлов. При косвенном взаимодействии промежуточные узлы сохраняют информацию только о своих транзакциях с предыдущим и последующим узлом в цепочке — информацию о начальном и конечном пункте они не получают."

**В текущей документации:**

Hub хранит все транзакции, долги, линии доверия в PostgreSQL.

**Предложение:**

1. Для MVP — описать меры защиты приватности:
   - Шифрование чувствительных данных
   - Минимизация хранимых метаданных
   - Право на удаление истории

2. Для будущего — описать протокол, где:
   - Каждый участник хранит только свои данные
   - При маршрутизации промежуточные ноды не видят отправителя/получателя

---

## 3. Пробелы в протоколе

### 3.1. Алгоритм прогнозирования максимальных трат (Max Flow)

**В исходниках детально описаны требования:**

> "Для сети из 100M участников, при средней связности 24 контр-агента... среднее время выполнения операции из 1000 запросов — не более 6 сек для получения 85% максимального потока"

**В текущей документации:**

Есть только базовый BFS для поиска k-shortest paths с расчётом capacity. Нет:
- Алгоритма расчёта max flow между двумя произвольными участниками
- API endpoint для запроса "сколько максимум я могу заплатить участнику X?"
- Кэширования и инкрементального обновления результатов

**Предложение:**

Добавить в протокол:

```python
class MaxFlowService:
    async def calculate_max_flow(
        self,
        source: str,
        target: str,
        equivalent: str
    ) -> MaxFlowResult:
        """
        Рассчитать максимальный поток между участниками.
        
        Returns:
            MaxFlowResult с:
            - max_amount: максимальная сумма
            - paths: составляющие пути
            - bottlenecks: узкие места
        """
        
    async def get_reachable_participants(
        self,
        source: str,
        equivalent: str,
        min_amount: Decimal
    ) -> list[ReachableParticipant]:
        """
        Получить всех участников, достижимых с минимальной суммой.
        """
```

### 3.2. Протокол восстановления состояния

**В исходниках (FAQ):**

> "Якщо хтось погодив операцію, але в наслідок збою на своїй стороні випав з мережі і не отримав погодження решти нод — починається фаза так званого відновлення стану. Ця нода по поверненню в мережу починає опитувати інші ноди про те, як вони закінчили цю операцію."

**В текущей документации:**

Есть базовое восстановление prepare_locks при запуске Hub, но нет:
- Протокола восстановления для отдельных участников
- Механизма опроса других участников о состоянии операции
- Гарантий eventual consistency

**Предложение:**

Добавить раздел "Recovery Protocol":

```
Состояния участника после сбоя:
1. UNCERTAIN — участник не знает, завершилась ли операция
2. RECOVERING — участник опрашивает соседей по пути
3. SYNCHRONIZED — состояние восстановлено

Протокол:
1. При возврате в сеть участник проверяет pending операции
2. Для каждой отправляет RECOVERY_QUERY соседям по пути
3. Соседи отвечают своим состоянием операции
4. Участник принимает решение на основе majority
```

### 3.3. Атомарность при множественных путях

**Проблема:**

При multi-path платеже (например, 3 маршрута) текущий протокол не гарантирует атомарность между путями:

```
Путь 1: A → X → B  (60 UAH) ✓ COMMITTED
Путь 2: A → Y → Z → B  (40 UAH) ✗ ABORTED (timeout на Z)

Результат: A заплатил только 60 из 100 — неатомарный платёж!
```

**В исходниках:**

> "Формуємо спеціальний криптографічний пакет, в який поміщається перелік ВСІХ НОД, які беруть участь в операції ПО ВСІМ шляхам."

**Предложение:**

Модифицировать протокол платежа:

1. PREPARE фаза охватывает ВСЕ пути одновременно
2. COMMIT только если ВСЕ участники ВСЕХ путей подтвердили
3. Единый `tx_id` и криптографический пакет для всей операции

```json
{
  "tx_id": "uuid",
  "type": "MULTI_PATH_PAYMENT",
  "all_paths": [
    {"path": ["A", "X", "B"], "amount": 60},
    {"path": ["A", "Y", "Z", "B"], "amount": 40}
  ],
  "all_participants": ["A", "X", "B", "Y", "Z"],
  "signatures": {
    "A": "...", "X": "...", "B": "...", "Y": "...", "Z": "..."
  },
  "commit_threshold": "ALL"
}
```

---

## 4. Недостающие экономические механизмы

### 4.1. Товарные талоны (Commodity Tokens)

**В исходниках:**

> "Кроме бон и денежных обязательств, в GEO можно создавать товарные талоны. Товарные талоны номинируются в некотором количестве товара, а не в деньгах, и погашаются этим товаром."

**Пример из Колионово:** 1 талон = 10 яиц, погашается реальными яйцами.

**В текущей документации:**

Есть только эквиваленты (UAH, HOUR, kWh) без различения типов обязательств.

**Предложение:**

Расширить модель эквивалентов:

```python
class EquivalentType(Enum):
    FIAT_REFERENCE = "fiat"      # Привязка к фиатной валюте (UAH, USD)
    TIME_UNIT = "time"           # Час работы
    COMMODITY_TOKEN = "commodity" # Товарный талон (погашается товаром)
    ABSTRACT = "abstract"        # Абстрактная единица сообщества

class Equivalent(BaseModel):
    code: str
    type: EquivalentType
    precision: int
    
    # Для товарных талонов:
    commodity_spec: CommoditySpec | None  # Описание товара
    redemption_rules: RedemptionRules | None  # Правила погашения
```

### 4.2. Gateway/Шлюзы для ввода-вывода фиата

**В исходниках:**

> "Для этого в ней должны появиться узлы, которые будут играть роль шлюзов, конвертирующих деньги в свои GEO-обязательства и наоборот... Важно, что в отличие от Риппла у нас гейтвеем (ввод/вывод) может стать каждый, без инвестиций в поддержку системы"

**В текущей документации:**

Упоминается только в Приложении D как "Future Extension", без детальной спецификации.

**Предложение:**

Добавить полноценный раздел "Gateway Protocol":

```python
class GatewayService:
    """
    Участник, обеспечивающий ввод/вывод фиата.
    
    Любой участник может стать Gateway, если:
    1. Прошёл верификацию сообщества
    2. Имеет резервы для обеспечения обязательств
    3. Согласился с правилами Gateway
    """
    
    async def deposit(
        self,
        user_pid: str,
        fiat_amount: Decimal,
        fiat_currency: str,
        proof_of_payment: str  # Подтверждение банковского перевода
    ) -> DepositResult:
        """
        Пользователь вносит фиат → Gateway создаёт TrustLine.
        """
        
    async def withdraw(
        self,
        user_pid: str,
        amount: Decimal,
        equivalent: str,
        bank_details: BankDetails
    ) -> WithdrawResult:
        """
        Gateway погашает долг пользователя → выводит фиат.
        """
```

### 4.3. Скрытый демередж и стимулы к нулевому балансу

**В исходниках (FAQ):**

> "Найоптимальніша прогнозована стратегія учасника системи — прямувати до нуль балансу."

Объяснение:
1. Накапливать положительный баланс → уменьшает возможности расчёта с тобой
2. Большой отрицательный баланс → риск закрытия входящих TrustLines
3. Увеличение TrustLines → увеличение личных рисков (демередж)

**В текущей документации:**

Не описана экономическая модель, стимулирующая оптимальное поведение участников.

**Предложение:**

Добавить раздел "Экономическая модель":

```markdown
## Стимулы участников

### Стремление к нулевому балансу

Система создаёт естественные стимулы к балансированию:

1. **Положительный баланс** (много должны тебе):
   - TrustLines к тебе используются полностью
   - Другие участники не могут тебе платить
   - Ты "блокируешь" ликвидность сети
   - Репутационные последствия

2. **Отрицательный баланс** (ты много должен):
   - Кредиторы могут закрыть TrustLines
   - Ограниченная возможность новых покупок
   - Репутационные последствия

3. **Около нуля** — оптимальное состояние:
   - Максимальная гибкость операций
   - Хорошая репутация
   - Стабильные отношения с контрагентами
```

### 4.4. Конвертация между эквивалентами

**В исходниках:**

> "Обязательства данного эмитента обмениваются на обязательства в мерах (грн, дол и др). Цена устанавливается рыночным путём (спрос и предлож)."

**В текущей документации:**

> "GEO **не конвертирует** между эквивалентами автоматически"

Это правильно для автоматической конвертации, но не описан механизм рыночного обмена.

**Предложение:**

Добавить описание Exchange механизма:

```python
class ExchangeService:
    """
    Децентрализованный обмен между эквивалентами.
    """
    
    async def create_offer(
        self,
        participant: str,
        sell_equivalent: str,
        sell_amount: Decimal,
        buy_equivalent: str,
        buy_amount: Decimal,
        expires_at: datetime
    ) -> ExchangeOffer:
        """
        Создать предложение обмена (order book).
        """
        
    async def match_offers(
        self,
        equivalent_pair: tuple[str, str]
    ) -> list[ExchangeMatch]:
        """
        Найти совпадающие предложения и исполнить.
        """
```

---

## 5. Пробелы в функциональности

### 5.1. Репутационная система

**В исходниках:**

> "В этой системе репутация каждого участника приобретает гораздо большее значение... Использование GEO стимулирует участников к накоплению репутационного капитала."

**В текущей документации:**

Есть `verification_level`, но нет полноценной репутационной модели.

**Предложение:**

```python
class ReputationService:
    async def calculate_reputation(
        self,
        participant_id: str
    ) -> ReputationScore:
        """
        Метрики репутации:
        - trust_received: сумма входящих TrustLines
        - trust_given: сумма исходящих TrustLines
        - payment_success_rate: % успешных платежей
        - clearing_participation: участие в клиринге
        - balance_volatility: стабильность баланса
        - network_contribution: вклад как посредника
        """
```

### 5.2. Защита от спама и нежелательных коммуникаций

**В исходниках:**

> "Протокол GEO позволяет децентрализовать не только кредитные сети, но и другие сети доверия... Например, можно применить его к системам электронных сообщений для ограничения нежелательных коммуникаций."

**В текущей документации:**

Не упоминается.

**Предложение:**

Описать как TrustLines могут ограничивать коммуникации:
- Сообщения только от связанных участников (через N звеньев)
- "Стоимость" сообщения в единицах доверия
- Фильтрация на основе репутации

### 5.3. Контрциклическая функция

**В исходниках:**

> "Как показывает, например, практика функционирования системы WIR, кредитная сеть, комплементарная национальной валюте, может иметь контрциклический характер. В периоды экономических спадов, когда деньги оказываются в дефиците, такие сети позволяют предпринимателям взаимодействовать на условиях беспроцентного кредитного бартера."

**В текущей документации:**

Кратко упоминается в обзоре, но нет детального описания.

**Предложение:**

Добавить раздел о макроэкономической роли:
- Сравнение с WIR (Швейцария)
- Как GEO работает при дефиците фиатных денег
- Метрики для отслеживания контрциклического эффекта

### 5.4. Система лояльности и p2p кредитование

**В исходниках:**

> "На основе протокола GEO может быть организована система лояльности. В связке с банковским счетом он может быть использован для организации системы р2р кредитования."

**В текущей документации:**

Не описаны эти use cases.

**Предложение:**

Добавить раздел "Дополнительные применения" с примерами:

1. **Система лояльности:**
   - Бизнес создаёт эквивалент "BONUS_STORE_X"
   - Клиенты получают бонусы за покупки
   - Бонусы можно тратить или передавать

2. **P2P кредитование:**
   - TrustLine как микрокредит между участниками
   - Возможность установить % (расширение протокола)
   - Интеграция с внешними кредитными скоринговыми системами

---

## 6. Рекомендации по приоритизации

### Высокий приоритет (для MVP)

| Пробел | Обоснование |
|--------|-------------|
| Атомарность multi-path | Без этого платежи ненадёжны |
| Max Flow алгоритм | Важно для UX — знать "сколько могу заплатить" |
| Расширенная модель эквивалентов | Товарные талоны — ключевая фича оригинального GEO |
| Протокол восстановления | Гарантии eventual consistency |

### Средний приоритет (после MVP)

| Пробел | Обоснование |
|--------|-------------|
| Gateway Protocol | Необходимо для массового adoption |
| Репутационная система | Усиливает доверие в сети |
| Экономическая модель (демередж) | Самобалансирующаяся система |
| Exchange между эквивалентами | Увеличивает ликвидность |

### Низкий приоритет (долгосрочно)

| Пробел | Обоснование |
|--------|-------------|
| Полная P2P архитектура (trustNet) | Требует значительных R&D |
| Приватность уровня Whispers | Сложная криптография |
| Системы лояльности, p2p кредитование | Надстройки над базовым протоколом |
| Контрциклические метрики | Требуют реального использования |

---

## Заключение

Текущая документация GEO v0.1 описывает **работающий MVP**, но **значительно отличается** от оригинальной концепции децентрализованной кредитной сети. Это нормально для первой версии, однако:

1. **Нужен roadmap** — чёткий путь от Hub-центричной модели к P2P
2. **Нужна честность** — явно указать что v0.1 это "training wheels", не финальная архитектура
3. **Нужны гарантии** — атомарность, recovery, max flow должны быть в MVP

Рекомендую дополнить документацию:
- Разделом об архитектурной эволюции
- Расширенной экономической моделью
- Спецификацией Gateway и Exchange
- Описанием пути к полной децентрализации

---

## Связанные документы

- [00-overview.md](00-overview.md) — Обзор проекта
- [02-protocol-spec.md](02-protocol-spec.md) — Спецификация протокола
- [03-architecture.md](03-architecture.md) — Архитектура системы
