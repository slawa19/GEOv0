# GEOv0-PROJECT — рекомендуемые решения и дефолты для MVP (варианты + обоснование)

**Цель:** закрыть вопросы из разделов 7.2–7.4 документа [`docs/ru/archive/07-clarifications-and-gaps.md`](docs/ru/archive/07-clarifications-and-gaps.md) в формате: **варианты → рекомендуемая опция → обоснование → влияние на реализацию**.

Фокус: Hub‑центричная MVP (архитектура B), локальные сообщества/кластеры, автоматический клиринг как ключевая ценность.

---

## 1. Резюме: базовый «наилучший» набор решений для старта MVP

Ниже — связный набор решений, которые вместе дают максимальную скорость и минимальные переделки:

1) **Модель узлов MVP:** hub‑центричная (участник = аккаунт в hub), **подпись на стороне клиента обязательна**, 2PC реализуется сервером как протокол состояния + транзакционные блокировки в БД.
2) **Клиринг:** **автоматический**, по расписанию и по триггерам, с ограничением «стоимости» (лимиты на длину цикла, количество циклов за прогон, min_amount).
3) **Routing:** shortest‑path/BFS до глубины 6, multipath включён, но ограничен (≤ 3 путей, TTL кэша 30 сек, лимит вычислительных затрат).
4) **Эквиваленты:** в MVP создаются/модерируются **только админом сообщества**.
5) **Верификация:** KYC как процесс «внешней идентификации» не внедряем в MVP, но вводим **verification levels** и лимиты/права по уровням.
6) **Операторские полномочия:** нужны (freeze/ban, расследование, компенсирующие операции) — строго через аудит‑лог и регламент.
7) **Пилотный размер (проектирование):** 50–200 участников, до 1000 tx/day, пики до 5–10 tx/s.

---

## 2. Каталог решений (варианты → рекомендация)

### DEC-1. Модель узлов и подписи в MVP

**Варианты:**

- **A. Account‑only в hub (без подписей клиента):** сервер «от имени» участника.
- **B. Account в hub + обязательная подпись клиента (рекомендуется):** сервер принимает только подписанные сообщения.
- **C. Полноценные узлы (node‑to‑node) уже в MVP:** клиент должен участвовать в фазах протокола как отдельный узел.

**Рекомендация: B.**

**Почему это лучше:**

- сохраняется криптографическая модель доверия (ключ у пользователя), но без требований «клиент всегда онлайн»;
- упрощает разработку: 2PC/таймауты/ретраи контролирует hub;
- облегчает future‑proof переход к более распределённой модели.

**Влияние на реализацию:**

- обязателен канонизатор payload + test vectors;
- в PWA нужен безопасный key‑management (WebCrypto + export/import) и recovery‑политика.

---

### DEC-2. Клиринг: режим, согласие и ограничения

**Варианты:**

- **A. Автоматический клиринг (рекомендуется):** циклы закрываются автоматически при выполнении условий.
- **B. Клиринг по согласию пользователей:** каждое изменение долга требует подтверждения.
- **C. Клиринг выключен в MVP:** только платежи.

**Рекомендация: A.**

**Почему это лучше:**

- клиринг — основная «магия» и ценность GEO; без него сеть становится просто системой учёта долгов;
- режим B практически убивает UX (масса подтверждений), ломает автоматизацию и задерживает расчёты;
- режим C делает MVP концептуально неполным.

**Что важно добавить, чтобы A было безопасно:**

- строгая объяснимость: лог клиринга + «почему так получилось» в истории;
- лимиты: длина цикла, min_amount, max_cycles_per_run, лимиты по времени;
- тесты инвариантов (zero‑sum, trust limits, idempotency).

---

### DEC-3. Multipath в MVP

**Варианты:**

- **A. Только single‑path:** проще, но хуже проходимость платежей.
- **B. Multipath ограниченный (рекомендуется для MVP):** ≤ 3 путей, ограничение затрат, возможность отключить feature‑flag.
- **C. Полный multipath (max‑flow и т.п.):** дорого и рискованно для MVP.

**Рекомендация: B.**

**Почему это лучше:**

- сохраняет ключевое свойство сети (платежи проходят при фрагментированной ёмкости);
- остаётся контролируемым по сложности;
- можно выпускать вертикальный срез сначала с 1 путём, затем включить 2–3 пути без смены архитектуры.

---

#### DEC-3.1. Трактовка «Full Multipath Mode» (для бенчмарков и будущих версий)

**Контекст:** в документации упоминается «Full multipath mode» как продвинутый режим. Нужно определить, что это означает, не усложняя архитектуру MVP.

**Варианты трактовки:**

| Вариант | Описание | Плюсы | Минусы |
|---------|----------|-------|--------|
| **A. Истинный max‑flow** | Edmonds‑Karp или Dinic с budget по времени/итерациям/augmenting paths; выключен по умолчанию | Математически оптимальное решение | Сложность реализации, риск для MVP |
| **B. Эвристический режим** | Поиск k путей с разбиением суммы (k = max_paths), допустимо пересечение рёбер, без гарантии оптимальности; выключен по умолчанию | Проще, предсказуемо | Не гарантирует max‑flow |
| **C. Общая формулировка** | Любой алгоритм для «большего числа путей / лучшего распределения» с теми же ограничителями (budget/таймауты); детали алгоритма не фиксируются протоколом | Максимальная гибкость, не блокирует эволюцию | Менее точная спецификация |

**Рекомендация: C (общая формулировка) + B как референсная реализация для MVP.**

**Обоснование:**

1. **Соответствует философии GEO:** прагматизм для MVP, эволюция к сложным решениям позже
2. **Не блокирует будущее:** можно экспериментировать с max‑flow без изменения протокола
3. **Достаточно для бенчмарков:** эвристика k‑shortest paths даёт измеримые метрики
4. **Простота:** для сообщества 50–200 участников эвристика практически эквивалентна max‑flow

**Формулировка для документации:**

> **Full multipath** — расширенный режим маршрутизации, который пытается найти более оптимальное распределение платежа по нескольким путям по сравнению с базовым режимом.
>
> **Характеристики:**
> - Выключен по умолчанию (**feature flag**, см. канон в [`docs/ru/config-reference.md`](docs/ru/config-reference.md:1))
> - Подчиняется тем же ограничителям: `max_paths`, `max_hops`, `timeout_ms`, `budget_ms`
> - Не гарантирует математически оптимальное решение
> - Предназначен для больших платежей, стресс‑тестирования и бенчмаркинга
>
> **Референсная реализация (MVP):** эвристика k‑shortest paths с разбиением суммы, допустимо пересечение рёбер.
>
> **Будущие реализации (опционально):** max‑flow алгоритмы (Edmonds‑Karp, Dinic) с budget по итерациям. Детали алгоритма не фиксируются протоколом.

**Конфигурация (устаревший черновик ключей; deprecated):**

> В этом архивном документе исторически использовались ключи `routing.default_mode` и `routing.full_multipath_enabled`.
> Они **не являются каноном** для текущей RU документации.
>
> Канонические ключи и дефолты для MVP:
> - `routing.multipath_mode: limited|full`
> - `feature_flags.full_multipath_enabled: true|false`
>
> См. актуальный реестр параметров: [`docs/ru/config-reference.md`](docs/ru/config-reference.md:1) и нормативное описание: [`docs/ru/02-protocol-spec.md`](docs/ru/02-protocol-spec.md:1).

```yaml
routing:
  # Базовый режим (по умолчанию для MVP)
  default_mode: "k_shortest"      # "single" | "k_shortest" | "full"
  
  # Ограничители (общие для всех режимов)
  max_path_length: 6
  max_paths_per_payment: 3
  path_finding_timeout_ms: 500
  
  # Full multipath mode (DEC-3.1)
  full_multipath_enabled: false   # Выключен по умолчанию (deprecated ключ)
  full_multipath_budget_ms: 1000  # Дополнительный budget времени для full режима
  full_multipath_max_iterations: 100  # Для алгоритмов типа Edmonds‑Karp (если реализованы)
```

**Влияние на реализацию:**

- MVP: реализуем только `k_shortest` режим
- Full mode: можно добавить позже без изменения API (переключается конфигом)
- Бенчмарки: метрики собираются независимо от режима (время, число путей, % использованной capacity)

---

### DEC-4. Routing: алгоритм и ограничения вычислений

**Варианты:**

- **A. BFS до фиксированной глубины (рекомендуется):** shortest path по числу шагов/с учётом политики.
- **B. k‑shortest paths + эвристики:** сложнее, но иногда эффективнее.
- **C. Оптимизация потоков (max‑flow/min‑cost):** слишком тяжело для MVP.

**Рекомендация: A.**

**Почему это лучше:**

- предсказуемая сложность и объяснимость;
- проще ограничивать «стоимость» вычислений;
- подходит для пилотного масштаба.

---

### DEC-5. Эквиваленты: кто создаёт и как модерируются

**Варианты:**

- **A. Любой участник может создавать:** быстро, но «зоопарк» и злоупотребления.
- **B. Только админ/оператор (рекомендуется):** управляемость и единый стандарт.
- **C. Верифицированные участники:** компромисс, но требует процесса.

**Рекомендация: B.**

**Почему это лучше:**

- MVP должен быть управляемым и предсказуемым;
- снижает риск конфликтов в экономике сообщества и упрощает аналитические отчёты.

---

### DEC-6. Верификация и KYC в MVP

**Варианты:**

- **A. KYC обязателен:** высокие затраты, юридическая нагрузка.
- **B. KYC отсутствует, но есть verification levels + лимиты (рекомендуется):** прагматичный MVP.
- **C. Вообще нет верификации:** высокий риск sybil/спама.

**Рекомендация: B.**

**Почему это лучше:**

- позволяет начать пилот без внешних интеграций;
- даёт рычаги риска через лимиты и права;
- оставляет «hooks» под KYC позже (не ломая модель).

---

### DEC-7. Оператор/админ: полномочия и аудит

**Варианты:**

- **A. Минимальный оператор без спец‑действий:** пилот часто «не обслужить».
- **B. Операторские действия + обязательный audit log (рекомендуется).**
- **C. Полная «ручная» правка БД:** быстро, но разрушает доверие.

**Рекомендация: B.**

**Почему это лучше:**

- пилот неизбежно сталкивается с инцидентами;
- audit log защищает доверие и позволяет расследовать;
- повышает воспроизводимость и качество поддержки.

---

### DEC-8. Параметры пилота для проектирования (значения «по умолчанию»)

**Варианты:**

- **A. 10–30 участников:** слишком маленький сигнал, много ручной работы.
- **B. 50–200 участников (рекомендуется):** реалистичный «пилот сообщества».
- **C. 1000+ участников:** нужна иная инфраструктура и безопасность.

**Рекомендация: B.**

**Почему это лучше:**

- достаточно, чтобы проявились эффекты маршрутизации и клиринга;
- всё ещё можно держать в одном hub без кластеризации.

---

## 3. Дефолты и лимиты: варианты + почему выбран именно такой набор

Ниже — объяснение стартовых значений из `geo-hub-config.yaml` (см. [`docs/ru/archive/07-clarifications-and-gaps.md`](docs/ru/archive/07-clarifications-and-gaps.md)).

### 3.1. 2PC timeouts

**Варианты:**

- A: PREPARE 1–2s / COMMIT 2–3s (быстро, но хрупко при мобильных сетях)
- **B: PREPARE 3s / COMMIT 5s (рекомендуется)**
- C: PREPARE 10s / COMMIT 15s (стабильно, но плохой UX)

**Рекомендация: B** — баланс UX и устойчивости.

### 3.2. Routing ограничения

**max_path_length: 6**

- меньше (4–5): быстрее, но хуже проходимость;
- **6 (рекомендуется):** разумный баланс для пилота;
- больше (8+): рост затрат и сложности объяснимости.

**max_paths_per_payment: 3**

- 1: проще;
- **3 (рекомендуется):** ощутимая польза multipath без взрыва сложности;
- 5+: дороже вычислительно и сложнее тестировать.

### 3.3. Клиринг ограничения

**trigger_cycles_max_length: 4**

- 3: проще, но меньше возможностей;
- **4 (рекомендуется):** уже даёт заметный эффект;
- 5–6: лучше экономически, но дороже и сложнее для MVP.

### 3.4. Стартовые продуктовые лимиты

Здесь главная цель дефолтов — **безопасность и анти‑спам**, а не «максимальная полезность с первого дня».

**Варианты:**

- A: большие стартовые лимиты (рост пользы, но риск дефолтов/конфликтов)
- **B: маленькие стартовые лимиты + рост через доверие/верификацию (рекомендуется)**
- C: нулевые лимиты по умолчанию (слишком тяжёлый онбординг)

**Рекомендация: B** — соответствует идее доверия как риска.

---

## 4. Что остаётся «данными для калибровки», а не «вопросами»

Чтобы не плодить вопросы «для галочки», фиксируем так:

- **Решение принято по умолчанию** (как выше).
- **Owner даёт данные**, чтобы скорректировать коэффициенты (суммы, частоты, риск‑аппетит, типы эквивалентов, юрисдикции).

Это означает: клиринг в MVP — автоматический; multipath — включён, но ограничен; routing — BFS до 6; эквиваленты — админские.
