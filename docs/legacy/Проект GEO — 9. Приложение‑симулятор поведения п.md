# GEO — Приложение‑симулятор поведения пользователей

> Спецификация приложения для симуляции, тестирования и визуализации сети GEO

---

## Оглавление

1. [Введение](#1-введение)
2. [Основной функционал симулятора](#2-основной-функционал-симулятора)
   - 2.1. [Конфигурация «мира»](#21-конфигурация-мира-генерация-сети)
   - 2.2. [Поведенческие сценарии](#22-поведенческие-сценарии-модели-взаимодействия)
   - 2.3. [Управление нагрузкой](#23-управление-нагрузкой)
   - 2.4. [Взаимодействие с API ядра](#24-взаимодействие-с-реальным-api-ядра)
3. [Визуализация и аналитика](#3-визуализация-и-аналитика)
   - 3.1. [Граф сети доверия и долгов](#31-граф-сети-доверия-и-долгов)
   - 3.2. [Агрегированные метрики](#32-агрегированные-метрики-во-времени)
   - 3.3. [Показатели эффективности протокола](#33-показатели-эффективности-протокола)
   - 3.4. [Режим «реплея»](#34-режим-реплея)
4. [Настройки и сценарии для ТЗ](#4-настройки-и-сценарии-для-тз)
5. [Концепция визуализации](#5-концепция-визуализации)
6. [Экран «Карта сообщества»](#6-экран-карта-сообщества)
   - 6.1. [Компоновка экрана](#61-компоновка-экрана)
   - 6.2. [Отображение участников](#62-отображение-участников-узлов)
   - 6.3. [Отображение связей](#63-отображение-связей-trustlines-и-долги)
7. [Группировка участников](#7-группировка-участников)
   - 7.1. [По типам и ролям](#71-по-типам-и-ролям)
   - 7.2. [По кластерам доверия](#72-по-кластерам-доверия)
   - 7.3. [По финансовым показателям](#73-по-финансовым-показателям)
8. [Действия пользователя](#8-действия-пользователя)
   - 8.1. [Действия с участником](#81-действия-с-участником-узлом)
   - 8.2. [Действия с линиями доверия](#82-действия-с-линиями-доверия-и-долгами)
9. [Режим «Маршруты платежей и клиринг»](#9-режим-маршруты-платежей-и-клиринг)
10. [Режим списка участников](#10-режим-агрегированного-списка-участников)
11. [Рекомендуемый технический стек](#11-рекомендуемый-технический-стек)
    - 11.1. [Основной стек (React)](#111-основной-стек-react)
    - 11.2. [Альтернатива (Python)](#112-альтернативный-стек-python)
12. [UI‑спецификация экрана «Карта сообщества»](#12-ui‑спецификация-экрана-карта-сообщества)
    - 12.1. [Общая структура](#121-общая-структура-экрана)
    - 12.2. [Top Bar](#122-top-bar)
    - 12.3. [Left Sidebar](#123-left-sidebar)
    - 12.4. [Main Canvas](#124-main-canvas)
    - 12.5. [Right Sidebar](#125-right-sidebar)
    - 12.6. [Состояния экрана](#126-состояния-экрана-в-целом)

---

## 1. Введение

**Отдельное приложение, которое имитирует живое сообщество** и нагружает ядро GEO, а также визуализирует результаты. Это одновременно:

- генератор трафика и сценариев поведения;
- инструмент нагрузочного тестирования;
- лаборатория для экспериментов с протоколом (routing, clearing, политики доверия).

### Общая идея

Приложение подключается к API hub'а как множество «виртуальных пользователей» (участников), создаёт и управляет ими, открывает между ними trustlines, генерирует платежи, инициирует/реагирует на клиринг. По сути, это **симуляция экономики сообщества** поверх реального ядра GEO.

**Цели:**

- проверить производительность и устойчивость реализации;
- проверить корректность логики (особенно клиринга, ограничений лимитов, идемпотентности);
- исследовать, как разные топологии доверия и модели поведения влияют на:
  - эффективность взаимозачетов;
  - распределение долгов/кредитов;
  - среднюю длину маршрутов и частоту отказов;
- находить баги и узкие места ещё до того, как система попадёт к реальным пользователям.

---

## 2. Основной функционал симулятора

### 2.1. Конфигурация «мира» (генерация сети)

> **MVP-подход:** Начать с JSON-конфигурации (список участников + список trustlines). Динамическую генерацию добавить позже.

Возможность задать параметры сети через JSON-файл:

```json
{
  "participants": [
    { "id": "p1", "name": "Иван", "type": "person" },
    { "id": "p2", "name": "Кофейня", "type": "organization" }
  ],
  "trustlines": [
    { "from": "p1", "to": "p2", "limit": 1000 }
  ]
}
```

Параметры конфигурации:

- количество участников;
- типы участников (обычные, «центральные» узлы, hubs и т.п.);
- список trustlines с указанием лимитов;
- **один эквивалент** (например, `UAH`) — для MVP этого достаточно.

Симулятор может:

- **загружать готовые JSON-сценарии** (основной режим для MVP);
- автоматически генерировать сеть (расширенный режим, добавить позже).

### 2.2. Поведенческие сценарии (модели взаимодействия)

Модели, которые описывают, как участники ведут себя во времени:

- **«случайный рынок»** — участники случайно выбирают друг друга и совершают платежи;
- **«кластерный обмен»** — более интенсивный обмен внутри подгрупп, редкий между ними;
- **«клиент‑поставщик»** — одни участники в основном продают, другие в основном покупают;
- **стресс‑сценарии**:
  - всплеск активности;
  - отключение части участников (suspended);
  - резкая смена лимитов trustlines.

Модели должны настраиваться:

- интенсивность транзакций (сколько платежей в секунду/минуту/час);
- распределение сумм платежей;
- вероятность изменения trustlines (увеличение/уменьшение лимитов, закрытие).

### 2.3. Управление нагрузкой

> **MVP-подход:** Один слайдер «интенсивность» (0–100%) вместо нескольких профилей.

Возможность динамически изменять:

- общее число активных «виртуальных пользователей»;
- **интенсивность симуляции** — один слайдер 0–100%:
  - 0% — симуляция на паузе;
  - 25% — спокойный день;
  - 50% — обычная нагрузка;
  - 75% — пиковый час;
  - 100% — стресс-тест.

Соотношение типов операций (для расширенного режима):

- сколько процентов — платежи;
- сколько — изменения trustlines;
- сколько — искусственно инициированные клиринги.

### 2.4. Взаимодействие с реальным API ядра

Симулятор не должен «лезть в БД напрямую», а использовать те же интерфейсы, что и реальные клиенты:

- регистрация участников через API;
- создание trustlines через API;
- отправка `PAYMENT_REQUEST` и ожидание результата;
- мониторинг состояний транзакций.

Это гарантирует, что мы тестируем именно протокольный слой и логику, а не только внутренние функции.

---

## 3. Визуализация и аналитика

Очень важная часть — **наглядное отображение того, что происходит в сети**.

### 3.1. Граф сети доверия и долгов

- **Узлы** — участники;
- **Рёбра**:
  - trustlines (лимиты);
  - поверх них — текущие долги;
- **Цвет/толщина рёбер**:
  - величина лимита;
  - степень использования (долг/лимит);
- **Возможность**:
  - включать/выключать отображение доверия/долгов;
  - подсвечивать маршруты конкретных платежей;
  - видеть, какие рёбра чаще всего участвуют в клиринге.

### 3.2. Агрегированные метрики во времени

> **MVP-подход:** Вместо 10+ метрик достаточно 4–5 ключевых.

**Ключевые метрики для MVP:**

| Метрика | Зачем |
|---------|-------|
| Общий объём долгов | Понять масштаб системы |
| % успешных платежей | Оценить работоспособность |
| Средняя длина маршрута | Оценить эффективность сети |
| Объём клиринга | Оценить работу взаимозачётов |
| Топ-5 «узких мест» | Найти перегруженных участников |

**Расширенные метрики (после MVP):**

- Распределение длины маршрутов (максимум);
- Частота отказов по причинам:
  - нет маршрута;
  - недостаток лимита;
  - таймаут 2PC.
- Графики по времени (time series), возможность перемотки/просмотра истории.

### 3.3. Показатели эффективности протокола

- **Эффективность взаимозачётов** — отношение суммы клиринга к сумме всех проведённых платежей;
- **Концентрация долгов** — какие участники становятся «узкими местами» (на них замыкается много долгов);
- **Стабильность сети** — как часто система приходит в состояния, когда новые платежи «не проходят» из‑за перегруженности определённых рёбер.

### 3.4. Режим «реплея»

> ⚠️ **Не для MVP** — требует сложной сериализации состояния. Реализовать после базового функционала.

- Возможность записать сценарий (или фрагмент симуляции);
- Затем проигрывать его с разной скоростью;
- Сравнивать, как повели бы себя разные версии протокола/алгоритмов.

---

## 4. Настройки и сценарии для ТЗ

В перспективе ТЗ для такого приложения может включать:

- **Ядро симуляции:**
  - движок сценариев (скриптовый язык или конфигурационные файлы);
  - генератор событий (tick‑based или event‑based).

- **Сценарные настройки:**
  - параметры генерации сети;
  - профили поведения участников;
  - планировщик событий (в какое время что меняется).

- **Поддержка реплики и воспроизводимости:**
  - фиксированные seed'ы для генераторов случайных чисел;
  - сохранение конфигураций и результатов прогонов.

- **Поддержка разных версий backend'а GEO:**
  - возможность запускать симуляцию против разных инстансов ядра (например, v0.1, v0.2).

Такое приложение станет не только инструментом тестирования, но и **исследовательской лабораторией** для развития протокола GEO.

---

## 5. Концепция визуализации

Визуальная часть приложения может иметь **два основных режима**:

1. **«Социально‑экономический радар»** — обзорное представление сообщества:
   - кто есть кто,
   - кто с кем связан,
   - как течёт ценность.

2. **«Рабочий стол участника»** — фокус на самом пользователе:
   - мои связи (trustlines),
   - мои долги и кредиты,
   - мои действия (заплатить, изменить лимит, согласиться на клиринг и т.п.).

Оба режима могут быть доступны и в браузере (web‑интерфейс), и в нативном/кроссплатформенном клиенте.

---

## 6. Экран «Карта сообщества»

### 6.1. Компоновка экрана

**По центру** — интерактивный граф:

- **узлы** — участники;
- **рёбра** — связи доверия и/или долга между ними.

**Слева** — фильтры и слои:

- включить/выключить:
  - линии доверия (лимиты);
  - долги (реальные обязательства);
- выбрать эквивалент (UAH, HOUR, LOCAL_UNIT и т.д.);
- фильтровать по типу участников.

**Справа** — панель информации о выбранном элементе:

- если выбран участник: краткая карточка профиля, агрегированные показатели, доступные действия;
- если выбрано ребро: детали trustline и долга между участниками.

**Сверху** — панель режимов визуализации:

- «Сеть доверия» (TrustLines);
- «Сеть долгов» (Debts);
- «Маршруты платежей»;
- «Кластеры».

### 6.2. Отображение участников (узлов)

Каждый участник на графе — это **иконка + метка**:

- **Форма/значок** кодирует тип:
  - кружок — физлицо;
  - квадрат — организация;
  - шестиугольник — hub.

- **Цвет узла** означает состояние:
  - зелёный — активен (`active`);
  - жёлтый — ограничен/под наблюдением (`suspended`);
  - серый — покинул (`left`) или выключен;
  - красная обводка — участник часто фигурирует в спорах или имеет аномальные показатели.

При наведении курсора всплывает **мини‑подсказка**: имя, короткий статус, количество связей доверия.

При клике на узел открывается правая панель с подробной информацией.

### 6.3. Отображение связей (trustlines и долги)

Между участниками рисуются рёбра:

- **TrustLines**:
  - тонкие линии, цветом показывающие направление доверия;
  - стрелка от `from` к `to`;
  - насыщенность/толщина — величина лимита.

- **Debts**:
  - более толстые или выделенные линии;
  - направление — от должника к кредитору;
  - интенсивность цвета — размер долга.

Пользователь может:

- включать режим «только trustlines» или «только долги»;
- интерактивно «подсветить» связи конкретного участника.

---

## 7. Группировка участников

### 7.1. По типам и ролям

Группировка по:

- типу (`person`, `organization`, `hub`);
- роли в сообществе (например, «координатор», «поставщик услуг», «крупный покупатель»).

Реализация: цветовые коды или разные иконки; возможность выделить одну группу.

### 7.2. По кластерам доверия

> ⚠️ **MVP-подход:** На MVP отключить автоматическую кластеризацию. Показывать только ручную группировку по типу участника (см. 7.1).

В расширенном режиме на основе анализа графа можно автоматически выделять **кластеры**:

- группы участников, у которых много взаимных линий доверия;
- локальные «сообщества внутри сообщества» (районы, профессиональные группы).

Визуально:

- узлы одного кластера подсвечиваются одинаковым фоном/рамкой;
- режим «свернуть кластеры»: каждый кластер показывается как один крупный узел.

### 7.3. По финансовым показателям

Фильтры и цветовые градиенты:

- **по net‑балансу**: положительный (кредитор) — один цвет; отрицательный (должник) — другой;
- **по активности**: частота операций за последние N дней.

Это позволяет:

- увидеть «узкие места» (участники, через которых проходит слишком много операций);
- выявить потенциальные риски (сильно закредитованные).

---

## 8. Действия пользователя

### 8.1. Действия с участником (узлом)

**Обычный участник**, выбирая другого участника на графе, может:

- **Открыть панель профиля** — посмотреть публичную информацию, увидеть свои отношения с ним;
- **Создать/изменить линию доверия** — задать лимит, выбрать эквивалент, изменить политику;
- **Инициировать платёж** — указать сумму и эквивалент, увидеть предварительную оценку маршрута;
- **Посмотреть историю взаимодействий** — список платежей, изменения trustlines.

**Администратор/координатор** при выборе участника может дополнительно:

- **Изменить статус** участника (`suspended`, `left`);
- **Посмотреть риски и аномалии**;
- **Перейти к инструментам урегулирования споров**.

### 8.2. Действия с линиями доверия и долгами

При клике на ребро показывается:

- **детали trustline** `A→B`: текущий лимит, политика, дата создания/изменения;
- **детали долга** `B→A`: текущая сумма, история изменений.

**Обычный участник** (если это его trustline) может: изменить лимит, изменить политику, закрыть линию доверия.

**Администратор** может: видеть дополнительные технические данные, запускать аналитические инструменты.

---

## 9. Режим «Маршруты платежей и клиринг»

Для прозрачности работы протокола и отладки:

- пользователь выбирает конкретный платёж (по `tx_id`);
- система **подсвечивает маршрут**: узлы и рёбра, которые задействованы; стрелками показывает, как перераспределились долги.

**Режим показа циклов клиринга**:

- при выборе транзакции `CLEARING`: подсвечивается цикл `A → B → C → A`;
- на каждом ребре показывается: сколько было долга до клиринга, сколько стало после, какая часть «схлопнулась».

---

## 10. Режим агрегированного списка участников

Помимо графического вида нужна **таблично‑карточная** форма списка участников.

Таблица/список может содержать для каждого участника:

- имя/название;
- тип;
- net‑баланс;
- количество входящих/исходящих trustlines;
- индикаторы активности и надёжности.

**Возможные действия:**

- поиск и фильтрация;
- клик по строке — переход к карточке участника и/или подсветке его на графе;
- массовые операции (для админов): экспорт данных, отправка уведомлений.

---

## 11. Рекомендуемый технический стек

### 11.1. Основной стек (React)

Для отдельного аналитического/симуляционного веб‑инструмента React даёт почти идеальный баланс:

- огромное сообщество;
- море готовых решений;
- ИИ‑агенты лучше всего умеют генерировать именно React+TS‑код.

**Рекомендуемый стек:**

| Компонент | Технология | Примечание |
|-----------|------------|------------|
| Язык | TypeScript | — |
| UI‑фреймворк | React | — |
| UI‑кит | MUI (Material UI) | — |
| Граф (network) | `react-force-graph-2d` | ⚠️ Использовать 2D, не 3D — проще и достаточно для MVP |
| Чарты | `Recharts` | Декларативный, простой |
| Работа с API | React Query (TanStack Query) | — |
| Сборка | Vite | — |

**Технические ограничения:**

- **Ограничить размер графа** — при >100 узлах переключаться на агрегированный вид. Force-directed layout плохо работает с >500 узлами.
- **Throttle обновлений** — при активной симуляции не перерисовывать граф чаще 2–3 раз в секунду.
- **Оффлайн-режим** — возможность загрузить snapshot состояния и анализировать без подключения к backend.

**Почему это «минимальный кодинг»:**

- Практически все визуальные компоненты будут **композицией готовых библиотек**;
- Реальный «ручной» код — это в основном **склейка**: запросы к API, преобразование данных, логика фильтрации.

### 11.2. Альтернативный стек (Python)

Если хочется полностью избежать JS‑мира:

**Dash (Plotly Dash):**

- Python‑код описывает layout и callbacks;
- есть `dash-cytoscape` для граф‑визуализации;
- Plotly графики для метрик;
- легко деплоится.

**Streamlit:**

- ещё более простой синтаксис;
- много примеров;
- для сложной граф‑визуализации может понадобиться больше костылей.

Это особенно хорошо, если основная аудитория — разработчики/исследователи.

---

## 12. UI‑спецификация экрана «Карта сообщества»

Компактная, но подробная спецификация для генерации кода (React/Flutter).

### 12.1. Общая структура экрана

Экран делится на 4 основных области:

1. **Top Bar** — верхняя панель навигации и режимов.
2. **Left Sidebar** — фильтры, слои, выбор сценария/симуляции.
3. **Main Canvas** — центральное полотно с графом участников.
4. **Right Sidebar** — детальная панель выбранного элемента.

```
CommunityMapPage
├── TopBar
└── Layout
    ├── LeftSidebar
    ├── MainCanvas
    │   └── GraphView
    └── RightSidebar
```

### 12.2. Top Bar

**Компонент: `TopBar`**

| Элемент | Компонент | Состояния |
|---------|-----------|-----------|
| Логотип | `AppLogo` | нормальное, компактное |
| Режимы | `ViewModeTabs` | `activeTab: 'Network' \| 'Metrics'` (⚠️ Replay — не для MVP) |
| Статус | `SimulationStatusIndicator` | `connectionStatus`, `simulationStatus` |
| Управление | `SimulationControls` | Start/Stop/Pause/Resume/Speed |

**Горячие клавиши (UX-улучшение):**

| Клавиша | Действие |
|---------|----------|
| `Space` | Пауза/продолжение симуляции |
| `R` | Reset (сброс симуляции) |
| `+` / `-` | Увеличить/уменьшить скорость |
| `Esc` | Снять выделение с узла/ребра |

### 12.3. Left Sidebar

**Компонент: `LeftSidebar`**

Внутренняя структура:

- `QuickStartBanner` — ⭐ UX-улучшение: при первом запуске предлагает загрузить demo-сценарий с 10–20 участниками
- `ScenarioSelector` — выбор сценария симуляции
- `LayerToggles` — переключатели слоёв
- `FiltersPanel` — фильтры участников
- `ExportButton` — экспорт графа в PNG/SVG

**`LayerToggles` — состояния:**

```ts
showTrustLines: boolean
showDebts: boolean
showPaymentRoutes: boolean
showClusters: boolean
```

**`FiltersPanel` — состояния:**

```ts
filter.types: { person: boolean; organization: boolean; hub: boolean }
filter.statuses: { active: boolean; suspended: boolean; left: boolean }
filter.equivalentCode: string | 'ANY'
filter.netBalanceRange: [number, number]
filter.activityRange: [number, number]
```

### 12.4. Main Canvas

**Компонент: `GraphView`**

Обёртка над библиотекой (например, `react-force-graph`):

```ts
type PID = string;

interface ParticipantNode {
  id: PID;
  name: string;
  type: 'person' | 'organization' | 'hub';
  status: 'active' | 'suspended' | 'left';
  netBalance: number;
  activityScore: number;
  clusterId?: string;
}

interface LinkEdge {
  id: string;
  from: PID;
  to: PID;
  kind: 'trustline' | 'debt';
  equivalent: string;
  limit?: number;     // для trustline
  amount?: number;    // для debt
  utilization?: number;
}
```

**Props:**

- `nodes: ParticipantNode[]`
- `links: LinkEdge[]`
- `viewMode: 'trustlines' | 'debts' | 'combined'`
- `highlightedNodeId?: PID`
- `highlightedLinkId?: string`
- `onNodeClick(nodeId: PID)`
- `onLinkClick(linkId: string)`
- `onBackgroundClick()`

**Визуальные состояния узлов:**

| Тип | Форма |
|-----|-------|
| `person` | круг |
| `organization` | квадрат |
| `hub` | шестиугольник |

| Статус | Цвет |
|--------|------|
| `active` | зелёный |
| `suspended` | жёлтый |
| `left` | серый |

### 12.5. Right Sidebar

**Компонент: `RightSidebar`**

Подкомпоненты:

- `NodeDetailsPanel` — если выбран участник
- `LinkDetailsPanel` — если выбрана связь
- `EmptySelectionPanel` — если ничего не выбрано

**`NodeDetailsPanel` — структура:**

1. Карточка профиля (имя, тип, статус)
2. Краткие метрики (net‑баланс, количество trustlines)
3. Список связей (вкладки: TrustLines / Debts)
4. Действия (Create TrustLine, Initiate Payment, View History)

**`LinkDetailsPanel` — структура:**

1. Заголовок (`A → B`, тип)
2. Основные поля (limit/amount, policy)
3. График изменения (sparkline)
4. Действия (Edit Limit, Edit Policy, Close TrustLine)

### 12.6. Состояния экрана в целом

| Состояние | Поведение |
|-----------|-----------|
| Empty/No‑Data | GraphView показывает пустое состояние с подсказкой |
| Loading | Skeleton‑элементы или лоадер в центре |
| Error | Баннер в верхней части экрана, SimulationStatusIndicator в состоянии `error` |

---

## Рекомендации по улучшению приложения

> Ниже — дополнительные улучшения, которые можно реализовать после MVP. Базовые упрощения (один эквивалент, JSON-конфигурация, упрощённый UI и т.д.) уже внедрены в соответствующие разделы документа.

### Приоритеты реализации

| Фаза | Функционал | Сложность |
|------|------------|-----------|
| 1 | Граф участников (просмотр) + базовые фильтры | Низкая |
| 2 | Детали узла/ребра в правой панели | Низкая |
| 3 | Запуск симуляции (random market) | Средняя |
| 4 | Метрики в реальном времени | Средняя |
| 5 | Дополнительные сценарии и профили | Высокая |

### Архитектурные улучшения (после MVP)

1. **Отделить генератор сценариев от визуализации** — симулятор может быть CLI-утилитой на Python, которая генерирует трафик. Визуализатор — отдельное веб-приложение, которое читает состояние через API.

2. **WebSocket для real-time обновлений** — вместо polling использовать WebSocket для мгновенного обновления графа при изменениях.

3. **Кэширование состояния графа** — хранить последнее состояние сети в Redis/памяти для быстрого ответа на запросы визуализатора.

### UX-улучшения (после MVP)

1. **Подсказки при первом запуске** — короткий onboarding (3–4 шага) объясняющий что такое trustline, долг, клиринг.

2. **Режим «фокус на участнике»** — при выборе узла автоматически скрывать несвязанные с ним узлы (режим ego-graph).

3. **Анимация платежей** — при выполнении платежа показывать анимацию «потока» по маршруту.

4. **Сравнение снапшотов** — возможность сравнить состояние сети в два момента времени (diff-view).

---

## Заключение

Данный документ описывает полнофункциональный симулятор-визуализатор для сети GEO. Для MVP рекомендуется начать с базового графа и постепенно добавлять функционал по мере необходимости.

**Минимальный жизнеспособный продукт:**

1. Веб-страница с графом участников
2. Правая панель с деталями
3. Кнопка «запустить симуляцию» (random market)
4. 3–4 ключевых метрики

Это можно реализовать за 2–3 недели с использованием React + react-force-graph + MUI.
