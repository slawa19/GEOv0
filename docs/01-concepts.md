# GEO Protocol: Ключевые концепции

**Версия:** 0.1  
**Дата:** Ноябрь 2025

---

## Содержание

1. [Участник (Participant)](#1-участник-participant)
2. [Эквивалент (Equivalent)](#2-эквивалент-equivalent)
3. [Линия доверия (TrustLine)](#3-линия-доверия-trustline)
4. [Долг (Debt)](#4-долг-debt)
5. [Платёж (Payment)](#5-платёж-payment)
6. [Клиринг (Clearing)](#6-клиринг-clearing)
7. [Транзакция (Transaction)](#7-транзакция-transaction)
8. [Hub и координация](#8-hub-и-координация)

---

## 1. Участник (Participant)

**Участник** — это любая сущность, которая может участвовать в экономике GEO:
- Физическое лицо
- Организация или бизнес
- Hub (узел сообщества — тоже участник на уровне федерации)

### Идентичность

Каждый участник идентифицируется криптографически:

```
PID = base58(sha256(public_key))
```

- **public_key** — публичный ключ Ed25519 (32 байта)
- **PID** — производный идентификатор участника

### Свойства участника

| Поле | Описание |
|------|----------|
| `pid` | Уникальный идентификатор (производный от pubkey) |
| `public_key` | Публичный ключ Ed25519 |
| `display_name` | Человекочитаемое имя |
| `profile` | Метаданные (тип, контакты, описание) |
| `status` | `active`, `suspended`, `left`, `deleted` |
| `verification_level` | Уровень верификации (зависит от сообщества) |

### Принцип владения

- Приватный ключ **никогда не передаётся** на сервер
- Все критические операции **подписываются** владельцем ключа
- Hub хранит только публичные ключи и проверяет подписи

---

## 2. Эквивалент (Equivalent)

**Эквивалент** — это единица счёта, в которой измеряются обязательства.

### Примеры эквивалентов

| Код | Описание | Precision |
|-----|----------|-----------|
| `UAH` | Украинская гривна | 2 |
| `USD` | Доллар США | 2 |
| `HOUR` | Час работы | 2 |
| `HOUR_DEV` | Час работы разработчика | 2 |
| `kWh` | Киловатт-час | 3 |
| `LOCAL` | Внутренняя единица сообщества | 2 |

### Свойства эквивалента

| Поле | Описание |
|------|----------|
| `code` | Уникальный строковый код |
| `precision` | Количество знаков после запятой |
| `description` | Человекочитаемое описание |
| `metadata` | Дополнительные данные (тип, привязка) |

### Важно

- В системе **нет валюты по умолчанию**
- Все операции явно указывают эквивалент
- GEO **не конвертирует** между эквивалентами автоматически
- Один участник может иметь линии доверия в разных эквивалентах

---

## 3. Линия доверия (TrustLine)

**Линия доверия** — это декларация одного участника о готовности принять риск на другого.

### Семантика

```
TrustLine: A → B (limit=1000, equivalent=UAH)
```

Означает: **«A разрешает B быть должным ему до 1000 UAH»**

### Ключевые свойства

| Свойство | Описание |
|----------|----------|
| **Направленность** | A→B ≠ B→A (это разные линии) |
| **Односторонность** | Создаётся владельцем (A) без согласия B |
| **Ограниченность** | Задаёт максимальный долг B перед A |
| **Специфичность** | Привязана к конкретному эквиваленту |

### Структура TrustLine

| Поле | Описание |
|------|----------|
| `from` | PID того, кто даёт доверие (кредитор) |
| `to` | PID того, кому доверяют (потенциальный должник) |
| `equivalent` | Эквивалент |
| `limit` | Максимальная сумма долга |
| `policy` | Политики (авто-клиринг, ограничения маршрутов) |
| `status` | `active`, `frozen`, `closed` |

### Базовый инвариант

```
debt[B→A, E] ≤ limit(A→B, E)
```

Долг B перед A не может превышать установленный лимит.

### Пример

```
Алиса создаёт TrustLine: Алиса → Боб (limit=500, UAH)

Это означает:
- Боб может быть должен Алисе до 500 UAH
- Алиса несёт риск невозврата
- Боб может использовать это доверие для покупок
```

---

## 4. Долг (Debt)

**Долг** — это фактическое обязательство одного участника перед другим.

### Семантика

```
Debt: X → Y (amount=300, equivalent=UAH)
```

Означает: **«X должен Y 300 UAH»**

### Структура Debt

| Поле | Описание |
|------|----------|
| `debtor` | PID должника |
| `creditor` | PID кредитора |
| `equivalent` | Эквивалент |
| `amount` | Текущая сумма долга (> 0) |

### Связь с TrustLine

- TrustLine задаёт **потолок** возможного долга
- Debt — это **фактическое состояние**
- Один TrustLine может «обслуживать» множество транзакций

### Агрегация

- Для каждой тройки `(debtor, creditor, equivalent)` хранится **одна агрегированная запись**
- Протокол не хранит историю каждой сделки — только итоговый долг
- История фиксируется в транзакциях

---

## 5. Платёж (Payment)

**Платёж** — это перемещение «стоимости» от плательщика к получателю через сеть доверия.

### Как работает платёж

```
A хочет заплатить C 100 UAH
Прямой TrustLine A→C отсутствует

Но есть цепочка:
A → B (limit=200) → C (limit=150)

Платёж идёт по цепочке:
1. A становится должен B +100
2. B становится должен C +100
3. C получил "оплату" от A
```

### Доступный кредит (Available Credit)

Для каждого направленного ребра:

```
available_credit(A→B, E) = limit(A→B, E) - debt[B→A, E]
```

Это максимум, который можно «провести» по данному ребру.

### Маршрутизация

1. **Поиск путей**: BFS с ограничением глубины (до 6 звеньев)
2. **Расчёт ёмкости**: min(available_credit) по всем рёбрам пути
3. **Multi-path**: разбиение платежа на 2–3 маршрута при необходимости

### Пример multi-path

```
A → C на 100 UAH

Найдены пути:
- A → X → C (ёмкость 60)
- A → Y → Z → C (ёмкость 50)

Платёж разбивается:
- 60 через путь 1
- 40 через путь 2
```

---

## 6. Клиринг (Clearing)

**Клиринг** — это автоматический взаимозачёт долгов в замкнутом цикле.

### Пример цикла

```
A должен B: 100
B должен C: 100
C должен A: 100

Это замкнутый цикл. Экономически — никто никому не должен.

Клиринг уменьшает все долги на min(100, 100, 100) = 100:
A должен B: 0
B должен C: 0
C должен A: 0
```

### Как это работает

1. **Поиск циклов**: Алгоритм находит замкнутые цепочки долгов
2. **Расчёт суммы**: S = min(долг по каждому ребру цикла)
3. **Применение**: Уменьшение всех долгов на S

### Длина циклов

| Длина | Частота поиска | Сложность |
|-------|----------------|-----------|
| 3 узла | После каждой транзакции | Низкая |
| 4 узла | После каждой транзакции | Низкая |
| 5 узлов | Периодически (раз в час) | Средняя |
| 6 узлов | Периодически (раз в сутки) | Высокая |

### Зачем нужен клиринг

- **Освобождает лимиты**: После клиринга TrustLines снова доступны
- **Уменьшает риски**: Меньше «висящих» долгов в системе
- **Повышает ликвидность**: Больше возможных маршрутов для платежей

---

## 7. Транзакция (Transaction)

**Транзакция** — это атомарная единица изменений в системе.

### Типы транзакций

| Тип | Описание |
|-----|----------|
| `TRUST_LINE_CREATE` | Создание линии доверия |
| `TRUST_LINE_UPDATE` | Изменение лимита или политики |
| `TRUST_LINE_CLOSE` | Закрытие линии |
| `PAYMENT` | Платёж через сеть |
| `CLEARING` | Взаимозачёт по циклу |

### Структура транзакции

| Поле | Описание |
|------|----------|
| `tx_id` | Уникальный идентификатор (UUID или hash) |
| `type` | Тип транзакции |
| `initiator` | PID инициатора |
| `payload` | Типизированные данные операции |
| `signatures` | Подписи участников |
| `state` | Текущее состояние |
| `created_at` | Время создания |

### Состояния PAYMENT

```
NEW → ROUTED → PREPARE_IN_PROGRESS → COMMITTED
                                   ↘ ABORTED
```

### Состояния CLEARING

```
NEW → PROPOSED → WAITING_CONFIRMATIONS → COMMITTED
                                       ↘ REJECTED
```

### Идемпотентность

- Повторный `COMMIT` по уже завершённой транзакции — безопасен
- `tx_id` гарантирует отсутствие дубликатов

---

## 8. Hub и координация

### Роль Hub'а

Hub выполняет функции **координатора**, но не является банком:

| Функция | Описание |
|---------|----------|
| **Хранение** | Состояние участников, TrustLines, долгов |
| **Координация** | Фазы PREPARE/COMMIT транзакций |
| **Маршрутизация** | Поиск путей для платежей |
| **Клиринг** | Поиск и исполнение циклов |
| **API** | Доступ для клиентов |

### Чего Hub НЕ делает

- Не хранит приватные ключи участников
- Не совершает операции без подписи владельца
- Не «владеет» средствами участников
- Не принимает односторонних решений о балансах

### Координация транзакций (2PC)

**Двухфазный коммит** гарантирует атомарность:

```
Фаза 1: PREPARE
- Hub отправляет всем участникам запрос на резервирование
- Каждый проверяет условия и резервирует ресурсы
- Все отвечают OK или FAIL

Фаза 2: COMMIT или ABORT
- Если все OK → COMMIT (применение изменений)
- Если кто-то FAIL → ABORT (освобождение резервов)
```

### Администрирование Hub'а

Hub управляется **оператором сообщества** (кооператив, НКО, и т.п.):

| Роль | Права |
|------|-------|
| `admin` | Управление конфигурацией, ролями, аддонами |
| `operator` | Мониторинг, помощь пользователям, разбор споров |
| `auditor` | Только чтение логов и отчётов |

### Федерация Hub'ов

Hub'ы разных сообществ могут объединяться:

```
┌───────────────┐         ┌───────────────┐
│  Community A  │         │  Community B  │
│  ┌─────────┐  │ Trust-  │  ┌─────────┐  │
│  │ Hub A   │◄─┼─Line────┼─►│ Hub B   │  │
│  └────┬────┘  │         │  └────┬────┘  │
│  [users A]    │         │  [users B]    │
└───────────────┘         └───────────────┘

Hub A и Hub B — обычные участники протокола
Между ними открыты TrustLines
Платежи между сообществами маршрутизируются через Hub'ы
```

---

## Глоссарий

| Термин | Определение |
|--------|-------------|
| **PID** | Participant ID — идентификатор участника |
| **TrustLine** | Линия доверия — кредитный лимит от A к B |
| **Debt** | Долг — фактическое обязательство |
| **Equivalent** | Эквивалент — единица счёта |
| **Available Credit** | Доступный кредит — остаток лимита минус долг |
| **Clearing** | Клиринг — взаимозачёт долгов по циклу |
| **2PC** | Two-Phase Commit — двухфазный коммит |
| **Hub** | Узел сообщества — координатор и хранилище |

---

## Связанные документы

- [00-overview.md](00-overview.md) — Обзор проекта
- [02-protocol-spec.md](02-protocol-spec.md) — Полная спецификация протокола
- [03-architecture.md](03-architecture.md) — Архитектура системы
